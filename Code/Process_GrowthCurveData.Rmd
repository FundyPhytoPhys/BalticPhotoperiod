---
title: "Process_GrowthCurveData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_GrowthCurveData.Rmd separately processes and combines all .Rds from Data/ImportedData/ImportedMCData folder. This .Rmd generates BalticPhotoperiod_Processed_GrowthCurve.Rds (stored in Data/ProcessedData/ProcessedGrowthCurveData folder) and GrowthCurve_SupPlot.png (stored in Output/Plots folder).

# Load Libraries and set Project Variables

```{r load libraries} 
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(ggpubr)
library(data.table)
library(googledrive)
library(googlesheets4)
```

```{r set project variables}
Project <- "BalticPhotoperiod"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedGrowthCurveData")
DataIn <- file.path("..", "Data", "ImportedData", "ImportedMCData", fsep = .Platform$file.sep)

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read imported MC files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, full.names = TRUE)
```

# Import selected Rds and calculate mean OD from every hour based on ToD and time

## Import Run39

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20211214_PICO_MC247_RUN39_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData39 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run40

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20211223_PICO_MC257_RUN40_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData40 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run43

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20211229_PICO_MC247_RUN43_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData43 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run44

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220107_PICO_MC257_RUN44_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData44 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run45

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220113_PICO_MC247_RUN45_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData45 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run46

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220122_PICO_MC257_RUN46_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData46 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```


## Import Run50

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220206_PICO_MC257_RUN50_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData50 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run60

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220405_PICO_MC247_RUN60_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData60 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run62

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220410_PICO_MC257_RUN62_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData62 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run65

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220420_PICO_MC257_RUN65_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData65 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run71

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220507_PICO_MC257_RUN71_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData71 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run74

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220607_PICO_MC257_RUN74_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData74 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run77

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20220615_PICO_MC257_RUN77_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData77 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

## Import Run121

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}
MultiCultiFile <- "../Data/ImportedData/ImportedMCData/20230816_PICO_MC257_RUN121_TargetDataMetaFilter.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  

MultiCultiData$ToD = sub("\\..*", "", MultiCultiData$ToD)
MultiCultiData$time = sub("\\..*", "", MultiCultiData$time)

MultiCultiData <- MultiCultiData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) %>% 
  mutate(DeltaOD = OD680-OD720) 
  
MultiCultiData121 <- MultiCultiData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(Run, SampleID, Strain, ExpDate, Filename, Tube, time_h, ToD, Day, ExpDate, Actinic_par, OD680, OD720, DeltaOD, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(DeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, DeltaOD)) %>% 
  unique()
```

# Merge selected Runs

```{r Mere selected Runs}
MultiCultiDataAll<-rbind(MultiCultiData39, MultiCultiData40, MultiCultiData43, MultiCultiData44, MultiCultiData45, MultiCultiData46, MultiCultiData50, MultiCultiData60, MultiCultiData62, MultiCultiData65, MultiCultiData71, MultiCultiData74, MultiCultiData77, MultiCultiData121)

rm(MultiCultiData39, MultiCultiData40, MultiCultiData43, MultiCultiData44, MultiCultiData45, MultiCultiData46, MultiCultiData50, MultiCultiData60, MultiCultiData62, MultiCultiData65, MultiCultiData71, MultiCultiData74, MultiCultiData77, MultiCultiData121)
```

# Rename column names for consistency

```{r}
MultiCultiDataAll<-MultiCultiDataAll %>% 
  rename(E_days=Day) %>% 
  rename(FilenameMC=Filename) %>% 
  rename(Time_h=time_h)
```

# Add facets labels and change strain name to create plot

```{r add facets labels and change strain names}
MultiCultiDataAll$facetsPar_ue = factor(MultiCultiDataAll$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
MultiCultiDataAll$facetsPhotoperiod = factor(MultiCultiDataAll$WL, labels = c("Photoperiod~(h)"))

MultiCultiDataAll <- MultiCultiDataAll %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 
```

# Load tmaxAG catalog and create 4 df for vertical lines (coloured as Strain) contained tMaxAG values

```{r}
gs4_deauth()
tmaxAG<- read_sheet("https://docs.google.com/spreadsheets/d/1ksY7xlg9wOsICOBRmZkHPKdd9KOislNwPDzyuJ3UIUI/edit#gid=0")
as.data.frame(tmaxAG)
tmaxAG <- tmaxAG

tmaxAG<-tmaxAG %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAG = as.numeric(tMaxAG)) %>%
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

tmaxAG$facetsPar_ue = factor(tmaxAG$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
tmaxAG$facetsPhotoperiod = factor(tmaxAG$WL, labels = c("Photoperiod~(h)"))
tmaxAG$facetsStrain = factor(tmaxAG$O2, labels = c("Strain"))
```

```{r select revelant columns}
tMaxAGLines_056<-tmaxAG %>% 
  filter(Strain == "PC-rich_056") %>% 
  select(c(Par_ue, Photoperiod, facetsPar_ue, facetsPhotoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_077<-tmaxAG %>% 
  filter(Strain == "PC-rich_077") %>% 
  select(c(Par_ue, Photoperiod, facetsPar_ue, facetsPhotoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_048<-tmaxAG %>% 
  filter(Strain == "PE-rich_048") %>% 
  select(c(Par_ue, Photoperiod, facetsPar_ue, facetsPhotoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_127<-tmaxAG %>% 
  filter(Strain == "PE-rich_127") %>% 
  select(c(Par_ue, Photoperiod, facetsPar_ue, facetsPhotoperiod, tMaxAG)) %>% 
  unique()
```


# Create GrowthCurve plot

```{r create GrowthCurve plot, fig.height = 8, fig.width = 8, warning = FALSE}
MultiCultiDataAll %>%
  #filter(Par_ue != 600) %>% 
  filter(Run != 77) %>% 
  ggplot() +
  geom_area(aes(x = Time_h, y = meanActinic_par_h), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = Time_h, y = meanOD680_h, colour = as.factor(Strain)), size = 0.5, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4", size=0.4) +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3", size=0.4) +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4", size=0.4) +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1", size=0.4) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  scale_y_continuous(breaks=seq(0, 1, by = 0.25)) +
  coord_cartesian(ylim = c(0, 1.0)) +
  labs(y = "Optical density ("~OD[680]~")", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_GrowthCurve_OD680",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```

# Create GrowthCurve plot

```{r create GrowthCurve plot, fig.height = 8, fig.width = 8, warning = FALSE}
MultiCultiDataAll %>%
  #filter(Par_ue != 600) %>% 
  filter(Run != 77) %>% 
  ggplot() +
  geom_area(aes(x = Time_h, y = meanActinic_par_h), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = Time_h, y = meanOD720_h, colour = as.factor(Strain)), size = 0.5, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4", size=0.4) +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3", size=0.4) +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4", size=0.4) +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1", size=0.4) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  scale_y_continuous(breaks=seq(0, 1, by = 0.25)) +
  coord_cartesian(ylim = c(0, 1.0)) +
  labs(y = "Optical density ("~OD[720]~")", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_GrowthCurve_OD720",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```

# Create GrowthCurve plot

```{r create GrowthCurve plot, fig.height = 8, fig.width = 8, warning = FALSE}
MultiCultiDataAll %>%
  #filter(Par_ue != 600) %>% 
  filter(Run != 77) %>% 
  ggplot() +
  geom_area(aes(x = Time_h, y = meanActinic_par_h), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = Time_h, y = meanDeltaOD_h, colour = as.factor(Strain)), size = 0.5, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4", size=0.4) +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3", size=0.4) +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4", size=0.4) +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1", size=0.4) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  scale_y_continuous(breaks=seq(0, 1, by = 0.25)) +
  coord_cartesian(ylim = c(0, 1.0)) +
  labs(y = "Optical density (\u0394 OD)", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_GrowthCurve_DeltaOD",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```


# Create preliminary plot - loop

```{r create preliminary plot, warning = FALSE}
MultiCultiDataAll %>%
  ggplot() +
  geom_line(aes(x = meanOD720_h, y = meanDeltaOD_h, colour = as.factor(Strain)), size = 0.7, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() 
```

# Save Fig Rds

```{r}
# saveRDS(MultiCultiDataAll, file.path(FigRdsPath, paste(Project, "Fig_GrowthCurve_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Save Rds for further analysis

```{r save rds}
saveRDS(MultiCultiDataAll, file.path(DataOut, paste(Project, "Processed_GrowthCurve.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Variable names used in Data Dictionary

```{r}
colnames(MultiCultiDataAll)
```


-------------------------------------------------# Logistic fits --------------------------------------------------------


```{r set project variables}
Project <- "BalticPhotoperiod"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedGrowthRateData")
DataIn <- file.path("..", "Data", "CleanedData", "CleanedMCData", fsep = .Platform$file.sep)

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, full.names = TRUE)
```

```{r read file}
MultiCultiGrowthFile <- "../Data/CleanedData/CleanedMCData/PICO_Cleaned_MCData.Rds"

MultiCultiGrowthFileName <- str_split(string = MultiCultiGrowthFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiGrowth <- readRDS(MultiCultiGrowthFile)  %>%
  ungroup()
```

# Select revelant variables and preparing for further analysis

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  dplyr::select(c(Tube, ExpDate, MC, Run, SampleID, Strain, Par_ue, Photoperiod, WL, O2, LightShape, PARPhotonDose_day, OD720_Lmu_se, OD720_Lmu_corr, deltaOD_Lmu_se, deltaOD_Lmu_corr, tubedata, OD720_logistic_predict, deltaOD_logistic_predict, OD720trunc_logistic_predict, deltaODtrunc_logistic_predict))
  
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

MultiCultiGrowth1<-MultiCultiGrowth %>% 
  filter(Run==77) %>% 
  filter(Strain =="PC-rich_077")
MultiCultiGrowth2<-MultiCultiGrowth %>% 
  filter(Run==121) %>% 
  filter(Strain !="PC-rich_077")
MultiCultiGrowth3<-MultiCultiGrowth %>% 
  filter(Run!=121 & Run!= 77) 
MCGrowthRate<-rbind(MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
  rm(MultiCultiGrowth, MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
```

```{r unnest, preparing df to preparing final plot, echo=FALSE, warning = FALSE}
augmentedMCGrowthRateFitOD720<-MCGrowthRate  %>%
  unnest(OD720_logistic_predict) %>%
  select(c(OD720, time, .fitted)) 

augmentedMCGrowthRateFitOD720Trunc<-MCGrowthRate  %>%
  unnest(OD720trunc_logistic_predict) %>%
  select(c(OD720, time, .fitted)) 

augmentedMCGrowthRateFitDeltaOD<-MCGrowthRate  %>%
  unnest(deltaOD_logistic_predict) %>%
  select(c(deltaOD, time, .fitted)) 

augmentedMCGrowthRateFitDeltaODTrunc<-MCGrowthRate  %>%
  unnest(deltaODtrunc_logistic_predict) %>%
  select(c(deltaOD, time, .fitted)) 


augmentedMCGrowthRateTubedata<-MCGrowthRate  %>%
  unnest(tubedata)
augmentedMCGrowthRateTubedata<-augmentedMCGrowthRateTubedata %>% 
  select(-c(OD720_logistic_predict, deltaOD_logistic_predict, OD720trunc_logistic_predict, deltaODtrunc_logistic_predict))

```

# Merge tubedata and fit prediction - OD720
```{r warning = FALSE}
MCGrowthRateFitOD720 <- augmentedMCGrowthRateFitOD720 %>%
  left_join(., augmentedMCGrowthRateTubedata, by = c("OD720" = "OD720", "time" = "time"))
MCGrowthRateFitOD720<-MCGrowthRateFitOD720 %>% 
  rename(fittedOD720 = .fitted) 
  
MCGrowthRateFitOD720PTrunc <- augmentedMCGrowthRateFitOD720Trunc %>%
  left_join(., MCGrowthRateFitOD720, by = c("OD720" = "OD720", "time" = "time"))
MCGrowthRateFitOD720PTrunc<-MCGrowthRateFitOD720PTrunc %>% 
  rename(fittedOD720Trunc = .fitted) 

MCGrowthRateFitDeltaOD <- augmentedMCGrowthRateFitDeltaOD %>%
  left_join(., MCGrowthRateFitOD720PTrunc, by = c("deltaOD" = "deltaOD", "time" = "time"))
MCGrowthRateFitDeltaOD<-MCGrowthRateFitDeltaOD %>% 
  rename(fittedDeltaOD = .fitted) 

MCGrowthRateFitDeltaODTrunc <- augmentedMCGrowthRateFitDeltaODTrunc %>%
  left_join(., MCGrowthRateFitDeltaOD, by = c("deltaOD" = "deltaOD", "time" = "time"))
MCGrowthRateFitDeltaODTrunc<-MCGrowthRateFitDeltaODTrunc %>% 
  rename(fittedDeltaODTrunc = .fitted) 

MCGrowthRateFitData<-MCGrowthRateFitDeltaODTrunc

rm(MCGrowthRateFitOD720, MCGrowthRateFitOD720PTrunc, MCGrowthRateFitDeltaOD, MCGrowthRateFitDeltaODTrunc, augmentedMCGrowthRateFitOD720, augmentedMCGrowthRateFitOD720Trunc, augmentedMCGrowthRateFitDeltaOD, augmentedMCGrowthRateFitDeltaODTrunc, augmentedMCGrowthRateTubedata)

```

```{r Import Run and calculate mean OD, echo = FALSE, warning = FALSE}

MCGrowthRateFitData$ToD = sub("\\..*", "", MCGrowthRateFitData$ToD)
MCGrowthRateFitData$time = sub("\\..*", "", MCGrowthRateFitData$time)

MCGrowthRateFitData <- MCGrowthRateFitData %>% 
  mutate(ToD=as.numeric(ToD)) %>% 
  mutate(time=as.numeric(time)) %>% 
  mutate(Actinic_par = Actinic_par/1000) %>% 
  rename(time_h=time) 
  

colnames(MCGrowthRateFitData)

MCGrowthRateFitData <- MCGrowthRateFitData %>%   
  group_by(SampleID, Day, ToD, time_h) %>% 
  summarize(deltaOD, time_h, fittedDeltaOD, OD720, fittedOD720, Tube, ExpDate, MC, Run, SampleID, Strain, Par_ue, Photoperiod, WL, O2, LightShape, PARPhotonDose_day, OD720_Lmu_se, OD720_Lmu_corr, deltaOD_Lmu_se, deltaOD_Lmu_corr, ToD, Day, Actinic_par, OD680, meanActinic_par_h = mean(Actinic_par), meanOD680_h = mean(OD680), meanOD720_h = mean(OD720), meanDeltaOD_h = mean(deltaOD), 
            meanfittedOD720_h = mean(fittedOD720), meanfittedDeltaOD_h = mean(fittedDeltaOD)) %>%
  ungroup() %>% 
  select(-c(Actinic_par, OD680, OD720, deltaOD, fittedOD720, fittedDeltaOD)) %>% 
  unique()
```


# Adding facet labels

```{r}
MCGrowthRateFitData$facetsPar_ue = factor(MCGrowthRateFitData$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
MCGrowthRateFitData$facetsPhotoperiod = factor(MCGrowthRateFitData$WL, labels = c("Photoperiod~(h)"))
MCGrowthRateFitData$facetsStrain = factor(MCGrowthRateFitData$WL, labels = c("Strain"))
```


# Create GrowthCurve plot with fits

```{r create GrowthCurve plot, fig.height = 8, fig.width = 8, warning = FALSE}
MCGrowthRateFitData %>%
  filter(Run != 77) %>% 
  ggplot() +
  #geom_area(aes(x = time_h, y = meanActinic_par_h), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = time_h, y = meanDeltaOD_h, colour = as.factor(Strain)), size = 0.3, alpha = 0.4, show.legend = F) +
  geom_line(aes(x = time_h, y = meanfittedDeltaOD_h, colour = as.factor(Strain)), size = 0.7, alpha = 0.9, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  # scale_y_continuous(breaks=seq(0, 1, by = 0.25)) +
  # coord_cartesian(ylim = c(0, 1.0)) +
  labs(y = "Optical density (\u0394 OD)", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_GrowthCurve_FitStrain",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```


```{r create GrowthCurve plot, fig.height = 8, fig.width = 8, warning = FALSE}
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))
MCGrowthRateFitData %>%
  filter(Run != 77) %>% 
  ggplot() +
  geom_line(aes(x = time_h, y = meanDeltaOD_h, colour = as.factor(Par_ue)), size = 0.4, alpha = 0.4, show.legend = F) +
  geom_line(aes(x = time_h, y = meanfittedDeltaOD_h, colour = as.factor(Par_ue)), size = 0.7, alpha = 0.9, show.legend = T) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3",  "goldenrod2", "khaki2"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 1, by = 0.25)) +
  # coord_cartesian(ylim = c(0, 1.0)) +
  labs(y = "Optical density (\u0394 OD)", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.07,0.94),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_GrowthCurve_FitLight",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```


# Cleaning df before saving as rds and removed unnecessary files from the environment

```{r cleanifng d}
rm(tMaxAGLines_056, tMaxAGLines_077, tMaxAGLines_048, tMaxAGLines_127, tmaxAG, MultiCultiData, MCGrowthRate)
```








