---
title: "Process_SolisenseLRCData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_SolisenseDataLRC.Rmd process BalticPhotoperiod_Imported_SolisenseLight_LRC.Rds from BalticPhotoperiod/Data/ImportedData/ImportedSolisenseData folder and stored in Data/ProcessedData/ProcessedSolisenseData folder as: BalticPhotoperiod_Processed_SolisenseJVPSII.Rds.

# Load Libraries

```{r load libraries, warning = FALSE, echo=FALSE} 
library(ggtext)
library(tidyverse)
library(broom)
library(OneR)
library(zoo)
library(ggpubr)
library(googledrive)
library(googlesheets4)
library(readxl)
library(Cairo) #for greek symbols
library(data.table)
library(minpack.lm) #Standard 'nls' framework that uses 'nls.lm' for fitting
library("patchwork") # merging plots
```

# Set Project Variables 

```{r set project variables, read zipped files, list available files, warning = FALSE, echo=FALSE}
Project <- "BalticPhotoperiod"
DataOut <- file.path("..", "Data", "ImportedData", "ImportedSolisenseData")
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedSolisenseData")

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")
# FileID <- "fit"
# FileEncode <- "UTF-8"
# Delimiter <- ","
# HeaderRows <- 0
```

# Read MetaData

```{r read locally stored metadata from rds}
CultureCatalog <- readRDS(file = file.path("..", "Data", "ImportedData", "ImportedMetaData", "CultureCatalog.Rds"))

CultureCatalog<-CultureCatalog %>% 
  select(-c(PrimaryOperator, Temp_c, ExpCul, ExpStartTime, O2_Category, Optode, OptodeCh, OptodeMeasure))
```

# Read Imported Solisense

```{r read locally stored metadata from rds}
SolFitsMeta <- readRDS(file = file.path("..", "Data", "ImportedData", "ImportedSolisenseData", "BalticPhotoperiod_Imported_SolisenseLight_LRC.Rds"))

SolFitsMeta <- SolFitsMeta |>
  select(-c(nm445,nm470,nm505,nm535,nm590,IR, nm445Corr,nm470Corr, nm505Corr,nm535Corr,nm590Corr,IRCorr,JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig)) |>
  rename(JVPSII_ETRqpOxbo_FoSigmax_m2psii = JVPSII_ETRqpOxbo_FoSig) |>
  rename(FilenameSolisense=Filename)
```

# Create preliminary plots 

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsMeta %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = Sig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  facet_grid(rows = vars(Ex_WL), cols = vars(Photoperiod)) +
  theme_bw()


SolFitsMeta %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = JVPSII_ETRqpOxbo_FoSigmax_m2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  facet_grid(rows = vars(Ex_WL), cols = vars(Photoperiod)) +
  theme_bw()
```


To get the Platt fits to work I plotted:
JVPSII_umole_eLs vs. ActPAR

so I had to convert JVPSII_eLs by dividing by 6.022E-17.
If you want to go back to JVPSII_eLs just multiple back up.

# Calibrate JVPSII to e L-1 s-1

```{r JVPSII calib}
JVPSII_eLs_ModelTerms <- read_rds(file.path("..","Data", "CleanedData", "JVPSIIO2Calib", "JVPSII_eLs_ModelTerms.Rds"))

#smarter way to code this with 'which' in [] and map through Ex_WL
SolFitsMeta <- left_join(SolFitsMeta, JVPSII_eLs_ModelTerms, by = join_by(Ex_WL)) |>
  select(-c(Slope_P)) |>
  mutate(JVPSII_eLs = JVPSII_ETRqpOxbo_FoSigmax_m2psii/Slope) |>
  mutate(JVPSII_umol_eLs = JVPSII_eLs/6.022e17)

```



# Create preliminary plots 

```{r preliminary plot}
# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsMeta %>%
  ggplot() +
  geom_point(aes(x = ActPARCorr, y = JVPSII_umol_eLs, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  facet_grid(cols = vars(Ex_WL, Photoperiod), rows = vars(Par_ue)) +
  theme_bw()

```


# Fit LRC for JVPSII to allow selection of specific JVPSII for different growth light levels.

```{r}
lrcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}


SolFitsMetaLRC <- SolFitsMeta %>%
  nest(data = -c("SampleID", "Run", "Strain" ,"ExpDate","Par_ue", "Photoperiod", "O2", "WL", "MC", "Tube","Ex_WL","LightShape", "ExpEndDate", "PARPhotonDose_day", "ObsDate", "E_days")) %>% #head(50) %>% 
  mutate(lrcplatt_Model = map(data, possibly(~nlsLM(JVPSII_umol_eLs ~ lrcplatt(I = ActPARCorr, a, b, Pmax),
         data = .x,
         control = list(maxiter = 100),
         start = list(a = 0.1, b = 0.01, Pmax = 3), lower = c(0, 0, 0))))) %>%
  mutate(lrcplatt_Param = map(lrcplatt_Model, tidy),
         lrcplatt_Predict = map(lrcplatt_Model, possibly(augment)),
         lrcplatt_Glance = map(lrcplatt_Model, possibly(glance)))

```

# Create preliminary plot - Example

```{r prelim plot}
SolFitsMetaLRC |> 
  unnest(lrcplatt_Predict) |>
  filter(Strain == "BA48R") %>% 
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) |>
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_line(aes(ActPARCorr, .fitted), colour = "black", linetype = "dotted") +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain, Par_ue, Photoperiod, E_days), labeller = label_parsed) +
  theme_bw()

```

Use Peak Par_ue and 1/2 Peak Par_ue to estimate growth JVPSII for each combination
-use 'Pluck' to reach into lrcplatt_Predict to get a, b, Pmax; or
-unnest, pivot wider to get a, b, Pmax

```{r growth light JVPSII}

SolFitsMetaLRCGrowth <- SolFitsMetaLRC |>
  unnest(lrcplatt_Param) |>
  select(-c(statistic, p.value, lrcplatt_Predict, lrcplatt_Glance)) |> #remove (temporarily) to make pivot_wider easier
  pivot_wider(names_from = term, values_from = c(estimate, std.error)) |>
  mutate(JVPSII_umol_eLs_Par_ue = lrcplatt(I = Par_ue, a = estimate_a, estimate_b, estimate_Pmax),
         JVPSII_umol_eLs_HalfPar_ue = lrcplatt(I = (0.5*Par_ue), a = estimate_a, estimate_b, estimate_Pmax))

 
head(SolFitsMetaLRCGrowth) 
```

# Test plots of Growth Par_ue and 1/2 Growth Par_ue estimates for JVPSII
```{r growth JVPSII}
SolFitsMetaLRCGrowth |>
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = Ex_WL)) +
  facet_grid(cols = vars(Ex_WL, Photoperiod, Strain), rows = vars(Par_ue)) +
  theme_bw()

SolFitsMetaLRCGrowth |>
  filter(Strain == "BA48R") |>
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = Ex_WL)) +
  facet_grid(cols = vars(Ex_WL, Photoperiod, Strain), rows = vars(Par_ue)) +
  theme_bw()

SolFitsMetaLRCGrowth |>
  filter(Strain == "BA77G") |>
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = Ex_WL)) +
  facet_grid(cols = vars(Ex_WL, Photoperiod, Strain), rows = vars(Par_ue)) +
  theme_bw()
```
# Variable names used in Data Dictionary

```{r}
# colnames(SolFitsMeta)
```


# Save Rds for further analysis

```{r save rds}
saveRDS(SolFitsMetaLRCGrowth, file.path(DataOut, paste(Project, "SolFitsMetaLRCGrowth.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(SolFitsMetaLRC, file.path("..", "..", "PicoDiel", "Data", "CleanedData",  "SolFitsMetaLRC.Rds", fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```


XXXXDoug Stopped JVPSII_umol_eLs calibratedXXX

------------------------------------------------------# Add Turner Catalog--------------------------------------------------

# Load Turner catalog

```{r load turner catalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()
Turnercatalog<- read_sheet("https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0")

as.data.frame(Turnercatalog)
ChlData <- Turnercatalog 

ChlData <- ChlData %>% 
  mutate(TurChl_ugL = as.numeric(Reading_rfu) * as.numeric(Chl_slope) + as.numeric(Chl_intercept)) %>% 
  mutate(DATE = ymd(`DATE`)) %>% 
  rename(SampleID=CultureID) %>% 
  #filter(str_detect(SampleID, pattern="SySl")) %>% 
  rename(ObsDate=DATE) %>% 
  select(c(SampleID, ObsDate, TurChl_ugL)) %>% 
  filter(TurChl_ugL<212354.754)  #outliers

```

# Calculate Chl mean from 3 technical replica

```{r}
ChlData <- ChlData %>%
  group_by(SampleID, ObsDate) %>%
  summarize(SampleID, ObsDate, TurChl_ugL,
            meanTurChl_ugL = mean(TurChl_ugL),
            sdTurChl_ugL = sd(TurChl_ugL)) %>%
  ungroup() %>% 
  unique()

ChlData
```


# Merge JVPSII with chlorophyll Turner data 
It is "bigger" df b/c I have 3 replica for Turner

```{r}
SolFitsExpStTurner <- ChlData %>%
  full_join(., SolFitsMetaLRCGrowth, by = c("SampleID"="SampleID", "ObsDate"="ObsDate")) %>% 
  drop_na(Strain)
```


```{r}
SolFitsExpStTurner<-SolFitsExpStTurner %>%  
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 
```

# Filter only revelant strains

```{r}
SolFitsExpStTurner<-SolFitsExpStTurner %>%  
  filter(Strain=="PC-rich_056" | Strain == "PC-rich_077" | Strain == "PE-rich_048" | Strain == "PE-rich_127")
```


# Create preliminary JVPSII vs Chl Turner (ug/L) plot

```{r preliminary plots, warning = FALSE}
# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsExpStTurner %>% 
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()

SolFitsExpStTurner %>% 
  ggplot() +
  geom_point(aes(x = meanTurChl_ugL, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()

SolFitsExpStTurner %>% 
  ggplot() +
  geom_point(aes(x = meanTurChl_ugL, y = JVPSII_umol_eLs_HalfPar_ue, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()


```


----------------------------------------Adding MDPico Data ----------------------------------------------------------

# IMPORT MD PICO DATA

```{r set project variables, warning = FALSE, echo = FALSE}
Project <- "BalticPhotoperiod"
zip_file <- file.path("..", "Data", "RawData", "MDPico.zip")

# List files in the extracted folder with a ".txt" extension
CountFiles <- unzip(zip_file, list = TRUE)
CountFiles <- CountFiles[grepl(".csv$", CountFiles$Name), "Name"]
print(CountFiles)

FileID <- "ExperimentSummaryData"
FileEncode <- "UTF-8" 
HeaderRows <- 0
DelimCS <- ","
```

# Read fread_plus function

```{r data read adds filename and cdate, warning=FALSE, message=FALSE, echo=FALSE}
# Define function to read and process each file
fread_plus <- function(Flnm, FileEncode, Delim) {
  con <- unz(zip_file, Flnm)
  
  # Read the file using read.table
  data <- read.table(con, skip = HeaderRows, encoding = FileEncode, sep = Delim, header = TRUE)
  
  # Use tryCatch to handle errors during the closing of the connection
  tryCatch(
    close(con),
    error = function(e) {
      warning("Error closing connection: ", e$message)
    })
  
  data <- data %>%
    mutate(Filename = Flnm, CDateTime = ymd_hms(file.info(zip_file)$ctime)) 
  return(data)
}

# Use map_df to read and process all files in CountFiles
MDPicoTidy <- CountFiles %>%
  map_df(~fread_plus(Flnm = ., FileEncode = FileEncode, Delim = DelimCS))
```

```{r tidy CountTidy}

MDPicoTidy <- MDPicoTidy %>% 
  select(-c("Concentration", "Group", "Compound", "CDateTime")) %>% # remove superfluous columns
  mutate(Filename = str_remove(string = Filename, pattern = ".csv")) %>%
  mutate(Filename = str_remove(string = Filename, pattern = "../MDPico/")) %>%
  separate(Filename, into = c("ObsDate", "Project", "Initials",  "PlateNr", "IndStud", "Organism", "Count"), sep = "([\\/\\/\\_\\_\\_\\_\\_])", remove = FALSE) %>%
  select(-c("IndStud", "Organism", "Count")) %>% 
  mutate(ObsDate = ymd_hm(ObsDate)) 

```

Load MDPicoMetaData catalog
```{r load local metadatacatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# this is the URL or ID of a Sheet readable by anyone (with a link)

MDPicoMetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1Lerp5u25kzBtaBbnOYElYqUP59cn68gJpxxayhnGdkw/edit#gid=0") %>%
  #mutate(Date = as.numeric(Date)) %>%
  mutate(Date = ymd_hm(`Date`)) %>%
  separate(Date, into = c("Date_count", "Time_count"), sep = " ", remove = FALSE) %>%
  mutate(Date_count = ymd(`Date_count`)) 
```

# Merge MD Pico and Culture catalog

```{r}
MDPicoMeta <- MDPicoMetaData %>%
  left_join(., CultureCatalog, by = c("SampleID" = "SampleID")) %>% 
  drop_na(Strain)
```

# Merge MD Pico with MD Pico catalog

```{r}
MDPicoAll <- MDPicoTidy %>%
  mutate(PlateNr = as.double(PlateNr)) %>%
  left_join(., MDPicoMeta, by = c("Well.Name" = "WellNumber", "PlateNr" = "PlateNumber")) %>% 
  drop_na(Strain)
```

```{r, warning = FALSE}
MDPicoAll <- MDPicoAll %>%
  mutate(culture_inocul_L = as.double(culture_inocul_L)) %>%
  mutate(CapAreaPercentage = as.double(CapAreaPercentage)) %>%

  mutate(CellmL_MDPico = (`Cell.Count` * (0.001/culture_inocul_L)) /(CapAreaPercentage/100)) %>%
  # mutate(cellsml = `cellsmlwithoutpercentage`/(CapAreaPercentage/100))
group_by(Date, SampleID) %>%

summarize(Well.Name, Cell.Count, Filename, ObsDate, PlateNr, PlateID, SampleID, Date, Date_count, Time_count, media_inocul_L, culture_inocul_L, CapAreaPercentage, Run, Strain, ExpDate, Par_ue, Photoperiod, PARPhotonDose_day, Tube, O2, WL, LightShape, ExpEndDate, CellmL_MDPico, meanCellmL_MDPico = mean(CellmL_MDPico), sdCellmL_MDPico = sd(CellmL_MDPico)) %>%

ungroup() %>%
  
group_by(SampleID) %>%
  arrange(Date_count) %>%
  mutate(E_days = as.numeric((Date_count - ExpDate[1]))) %>%
ungroup() %>% 
  rename(Cell_Count=Cell.Count) %>% 
  rename(Well_Name=Well.Name) %>% 
  rename(MeasDate = ObsDate) %>% 
  rename(ObsDateTime = Date) %>% 
  rename(ObsDate_count = Date_count) %>% 
  rename(ObsTime_count = Time_count) %>% 
  rename(FilenameMDPico=Filename)  
```

```{r}
MDPicoAll<-MDPicoAll %>% 
    select(-c(MeasDate, PlateNr, PlateID, Well_Name, media_inocul_L, culture_inocul_L, CapAreaPercentage)) %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
    drop_na(Cell_Count) %>% 
  select(-c(Cell_Count, ObsDateTime))
```

# Create Preliminary plot

```{r preliminary plot}
MDPicoAll %>%
  ggplot() +
  geom_point(aes(x = E_days, y = meanCellmL_MDPico)) +
  ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Strain, Photoperiod), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_value)) +
  theme_bw()
```
# Merge MD Pico with Solisense Turner

```{r}
# colnames(SolFitsExpStTurner)
# colnames(MDPicoAll)


SolFitsTurnerMDPico <- SolFitsExpStTurner %>%
  full_join(., MDPicoAll, by = c("SampleID"="SampleID", "Strain"="Strain", "Run"="Run", "Tube"="Tube", "Par_ue"="Par_ue", "Photoperiod"="Photoperiod", "WL"="WL", "O2"="O2", "LightShape"="LightShape", "PARPhotonDose_day"="PARPhotonDose_day", "ExpDate"="ExpDate", "ExpEndDate"="ExpEndDate",  "E_days"="E_days")) %>% 
  select(-c(estimate_a, estimate_b, estimate_Pmax, std.error_a, std.error_b, std.error_Pmax, lrcplatt_Model, MC)) %>% 
  unique()


```
# Create Preliminary plot

```{r preliminary plot}
SolFitsTurnerMDPico %>%
  ggplot() +
  geom_point(aes(y = JVPSII_umol_eLs_Par_ue, x = meanCellmL_MDPico)) +
  ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Strain, Photoperiod), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_value)) +
  theme_bw()
```

# Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsTurnerMDPico %>%
  filter(Ex_WL == 445) %>% 
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

SolFitsTurnerMDPico %>%
  filter(Ex_WL == 445) %>% 
  ggplot() +
  geom_point(aes(x = meanTurChl_ugL, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

SolFitsTurnerMDPico %>%
  filter(Ex_WL == 445) %>% 
  ggplot() +
  geom_point(aes(x = meanCellmL_MDPico, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```

# Choose only exp data

```{r choose only exp data}
O1 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
  filter(Photoperiod == 24) %>%
  filter(E_days <= 4)

O2 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>%
  filter(Photoperiod == 16) 
  #filter(E_days < 9)

O3 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 16) 
  #filter(E_days <= 4)

O4 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 16) 
  #filter(E_days <= 14)

O5 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 8 | Photoperiod == 12) 
  #filter(E_days <=14)

O6 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 8) 
  #filter(E_days <=14)

O7 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 12) %>%
  filter(E_days <=10)

O8 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 180 | Par_ue == 300) %>%
  filter(Photoperiod == 8 | Photoperiod == 12) 
  #filter(E_days <=10)

O9 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 8 | Photoperiod == 12) %>%
  filter(E_days <=7)

O10 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 24) %>%
  filter(E_days <= 8)

SolFitsAllExp <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)
```

# Choose only Stationary data 

```{r choose only St data}
O1 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
  filter(Photoperiod == 24) %>%
  filter(E_days > 4)

O2 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >14)

O3 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >10)

O4 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 180 | Par_ue == 300) %>%
  filter(Photoperiod == 8 | Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >10)

O5 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days >=6)

O6 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 12) %>%
  filter(E_days >=4)

O6 <- SolFitsTurnerMDPico %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 8) %>%
  filter(E_days >7)

SolFitsAllSt <-rbind(O1, O2, O3, O4, O5, O6)

rm(O1, O2, O3, O4, O5, O6)
```

# Combine Exp and St data

```{r}
  SolFitsAllExp$Phase <- 'Exponential'
  SolFitsAllSt$Phase <- 'Pre-stationary'

  SolFitsAllExpSt <-rbind(SolFitsAllExp, SolFitsAllSt)
  rm(SolFitsAllExp, SolFitsAllSt)
```


# Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsAllExpSt %>%
  filter(Ex_WL == 445) %>% 
  filter(Phase == "Exponential") %>% 
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Phase, Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

SolFitsAllExpSt %>%
  filter(Ex_WL == 445) %>% 
  filter(Phase == "Exponential") %>% 
  #filter(Photoperiod == 8) %>% 
  ggplot() +
  geom_point(aes(x = meanTurChl_ugL, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Phase, Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

SolFitsAllExpSt %>%
  filter(Ex_WL == 445) %>% 
  filter(Phase == "Exponential") %>% 
  ggplot() +
  geom_point(aes(x = meanCellmL_MDPico, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Phase, Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```

# Save rds for further analysis

```{r save rds}
saveRDS(SolFitsAllExpSt, file.path(DataOut, paste(Project, "Processed_SolisenseJVPSII_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

```








--------------------------------- Adding cell_L from calibration ---------------------------------

```{r set project variables}
# Project <- "BalticPhotoperiod"
# DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedPigmentsData", fsep = .Platform$file.sep)
```

```{r Exported Rmd}
# list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read pigments File}
#df ontained mean OD per day from Multiculti and Abs from Olis spectra for selected nm. Based on this I calculated pigments per mL and per cell (pg/cell)

# MCPigmentAllFile <- "../Data/ProcessedData/ProcessedPigmentsData/BalticPhotoperiod_Processed_PigmentsAll.Rds"
# MCPigmentAllFileName <- str_split(string = MCPigmentAllFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# MCPigmentAll <- readRDS(MCPigmentAllFile)  %>%
#   ungroup()
```

```{r}
# colnames(MCPigmentAll)
# 
# MCPigmentAll<-MCPigmentAll %>% 
#   select(-c(Phase, ChlaugmL, CarugmL, PEugmL, PCugmL, APCugmL, PhycougmL, CarChlaRatio, PhycoChlaRatio, PEPCRatio, Chlapgcell, Carpgcell, PEpgcell, PCpgcell, APCpgcell, Phycopgcell, meanOD720_h, meanDeltaOD_h, AchivePreStationary, dayRound_tmaxAG, MaxAG, MaxDG, MC))

```

```{r}
# MCPigmentAll <- MCPigmentAll %>%
#   filter(ToD==12) # When I choose 12 (peak) then I loose a few data point from 12h and 900UE
```

```{r}
# SolFitsAll <- MCPigmentAll %>%
#   full_join(., SolFitsExpStTurner, by = c("SampleID"="SampleID", "Strain"="Strain", "Run"="Run", "Tube"="Tube", "Par_ue" = "Par_ue", "Photoperiod"="Photoperiod", "O2"="O2", "WL"="WL", "LightShape"="LightShape", "ExpDate"="ExpDate", "ExpEndDate"="ExpEndDate", "PARPhotonDose_day"="PARPhotonDose_day","E_days"="E_days"))
```

```{r}
# SolFitsAll<-SolFitsAll %>% 
#   drop_na(JVPSII_umol_eLs_Par_ue)
```

# Create preliminary plot

```{r preliminary plot}
# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
# 
# SolFitsAll %>%
#   filter(Ex_WL == 445) %>% 
#   ggplot() +
#   geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
#   ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw() 
# 
# SolFitsAll %>%
#   filter(Ex_WL == 445) %>% 
#   ggplot() +
#   geom_point(aes(x = TurChl_ugL, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
#   ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw() 
# 
# SolFitsAll %>%
#   filter(Ex_WL == 445) %>% 
#   ggplot() +
#   geom_point(aes(x = cellL_OD680, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
#   ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw() 
```


# Choose only exp data

```{r choose only exp data}
# O1 <- SolFitsAll %>%
#   filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
#   filter(Photoperiod == 24) %>%
#   filter(E_days <= 4)
# 
# O2 <- SolFitsAll %>%
#   filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>%
#   filter(Photoperiod == 16) 
#   #filter(E_days < 9)
# 
# O3 <- SolFitsAll %>%
#   filter(Par_ue == 900 | Par_ue == 600) %>%
#   filter(Photoperiod == 16) %>%
#   filter(E_days <= 4)
# 
# O4 <- SolFitsAll %>%
#   filter(Par_ue == 30) %>%
#   filter(Photoperiod == 16) 
#   #filter(E_days <= 14)
# 
# O5 <- SolFitsAll %>%
#   filter(Par_ue == 30) %>%
#   filter(Photoperiod == 8 | Photoperiod == 12) 
#   #filter(E_days <=14)
# 
# O6 <- SolFitsAll %>%
#   filter(Par_ue == 90) %>%
#   filter(Photoperiod == 8) 
#   #filter(E_days <=14)
# 
# O7 <- SolFitsAll %>%
#   filter(Par_ue == 90) %>%
#   filter(Photoperiod == 12) %>%
#   filter(E_days <=10)
# 
# O8 <- SolFitsAll %>%
#   filter(Par_ue == 180 | Par_ue == 300) %>%
#   filter(Photoperiod == 8 | Photoperiod == 12) 
#   #filter(E_days <=10)
# 
# O9 <- SolFitsAll %>%
#   filter(Par_ue == 900 | Par_ue == 600) %>%
#   filter(Photoperiod == 8 | Photoperiod == 12) %>%
#   filter(E_days <=7)
# 
# O10 <- SolFitsAll %>%
#   filter(Par_ue == 30) %>%
#   filter(Photoperiod == 24) %>%
#   filter(E_days <= 8)
# 
# SolFitsAllExp <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)
# 
# rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)
```

# Choose only Stationary data 

```{r choose only St data}
# O1 <- SolFitsAll %>%
#   filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
#   filter(Photoperiod == 24) %>%
#   filter(E_days > 4)
# 
# O2 <- SolFitsAll %>%
#   filter(Par_ue == 30) %>%
#   filter(Photoperiod == 12 | Photoperiod == 16) %>%
#   filter(E_days >14)
# 
# O3 <- SolFitsAll %>%
#   filter(Par_ue == 90) %>%
#   filter(Photoperiod == 12 | Photoperiod == 16) %>%
#   filter(E_days >10)
# 
# O4 <- SolFitsAll %>%
#   filter(Par_ue == 180 | Par_ue == 300) %>%
#   filter(Photoperiod == 8 | Photoperiod == 12 | Photoperiod == 16) %>%
#   filter(E_days >10)
# 
# O5 <- SolFitsAll %>%
#   filter(Par_ue == 900 | Par_ue == 600) %>%
#   filter(Photoperiod == 16) %>%
#   filter(E_days >=6)
# 
# O6 <- SolFitsAll %>%
#   filter(Par_ue == 900 | Par_ue == 600) %>%
#   filter(Photoperiod == 12) %>%
#   filter(E_days >=4)
# 
# O6 <- SolFitsAll %>%
#   filter(Par_ue == 900 | Par_ue == 600) %>%
#   filter(Photoperiod == 8) %>%
#   filter(E_days >7)
# 
# SolFitsAllSt <-rbind(O1, O2, O3, O4, O5, O6)
# 
# rm(O1, O2, O3, O4, O5, O6)
```

# Combine Exp and St data

```{r}
  # SolFitsAllExp$Phase <- 'Exponential'
  # SolFitsAllSt$Phase <- 'Pre-stationary'
  # 
  # SolFitsAllExpSt <-rbind(SolFitsAllExp, SolFitsAllSt)
  # rm(SolFitsAllExp, SolFitsAllSt)
```


# Create preliminary plot

```{r preliminary plot}
# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
# 
# SolFitsAllExpSt %>%
#   filter(Ex_WL == 445) %>% 
#   filter(Phase == "Exponential") %>% 
#   ggplot() +
#   geom_point(aes(x = E_days, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
#   ggh4x::facet_nested(cols = vars(Phase, Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw() 
# 
# SolFitsAllExpSt %>%
#   filter(Ex_WL == 445) %>% 
#   filter(Phase == "Exponential") %>% 
#   #filter(Photoperiod == 8) %>% 
#   ggplot() +
#   geom_point(aes(x = TurChl_ugL, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
#   ggh4x::facet_nested(cols = vars(Phase, Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw() 
# 
# SolFitsAllExpSt %>%
#   filter(Ex_WL == 445) %>% 
#   filter(Phase == "Exponential") %>% 
#   ggplot() +
#   geom_point(aes(x = cellL_OD680, y = JVPSII_umol_eLs_Par_ue, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
#   ggh4x::facet_nested(cols = vars(Phase, Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw() 
```
# Save rds for further analysis

```{r save rds}
# saveRDS(SolFitsAllExpSt, file.path(DataOut, paste(Project, "Processed_SolisenseJVPSII.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

```

# Cleaning the environment

```{r}
# rm(MCPigmentAll, ChlData, SolFitsExpStTurner, Turnercatalog)
```





-------------------------------------------- LIFT example plot ----------------------------------

# Set Project Variables 

```{r set project variables, read zipped files, list available files, warning = FALSE, echo=FALSE}
Project <- "BalticPhotoperiod"
DataIn <- file.path("..", "Data", "RawData", "SolisenseCurveData")
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedSolisenseData")

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")
# FileID <- "fit"
# FileEncode <- "UTF-8"
# Delimiter <- ","
# HeaderRows <- 0
```

# Read Imported Solisense

```{r read locally stored metadata from rds}
LIFT445_0 <- read.csv(file = file.path("..", "Data", "RawData", "SolisenseCurveData", "PICO_202112201453_SySl1035_445_data_dark.csv"))
LIFT445_0<-LIFT445_0 %>% 
  rename(DataPt=X....) %>% 
  rename(Time_us=X) %>% 
  rename(EX=X.1) %>% 
  rename(EM=X.2) %>% 
  rename(Fit=X.3) %>% 
  rename(PAR = X.4) %>% 
  select(-c(X.5))
LIFT445_0 = LIFT445_0[-1:-15,]
LIFT445_0[is.na(LIFT445_0)] <- 0
LIFT445_0$Ex_WL <- 445

LIFT445_80 <- read.csv(file = file.path("..", "Data", "RawData", "SolisenseCurveData", "PICO_202112201453_SySl1035_445_data_light80.csv"))
LIFT445_80<-LIFT445_80 %>% 
  rename(DataPt=X....) %>% 
  rename(Time_us=X) %>% 
  rename(EX=X.1) %>% 
  rename(EM=X.2) %>% 
  rename(Fit=X.3) %>% 
  rename(PAR = X.4) %>% 
  select(-c(X.5))
LIFT445_80 = LIFT445_80[-1:-15,]
LIFT445_80[is.na(LIFT445_80)] <- 80
LIFT445_80$Ex_WL <- 445

LIFT590_0 <- read.csv(file = file.path("..", "Data", "RawData", "SolisenseCurveData", "PICO_202112201547_SySl1035_590_data_dark.csv"))
LIFT590_0<-LIFT590_0 %>% 
  rename(DataPt=X....) %>% 
  rename(Time_us=X) %>% 
  rename(EX=X.1) %>% 
  rename(EM=X.2) %>% 
  rename(Fit=X.3) %>% 
  rename(PAR = X.4) %>% 
  select(-c(X.5))
LIFT590_0 = LIFT590_0[-1:-15,]
LIFT590_0[is.na(LIFT590_0)] <- 0
LIFT590_0$Ex_WL <- 590

LIFT590_80 <- read.csv(file = file.path("..", "Data", "RawData", "SolisenseCurveData", "PICO_202112201547_SySl1035_590_data_light80.csv"))
LIFT590_80<-LIFT590_80 %>% 
  rename(DataPt=X....) %>% 
  rename(Time_us=X) %>% 
  rename(EX=X.1) %>% 
  rename(EM=X.2) %>% 
  rename(Fit=X.3) %>% 
  rename(PAR = X.4) %>% 
  select(-c(X.5))
LIFT590_80 = LIFT590_80[-1:-15,]
LIFT590_80[is.na(LIFT590_80)] <- 80
LIFT590_80$Ex_WL <- 590


LIFT<-rbind(LIFT590_80, LIFT590_0, LIFT445_80, LIFT445_0)
rm(LIFT590_80, LIFT590_0, LIFT445_80, LIFT445_0)

LIFT$SampleID <- "SySl1035"
LIFT$ObsDate <- 20211220

LIFT<-LIFT %>% 
  mutate(ObsDate=as.Date(ObsDate)) %>% 
  mutate(DataPt=as.double(DataPt)) %>% 
  mutate(Time_us=as.double(Time_us)) %>% 
  mutate(EX=as.double(EX)) %>% 
  mutate(EM=as.double(EM)) %>% 
  mutate(Fit=as.double(Fit)) 
```


# Merge LIFT data with MetaData

```{r combine Solisense and MetaData catalog, warning = FALSE, echo=FALSE}
LIFTMeta <- LIFT %>%
  left_join(., CultureCatalog, by = c("SampleID" = "SampleID"))

rm(LIFT)
```

```{r}
LIFTMeta$facetsActinicPAR = factor(LIFTMeta$O2, labels = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"))
LIFTMeta$facetsExcitation = factor(LIFTMeta$WL, labels = c("Excitation~(nm)"))
```


# Create preliminary plot

```{r fig.height = 4.5, fig.width = 8, warning = FALSE}
data_textA <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('A'))

arrowdf1 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain = "PE-rich_048")
arrowdf2 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain = "PE-rich_048")

arrowdf3 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain = "PE-rich_048")
arrowdf4 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain = "PE-rich_048")

data_textSat <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(590), Strain  = c("PE-rich_048"), label = c('Saturation'))
data_textRel <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(590), Strain  = c("PE-rich_048"), label = c('Relaxation'))
data_textSat1 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(590), Strain  = c("PE-rich_048"), label = c('(~250 µs)'))
data_textRel1 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(590), Strain  = c("PE-rich_048"), label = c('(~250-50000 µs)'))
data_textRel2 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(590), Strain  = c("PE-rich_048"), label = c(''))

data_textTao <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('italic(\u03C4)[1] - italic(\u03C4)[3]'))
data_textTaop <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('italic(\u03C4)[1]~ʹ~- italic(\u03C4)[3]', "~~~~~~~~~~~~~~~'ʹ'"))

data_textFm <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[M]"))
data_textFmp <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[M]", "~~~~~~~'ʹ'"))

# data_textF0 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("F[0]"))
data_textF0 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[O]"))

data_textF <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[]", "~~~~~'ʹ'"))
# data_textF <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("F"))

data_textSig <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('\u03C3[PSII]'))
data_textSigp <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('\u03C3[PSII]', "~~~~~~~~~~~'ʹ'"))

# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


PlotA<-LIFTMeta %>%
  filter(Time_us<1000) %>% 
  filter(Time_us>0) %>% 
  ggplot() +
  #geom_point(aes(x = Time_us, y = EX),  colour = "brown4", alpha = 0.8, size = 1, show.legend = F) +
  geom_point(aes(x = Time_us, y = EM),  colour = "brown1", alpha = 0.8, size = 2, show.legend = F) +
  geom_line(aes(x = Time_us, y = Fit),  colour = "blue", alpha = 0.7, size = 0.7, show.legend = F) +
  geom_vline(xintercept = 250, linetype="dashed", col="black", lwd=0.2) +
  
  geom_text(data=data_textA, aes(x=950, y=450, label=label), size=4.5) +
  
  geom_text(data=data_textSat, aes(x=100, y=500, label=label), size=3.5) +
  geom_text(data=data_textRel, aes(x=500, y=500, label=label), size=3.5) +
  geom_text(data=data_textSat1, aes(x=100, y=210, label=label), size=3.5) +
  geom_text(data=data_textRel1, aes(x=500, y=210, label=label), size=3.5) +
  geom_text(data=data_textRel2, aes(x=500, y=180, label=label), size=3.5) +
  
  geom_text(data=data_textTao, aes(x=400, y=250, label=label), size=3.5, parse = TRUE) +
  geom_text(data=data_textTaop, aes(x=450, y=300, label=label), size=3.5, parse = TRUE) +
  
  geom_text(data=data_textFm, aes(x=350, y=400, label=label), size=3.5, parse = TRUE) +
  geom_text(data=data_textFmp, aes(x=350, y=480, label=label), size=3.5, parse = TRUE) +
  
  geom_text(data = data_textF0, aes(x = 50, y = 150, label = label), size = 3.5, parse = TRUE) +
  #geom_text(data=data_textF0, aes(x=50, y=100, label=expression(F[0])), size=3.5, parse = TRUE) +
  geom_text(data = data_textF, aes(x=50, y=200, label=label), size=3.5, parse = TRUE) +

  geom_text(data=data_textSig, aes(x=100, y=400, label=label), size=3.5, parse = TRUE) +
  geom_text(data=data_textSigp, aes(x=60, y=450, label=label), size=3.5, parse = TRUE) +
  
  geom_segment(data = arrowdf1, aes(x = -5, xend = 150, y = 230, yend = 360),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(ends="both", type = "closed", length=unit(0.1, 'cm'))) +
  geom_segment(data = arrowdf2, aes(x = -10, xend = 150, y = 260, yend = 450),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(ends="both", type = "closed", length=unit(0.1, 'cm'))) +

  geom_segment(data = arrowdf3, aes(x = 250, xend = 500, y = 355, yend = 355),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(type = "closed", length=unit(0.1, 'cm'))) +
  geom_segment(data = arrowdf4, aes(x = 250, xend = 500, y = 440, yend = 440),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(type = "closed", length=unit(0.1, 'cm'))) +
  
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  # scale_y_continuous(breaks=seq(0, 2000, by = 500)) +
  # coord_cartesian(ylim = c(0, 2500)) +
  #annotate("text", x = 50, y = 100, label = expression(F[0]), size = 3.5, data = data_textF0) +
  #annotate("text", x = 1, y = 1, label = "\u03C4[PSII]", parse = TRUE) +
  labs(y = "Fluorescence yield", x = "Elapsed time (µs)") +
  ggh4x::facet_nested(cols = vars(facetsActinicPAR, PAR), rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed, scales="free_y") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
PlotA
```
# Save plot 

```{r save plot}
#ggsave(file = file.path(FigPath, paste("Fig_LIFT_1",".png",sep = "")), height=4.5, width= 7,  dpi = 300, limitsize = TRUE)
```



# Plot a

```{r fig.height = 4.5, fig.width = 8, warning = FALSE}
data_textA <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('A'))

arrowdf1 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain = "PE-rich_048")
arrowdf2 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain = "PE-rich_048")

arrowdf3 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain = "PE-rich_048")
arrowdf4 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain = "PE-rich_048")

data_textSat <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('Saturation'))
data_textRel <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('Relaxation'))
data_textSat1 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('(~250 µs)'))
data_textRel1 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('(~250-50000 µs)'))
data_textRel2 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c(''))

data_textTao <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('italic(\u03C4)[1] - italic(\u03C4)[3]'))
data_textTaop <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('italic(\u03C4)[1]~ʹ~- italic(\u03C4)[3]', "~~~~~~~~~~~~~~~'ʹ'"))

data_textFm <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[M]"))
data_textFmp <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[M]", "~~~~~~~'ʹ'"))

data_textF0 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[O]"))

data_textF <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[]", "~~~~~'ʹ'"))

data_textSig <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('\u03C3[PSII]'))
data_textSigp <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('\u03C3[PSII]', "~~~~~~~~~~~'ʹ'"))


Plota<-LIFTMeta %>%
  filter(Ex_WL==445) %>% 
  filter(Time_us<1000) %>% 
  filter(Time_us>0) %>% 
  ggplot() +
  geom_point(aes(x = Time_us, y = EM),  colour = "darkblue", shape = 1, alpha = 0.8, size = 2, show.legend = F) +
  geom_line(aes(x = Time_us, y = Fit),  colour = "blue", alpha = 0.7, size = 0.7, show.legend = F) +
  geom_vline(xintercept = 250, linetype="dashed", col="black", lwd=0.2) +
  
  geom_text(data=data_textA, aes(x=1000, y=500, label=label), size=5) +
  
  geom_text(data=data_textSat, aes(x=100, y=100, label=label), size=4) +
  geom_text(data=data_textRel, aes(x=500, y=100, label=label), size=4) +
  geom_text(data=data_textSat1, aes(x=100, y=60, label=label), size=4) +
  geom_text(data=data_textRel1, aes(x=500, y=60, label=label), size=4) +
  geom_text(data=data_textRel2, aes(x=500, y=40, label=label), size=4) +
  
  geom_text(data=data_textTao, aes(x=400, y=280, label=label), size=4, parse = TRUE) +
  geom_text(data=data_textTaop, aes(x=450, y=330, label=label), size=4, parse = TRUE) +
  
  geom_text(data=data_textFm, aes(x=350, y=390, label=label), size=4, parse = TRUE) +
  geom_text(data=data_textFmp, aes(x=350, y=470, label=label), size=4, parse = TRUE) +
  
  geom_text(data = data_textF0, aes(x = 50, y = 180, label = label), size = 4, parse = TRUE) +
  geom_text(data = data_textF, aes(x=50, y=230, label=label), size=4, parse = TRUE) +

  geom_text(data=data_textSig, aes(x=100, y=390, label=label), size=4, parse = TRUE) +
  geom_text(data=data_textSigp, aes(x=60, y=450, label=label), size=4, parse = TRUE) +
  
  geom_segment(data = arrowdf1, aes(x = -25, xend = 150, y = 190, yend = 360),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(ends="both", type = "closed", length=unit(0.1, 'cm'))) +
  geom_segment(data = arrowdf2, aes(x = -15, xend = 150, y = 240, yend = 450),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(ends="both", type = "closed", length=unit(0.1, 'cm'))) +

  geom_segment(data = arrowdf3, aes(x = 250, xend = 500, y = 355, yend = 355),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(type = "closed", length=unit(0.1, 'cm'))) +
  geom_segment(data = arrowdf4, aes(x = 250, xend = 500, y = 440, yend = 440),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(type = "closed", length=unit(0.1, 'cm'))) +

  labs(y = "Fluorescence yield", x = "Elapsed time (µs)") +
  ggh4x::facet_nested(cols = vars(facetsActinicPAR, PAR), labeller = label_parsed, scales="free_y") +
  # ggh4x::facet_nested(cols = vars(facetsActinicPAR, PAR), rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed, scales="free_y") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
Plota
```

# Plot aa

```{r fig.height = 4.5, fig.width = 8, warning = FALSE}
scientific_10 <- function(y) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(y))) }

LIFTMeta590<-LIFTMeta %>% 
  filter(Ex_WL==590) %>% 
  filter(Time_us<1000) %>% 
  filter(Time_us>0) 

LIFTMeta445<-LIFTMeta %>% 
  filter(Ex_WL==445) %>% 
  filter(Time_us<1000) %>% 
  filter(Time_us>0) 

data_textA <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('A'))

arrowdf1 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain = "PE-rich_048")
arrowdf2 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain = "PE-rich_048")

arrowdf3 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain = "PE-rich_048")
arrowdf4 <- tibble(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain = "PE-rich_048")

data_textSat <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('Saturation'))
data_textRel <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('Relaxation'))
data_textSat1 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('(~250 µs)'))
data_textRel1 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0, 80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('(~250-50000 µs)'))


data_textTao <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('italic(\u03C4)[1] - italic(\u03C4)[3]'))
data_textTaop <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('italic(\u03C4)[1]~ʹ~- italic(\u03C4)[3]', "~~~~~~~~~~~~~~~'ʹ'"))

data_textFm <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[M]"))
data_textFmp <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[M]", "~~~~~~~'ʹ'"))

data_textF0 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[O]"))

data_textF <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[]", "~~~~~'ʹ'"))

data_textSig <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('\u03C3[PSII]'))
data_textSigp <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(80), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c('\u03C3[PSII]', "~~~~~~~~~~~'ʹ'"))


Plotaa<-LIFTMeta %>%
  #filter(Ex_WL==445) %>% 
  filter(Time_us<1000) %>% 
  filter(Time_us>0) %>% 
  ggplot() +
  geom_point(aes(x = Time_us, y = EM),  colour = "darkblue", alpha = 0.8, size = 2, shape = 1, show.legend = F, LIFTMeta445) +
  geom_point(aes(x = Time_us, y = EM),  colour = "orange", alpha = 0.8, size = 1.5, shape = 5, show.legend = F, LIFTMeta590) +
  geom_line(aes(x = Time_us, y = Fit),  colour = "darkblue", alpha = 0.7, size = 0.7, show.legend = F, LIFTMeta445) +
  geom_line(aes(x = Time_us, y = Fit),  colour = "orange", alpha = 0.7, size = 0.7, show.legend = F, LIFTMeta590) +
  geom_vline(xintercept = 250, linetype="dashed", col="black", lwd=0.2) +
  
  geom_text(data=data_textA, aes(x=-25, y=2000, label=label), size=5.5) +
  
  geom_text(data=data_textSat, aes(x=100, y=-140, label=label), size=4.0) +
  geom_text(data=data_textRel, aes(x=500, y=-140, label=label), size=4.0) +
  geom_text(data=data_textSat1, aes(x=100, y=-280, label=label), size=4.0) +
  geom_text(data=data_textRel1, aes(x=500, y=-280, label=label), size=4.0) +

  
  geom_text(data=data_textTao, aes(x=400, y=200, label=label), size=4.5, parse = TRUE) +
  geom_text(data=data_textTaop, aes(x=450, y=250, label=label), size=4.5, parse = TRUE) +
  
  geom_text(data=data_textFm, aes(x=350, y=480, label=label), size=4.5, parse = TRUE) +
  geom_text(data=data_textFmp, aes(x=350, y=560, label=label), size=4.5, parse = TRUE) +
  
  geom_text(data = data_textF0, aes(x = 10, y = 60, label = label), size = 4.5, parse = TRUE) +
  geom_text(data = data_textF, aes(x=10, y=110, label=label), size=4.5, parse = TRUE) +

  geom_text(data=data_textSig, aes(x=30, y=420, label=label), size=4.5, parse = TRUE) +
  geom_text(data=data_textSigp, aes(x=30, y=480, label=label), size=4.5, parse = TRUE) +
  
  geom_segment(data = arrowdf1, aes(x = -25, xend = 120, y = 220, yend = 360),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(ends="both", type = "closed", length=unit(0.1, 'cm'))) +
  geom_segment(data = arrowdf2, aes(x = -25, xend = 120, y = 250, yend = 450),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(ends="both", type = "closed", length=unit(0.1, 'cm'))) +

  geom_segment(data = arrowdf3, aes(x = 250, xend = 500, y = 370, yend = 370),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(type = "closed", length=unit(0.1, 'cm'))) +
  geom_segment(data = arrowdf4, aes(x = 250, xend = 500, y = 440, yend = 440),
               colour = "black", size = 0.5, alpha=0.9, arrow = arrow(type = "closed", length=unit(0.1, 'cm'))) +

  labs(y = "Fluorescence yield", x = "Elapsed time (µs)") +
  ggh4x::facet_nested(cols = vars(facetsActinicPAR, PAR), labeller = label_parsed, scales="free_y") +
  
  scale_y_continuous(breaks=seq(0, 2000, by = 500)) +
  coord_cartesian(ylim = c(-300, 2000)) +
  
  # ggh4x::facet_nested(cols = vars(facetsActinicPAR, PAR), rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed, scales="free_y") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
Plotaa
```


```{r}
LIFTMeta %>%
  #filter(Time_us<1000) %>% 
  filter(Time_us>0) %>% 
  ggplot() +
  #geom_point(aes(x = Time_us, y = EX),  colour = "brown4", alpha = 0.8, size = 1, show.legend = F) +
  geom_point(aes(x = log(Time_us), y = EM),  colour = "brown1", alpha = 0.8, size = 2, show.legend = F) +
  geom_line(aes(x = log(Time_us), y = Fit),  colour = "blue", alpha = 0.7, size = 0.7, show.legend = F) +
    #labs(y = "Fluorescence yield", x = "Elapsed time (µs)") +
  ggh4x::facet_nested(cols = vars(facetsActinicPAR, PAR), rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed, scales="free_y") +
  theme_bw() 
```

```{r}
#SolFitsMetaLRC$facetsActinicPAR = factor(SolFitsMetaLRC$O2, labels = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"))
SolFitsMetaLRC$facetsExcitation = factor(SolFitsMetaLRC$WL, labels = c("Excitation~(nm)"))
```

# Preliminary plot

```{r }
data_textC <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('C'))

SolFitsMetaLRC %>%  
  unnest(lrcplatt_Predict) %>% 
  filter(Strain == "BA48R") %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 7) %>%
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs), colour = "brown1", alpha = 0.8, size = 2, show.legend = F) +
  geom_line(aes(ActPARCorr, .fitted), colour = "blue", linetype = "solid", size = 0.4) +
  geom_text(data=data_textC, aes(x=800, y=0.7, label=label), size=4.5) +
  #labs(y = ""~italic(JV)~""["PSII"]*" ("~10^18~""~e^-~""~L^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  labs(y = ""~italic(JV)~""["PSII"]*" (µmol"~e^-~""~L^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))

```




# Again join with ChlTurner for plot only

```{r}
#colnames(SolFitsMeta)

SolFitsMetaPlot<-SolFitsMeta %>% 
  select(c(SampleID, Run, Strain, ExpDate, Par_ue, Photoperiod, O2, WL, LightShape, PARPhotonDose_day, Ex_WL, ObsDate, ActPARCorr, E_days, JVPSII_eLs, JVPSII_umol_eLs))

SolTurner <- ChlData %>%
  full_join(., SolFitsMetaPlot, by = c("SampleID"="SampleID", "ObsDate"="ObsDate")) %>% 
  drop_na(Strain) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
  filter(Strain=="PC-rich_056" | Strain == "PC-rich_077" | Strain == "PE-rich_048" | Strain == "PE-rich_127")
  
```

# Calculate Turner per umol chl

```{r}
SolTurner<-SolTurner %>% 
  mutate(meanTurChl_umolL=meanTurChl_ugL*0.00112)
```


# Again join with MDPico for plot only

```{r}
colnames(MDPicoAll)
MDPicoAllPlot<-MDPicoAll %>% 
  select(c(SampleID, Run, Strain, ExpDate, Par_ue, Photoperiod, PARPhotonDose_day, O2, WL, LightShape, ObsDate_count, CellmL_MDPico, meanCellmL_MDPico, sdCellmL_MDPico, E_days))

SolTurnerMDPico <- SolTurner %>%
  left_join(., MDPicoAllPlot, by = c("SampleID"="SampleID", "Run"="Run", "Strain"="Strain", 'ExpDate'="ExpDate", "Par_ue"="Par_ue", "Photoperiod"="Photoperiod", "PARPhotonDose_day"="PARPhotonDose_day", "O2"="O2", "WL"="WL", "LightShape"="LightShape", "E_days"="E_days")) %>% 
  drop_na(Strain) 
```
# Filter unrevelant columns

```{r}
colnames(SolTurnerMDPico)
SolTurnerMDPico<-SolTurnerMDPico %>% 
  select(-c(TurChl_ugL, sdTurChl_ugL, CellmL_MDPico, sdCellmL_MDPico)) %>% 
  unique() %>% 
  mutate(meanCellL_MDPico=meanCellmL_MDPico*1000) %>% 
  mutate(JVPSII_umol_eLs_Cell=JVPSII_umol_eLs/meanCellL_MDPico) %>% 
  mutate(JVPSII_umol_eLs_ugChla=JVPSII_umol_eLs/meanTurChl_ugL) %>% 
  mutate(JVPSII_umol_eLs_umolChla=JVPSII_umol_eLs/meanTurChl_umolL) 
```
# Adding facet labels

```{r}
SolTurnerMDPico$facetsExcitation = factor(SolTurnerMDPico$WL, labels = c("Excitation~(nm)"))
```


```{r warning = FALSE}

SolTurnerMDPico %>%  
  filter(Strain == "PE-rich_048") %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 7) %>%
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_Cell), colour = "brown1", alpha = 0.8, size = 2, show.legend = F) +
  ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw()

SolTurnerMDPico %>%  
  filter(Strain == "PE-rich_048") %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 7) %>%
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_ugChla), colour = "brown1", alpha = 0.8, size = 2, show.legend = F) +
  ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw()

SolTurnerMDPico %>%  
  filter(Strain == "PE-rich_048") %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 7) %>%
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_umolChla), colour = "brown1", alpha = 0.8, size = 2, show.legend = F) +
  ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw()
```

# Fit LRC for JVPSII to allow selection of specific JVPSII for different growth light levels.

```{r}
lrcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

colnames(SolTurnerMDPico)

SolTurnerMDPicoLRC <- SolTurnerMDPico %>%
  drop_na(ObsDate_count) %>% 
  nest(data = -c("SampleID", "Run", "Strain" ,"ExpDate","Par_ue", "Photoperiod", "O2", "WL","Ex_WL","LightShape",  "PARPhotonDose_day", "ObsDate", "E_days", "facetsExcitation")) %>% 
  mutate(lrcplatt_Model = map(data, possibly(~nlsLM(JVPSII_umol_eLs_Cell ~ lrcplatt(I = ActPARCorr, a, b, Pmax),
         data = .x,
         control = list(maxiter = 100),
         start = list(a = 0.1, b = 0.01, Pmax = 3), lower = c(0, 0, 0))))) %>%
  mutate(lrcplatt_Param = map(lrcplatt_Model, tidy),
         lrcplatt_Predict = map(lrcplatt_Model, possibly(augment)),
         lrcplatt_Glance = map(lrcplatt_Model, possibly(glance)))


SolTurnerMDPicoLRC2 <- SolTurnerMDPico %>%
  drop_na(ObsDate_count) %>% 
  nest(data = -c("SampleID", "Run", "Strain" ,"ExpDate","Par_ue", "Photoperiod", "O2", "WL","Ex_WL","LightShape",  "PARPhotonDose_day", "ObsDate", "E_days", "facetsExcitation")) %>% 
  mutate(lrcplatt_Model = map(data, possibly(~nlsLM(JVPSII_umol_eLs_umolChla ~ lrcplatt(I = ActPARCorr, a, b, Pmax),
         data = .x,
         control = list(maxiter = 100),
         start = list(a = 0.1, b = 0.01, Pmax = 3), lower = c(0, 0, 0))))) %>%
  mutate(lrcplatt_Param = map(lrcplatt_Model, tidy),
         lrcplatt_Predict = map(lrcplatt_Model, possibly(augment)),
         lrcplatt_Glance = map(lrcplatt_Model, possibly(glance)))
```

# Create preliminary plot - Example

```{r prelim plot}
SolTurnerMDPicoLRC |> 
  unnest(lrcplatt_Predict) |>
  filter(Strain == "PE-rich_048") %>% 
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) |>
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_Cell, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_line(aes(ActPARCorr, .fitted), colour = "black", linetype = "dotted") +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain, Par_ue, Photoperiod, E_days), labeller = label_parsed) +
  theme_bw()



SolTurnerMDPicoLRC2 |> 
  unnest(lrcplatt_Predict) |>
  filter(Strain == "PE-rich_048") %>% 
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) |>
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_umolChla, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_line(aes(ActPARCorr, .fitted), colour = "black", linetype = "dotted") +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain, Par_ue, Photoperiod, E_days), labeller = label_parsed) +
  theme_bw()
```

# Plot C

```{r fig.height = 4.5, fig.width = 8, warning = FALSE}
data_textC <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('C'))

PlotC<-SolTurnerMDPicoLRC2 %>%  
  unnest(lrcplatt_Predict) %>% 
  filter(Strain == "PE-rich_048") %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 7) %>%
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_umolChla), colour = "brown1", alpha = 0.8, size = 2, show.legend = F) +
  geom_line(aes(ActPARCorr, .fitted), colour = "blue", linetype = "solid", size = 0.4) +
  geom_text(data=data_textC, aes(x=800, y=1, label=label), size=4.5) +
  #labs(y = ""~italic(JV)~""["PSII"]*" ("~10^18~""~e^-~""~L^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  labs(y = ""~italic(JV)~""["PSII"]*" (µmol"~e^-~""~µmol~Chl~italic(a)~""^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  
  ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
PlotC
```

# Plot C

```{r fig.height = 4.5, fig.width = 8, warning = FALSE}
data_textC <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('C'))

Plotc<-SolTurnerMDPicoLRC2 %>%  
  unnest(lrcplatt_Predict) %>% 
  filter(Ex_WL==445) %>% 
  filter(Strain == "PE-rich_048") %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 14) %>%
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_umolChla), colour = "darkblue", shape = 1, alpha = 0.8, size = 2, show.legend = F) +
  geom_line(aes(ActPARCorr, .fitted), colour = "blue", linetype = "solid", size = 0.4) +
  geom_text(data=data_textC, aes(x=800, y=0.4, label=label), size=5) +
  #labs(y = ""~italic(JV)~""["PSII"]*" ("~10^18~""~e^-~""~L^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  labs(y = ""~italic(JV)~""["PSII"]*" (µmol"~e^-~""~µmol~Chl~italic(a)~""^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  #ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
Plotc
```
# Plot C

```{r fig.height = 4.5, fig.width = 8, warning = FALSE}
data_textC <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('C'))

SolTurnerMDPicoLRC2590<-SolTurnerMDPicoLRC2 %>% 
  unnest(lrcplatt_Predict) %>% 
  filter(Strain == "PE-rich_048") %>%
  filter(Ex_WL==590) %>% 
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 7) 
  
Plotcc<-SolTurnerMDPicoLRC2 %>%  
  unnest(lrcplatt_Predict) %>% 
  filter(Ex_WL==445) %>% 
  filter(Strain == "PE-rich_048") %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days == 14) %>%
ggplot() +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_umolChla), colour = "darkblue", shape = 1, size = 2, alpha = 0.8, size = 2, show.legend = F) +
  geom_point(aes(ActPARCorr, JVPSII_umol_eLs_umolChla), colour = "orange", shape = 5, size = 1.5, alpha = 0.8, size = 2, show.legend = F, SolTurnerMDPicoLRC2590) +
  geom_line(aes(ActPARCorr, .fitted), colour = "darkblue", linetype = "solid", size = 0.4) +
  geom_line(aes(ActPARCorr, .fitted), colour = "orange", linetype = "solid", size = 0.4, SolTurnerMDPicoLRC2590) +
  geom_text(data=data_textC, aes(x=0, y=0.8, label=label), size=5.5) +
  
  scale_y_continuous(breaks=seq(0, 0.8, by = 0.2)) +
  coord_cartesian(ylim = c(0, 0.8)) +
  
  #labs(y = ""~italic(JV)~""["PSII"]*" ("~10^18~""~e^-~""~L^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  labs(y = ""~italic(JV)~""["PSII"]*" (µmol"~e^-~""~µmol~Chl~italic(a)~""^-1~""~s^-1~")", x = "Actinic PAR ( µmol photons "~m^-2~""~s^-1~")") +
  #ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
Plotcc
```


# Save plot 

```{r save plot}
#ggsave(file = file.path(FigPath, paste("Fig_LIFT",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```






# JVPSII vs eLs

```{r JVPSII calib}
O2FRRfMetaModels <- read_rds(file.path("..","Data", "CleanedData", "JVPSIIO2Calib", "O2FRRfMetaModels.Rds"))

O2FRRfMetaModels$facetsExcitation <- 'Excitation~(nm)'
#smarter way to code this with 'which' in [] and map through Ex_WL
# SolFitsMeta <- left_join(SolFitsMeta, JVPSII_eLs_ModelTerms, by = join_by(Ex_WL)) |>
#   select(-c(Slope_P)) |>
#   mutate(JVPSII_eLs = JVPSII_ETRqpOxbo_FoSigmax_m2psii/Slope) |>
#   mutate(JVPSII_umol_eLs = JVPSII_eLs/6.022e17)

```

# Plot B

```{r JVPSII_e regressions}
data_textB <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('B'))

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
scientific_10 <- function(y) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(y))) }

PlotB<-O2FRRfMetaModels %>%
  filter(Ex_WL == 445 | Ex_WL == 590) %>% 
  unnest(JVPSII_ETRqpOxbo_FoSigmax_m2psii_e_predict) %>%
  ggplot() +
  geom_line(aes(x = e_Ls, y = .fitted), colour = "black", linetype = "dashed") +
  geom_text(data=data_textB, aes(x=2.8e17, y=7.1e22, label=label), size=4.5) +
 #geom_line(aes(x = O2evln_O2ls, y = .fitted + .se.fit), colour = "grey", linetype = "dashed") +
 #geom_line(aes(x = O2evln_O2ls, y = .fitted - .se.fit), colour = "grey", linetype = "dashed") +
  geom_point(aes(x = e_Ls, y = JVPSII_ETRqpOxbo_FoSigmax_m2psii),colour = "darkgreen") +
  geom_point(aes(x = e_Ls, y = .resid), colour = "darkred", size = 0.1) +
  geom_hline(yintercept = 0,linetype = "dashed") +
  scale_x_continuous(label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 7.5e22, by = 2.5e22), label=scientific_10) +
  coord_cartesian(ylim = c(-100, 7.5e22)) +
  labs(y = "Uncalibrated"~italic(JV)~""["PSII"]*"", x = ""~e^-~""~L^-1~""~s^-1~"") +
  #labs(y = ""~italic(JV)~""["PSII"]*" ("~e^-~""~L^-1~""~s^-1~")", x = ""~e^-~""~L^-1~""~s^-1~"") +
  ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
PlotB
```
# Plot B

```{r JVPSII_e regressions, fig.height = 4.5, fig.width = 8, warning = FALSE}
data_textB <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('B'))

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
scientific_10 <- function(y) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(y))) }

Plotb<-O2FRRfMetaModels %>%
  filter(Ex_WL == 445) %>% 
  unnest(JVPSII_ETRqpOxbo_FoSigmax_m2psii_e_predict) %>%
  ggplot() +
  geom_line(aes(x = e_Ls, y = .fitted), colour = "blue", linetype = "solid") +
  geom_text(data=data_textB, aes(x=7.5e16, y=2.0e22, label=label), size=5) +
 #geom_line(aes(x = O2evln_O2ls, y = .fitted + .se.fit), colour = "grey", linetype = "dashed") +
 #geom_line(aes(x = O2evln_O2ls, y = .fitted - .se.fit), colour = "grey", linetype = "dashed") +
  geom_point(aes(x = e_Ls, y = JVPSII_ETRqpOxbo_FoSigmax_m2psii),colour = "darkblue", shape = 1, alpha = 0.8, size = 2.0) +
  #geom_point(aes(x = e_Ls, y = .resid), colour = "black", size = 0.1) +
  #geom_hline(yintercept = 0,linetype = "dashed") +
  scale_x_continuous(label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 2e22, by = 1e22), label=scientific_10) +
  coord_cartesian(ylim = c(-100, 2e22)) +
  labs(y = "Uncalibrated"~italic(JV)~""["PSII"]*"", x = ""~e^-~""~L^-1~""~s^-1~"") +
  #labs(y = ""~italic(JV)~""["PSII"]*" ("~e^-~""~L^-1~""~s^-1~")", x = ""~e^-~""~L^-1~""~s^-1~"") +
  #ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
Plotb
```
# Plot B

```{r JVPSII_e regressions, fig.height = 4.5, fig.width = 8, warning = FALSE}
data_textB <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('B'))
data_textSlope445 <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('Calibration slope = 108832'))
data_textSlope590 <- data.frame(facetsExcitation  = c("Excitation~(nm)"), Ex_WL = c("445"), label = c('Calibration slope = 254327'))

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
scientific_10 <- function(y) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(y))) }

O2FRRfMetaModels590<-O2FRRfMetaModels %>% 
  filter(Ex_WL == 590) %>% 
  unnest(JVPSII_ETRqpOxbo_FoSigmax_m2psii_e_predict) 


Plotbb<-O2FRRfMetaModels %>%
  filter(Ex_WL == 445) %>% 
  unnest(JVPSII_ETRqpOxbo_FoSigmax_m2psii_e_predict) %>%
  ggplot() +
  geom_line(aes(x = e_Ls, y = .fitted), colour = "darkblue", linetype = "solid") +
  geom_line(aes(x = e_Ls, y = .fitted), colour = "orange", linetype = "solid", O2FRRfMetaModels590) +
  geom_text(data=data_textB, aes(x=1000000000000, y=8e22, label=label), size=5.5) +
  geom_text(data=data_textSlope445, aes(x=1.6e17, y=0.7e22, label=label), size=4, colour = "darkblue") +
  geom_text(data=data_textSlope590, aes(x=7.5e16, y=6e22, label=label), size=4, colour = "orange") +
 #geom_line(aes(x = O2evln_O2ls, y = .fitted + .se.fit), colour = "grey", linetype = "dashed") +
 #geom_line(aes(x = O2evln_O2ls, y = .fitted - .se.fit), colour = "grey", linetype = "dashed") +
  geom_point(aes(x = e_Ls, y = JVPSII_ETRqpOxbo_FoSigmax_m2psii),colour = "darkblue", shape =1, alpha = 0.8, size = 2.0) +
  geom_point(aes(x = e_Ls, y = JVPSII_ETRqpOxbo_FoSigmax_m2psii),colour = "orange", shape =5, size = 1.5, alpha = 0.8, size = 2.0, O2FRRfMetaModels590) +
  # geom_point(aes(x = e_Ls, y = .resid), colour = "darkblue", alpha = 0.8, size = 0.1) +
  # geom_point(aes(x = e_Ls, y = .resid), colour = "orange", alpha = 0.8, size = 0.1, O2FRRfMetaModels590) +
  #geom_hline(yintercept = 0,linetype = "dashed") +
  scale_x_continuous(label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 8e22, by = 2e22), label=scientific_10) +
  coord_cartesian(ylim = c(-100, 8e22), xlim = c(0, 2.8e17)) +
  labs(y = "Uncalibrated"~italic(JV)~""["PSII"]*"", x = ""~e^-~""~L^-1~""~s^-1~"") +
  #labs(y = ""~italic(JV)~""["PSII"]*" ("~e^-~""~L^-1~""~s^-1~")", x = ""~e^-~""~L^-1~""~s^-1~"") +
  #ggh4x::facet_nested(rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=11))
Plotbb
```

```{r, warning = FALSE, fig.height = 9, fig.width = 10}
ggp<- Plota/(Plotb+Plotc)   
ggp                           
```
# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_LIFT2",".png",sep = "")), height=9, width= 9.5, dpi = 300, limitsize = TRUE)
```


```{r, warning = FALSE, fig.height = 9, fig.width = 10}
ggp<- Plotaa/(Plotbb+Plotcc)   
ggp                           
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_LIFT",".png",sep = "")), height=10, width= 9.5,  dpi = 300, limitsize = TRUE)
```


# Merge two plots into one with panel A and B

```{r Final Plot arrange, warning = FALSE, fig.height = 9, fig.width = 8}
# ggarrange(Plota,Plotb,Plotc,
#           ncol = 1, nrow = 3) 


# ss<-ggarrange(PlotA,PlotB,
#           ncol = 1, nrow = 2) %>% 
#   ggsave(file = file.path(FigPath, paste("Fig_LIFT",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```


# Save rds for further analysis

```{r save rds}
# saveRDS(SolFitsTrimMetaClean, file.path(DataOut, paste(Project, "Imported_SolisenseLight1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
# 
# saveRDS(SolFitsTrimMetaDarkafterLight, file.path(DataOut, paste(Project, "Imported_SolisenseDarkafterLight1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Variable names used in Data Dictionary

```{r}
# colnames(SolFitsTrimMetaClean)
```




--------------------------------------------------------------------------------------------------------------------------

Oxborough & Baker 1997 for Fo'

Oxborough, K., & Baker, N. R. (1997). Resolving chlorophyll a fluorescence images of photosynthetic efficiency into photochemical and non-photochemical components–calculation of qP and Fv-/Fm-; without measuring Fo. Photosynthesis research, 54, 135-142.

Oxborough, K., & Baker, N. R. (1997). An instrument capable of imaging chlorophyll a fluorescence from intact leaves at very low irradiance and at cellular and subcellular levels of organization. Plant, Cell & Environment, 20(12), 1473-1483.

Oxborough, K., Moore, C. M., Suggett, D. J., Lawson, T., Chan, H. G., & Geider, R. J. (2012). Direct estimation of functional PSII reaction center concentration and PSII electron flux on a volume basis: a new approach to the analysis of Fast Repetition Rate fluorometry (FRRf) data. Limnology and Oceanography: Methods, 10(3), 142-154.

Suggett, D. J., Moore, C. M., Oxborough, K., & Geider, R. J. (2006). Fast repetition rate (FRR) chlorophyll a fluorescence induction measurements. West Molesey: Chelsea Technologies Group, 1-53.




Berge, J., Grant, S., Bjørgum, R., Cohen, J. H., McKee, D., Johnsen, G., Zolich, A., Kopec, T. P., Vogedes, D. L., UiT The Arctic University of Norway (2021).Time series (2017) of irradiance in the PAR (photosynthetically active radiation) region measured under the dome of a light observatory in the Arctic  (Ny-Ålesund, Svalbard, Norway) derived from an USSIMO spectroradiometer [Data set]. Norstore. https://doi.org/10.11582/2021.00040

https://archive.norstore.no/pages/public/datasetDetail.jsf?id=10.11582/2021.00040

PAR is approximated as an integral of micromolespersec=(uirr/(h*c/(lambda*1e-9)))/microavo for wavelengths(lambda) in range from 400 to 700nm, where: uirr = USSIMO irradiance for wavelength equal to lambda, h=6.63e-34 [Js], c=3.00e+08 [m/s], microavo=6.022e17.





Fast Repetition Rate fluorometry (FRRf, Kolber et al. 1998) 

σPSII - Effective absorption cross section of PSII photochemistry in darkness -> A2 (quanta)-1 or m2
ρ - Connectivity between PSII reaction centres in darkness

σPSII′ - Effective absorption cross section of PSII photochemistry under actinic light -> A2 (quanta)-1 or m2
ρ′ - Connectivity between PSII reaction centres under actinic light

TauPSII - Minimum turnover time of PSII photochemistry -> s-1

F0 or F0’ (Minimum fluorescence in darkness or Minimum fluorescence under actinic light)
Fm or Fm’ (Maximum fluorescence in darkness or Maximum fluorescence under actinic light)
F’ (or Fs; Steady state fluorescence at any point)
Fv = Fm-F0 (Variable fluorescence in darkness)
Fv’ = Fm’-F0’ (Variable fluorescence under actinic light)
Fq′ = (Fm′ - F′) (Difference between Fm′ and F′)

Fv/Fm = (Fm-F0)/Fm (The maximum PSII quantum yield/Maximum photochemical efficiency)
Fv’/Fm’ = (Fm’- F0’)/Fm’ (Maximum PSII efficiency under actinic light)

ΦPSII = (Fm’- F’)/Fm’ = Fq′/Fm′ (Photochemical efficiency under actinic light)

qP = (Fm’- F’)/(Fm’-F0’) = (Fm′ - F′)/Fv′ = Fq′/Fv′ (PSII efficiency factor under actinic light; photochemical quenching coefficient) 

NPQ =(Fm-Fm’)/Fm’ (Non-photochemical quenching coefficien)


ETR = PPFD * aPSII * PSII photochemical efficiency (ΦPSII)

ETR^RCII = PPFD * σPSII * Fq′/Fm′ (or ΦPSII) * 21.683

ETR^chl = PPFD * σPSII * n PSII * Fq′/Fm′ (or ΦPSII) * 21.683


FRR fluorescence provides a direct measure of light absorption per unit PSII reaction centres (σPSII).

ETR, called the relative electron transport rate, is the product of the effective photochemical yield of
PSII (ΦPSII) and photosynthetic photon flux density

ETR^RCII(chl) - RCII (Chlorophyll a)-normalised rate of electron transfer by PSII -> mol e- g chla-1 h-1

ETR^chl is the chlorophylla-specific rate of electron transfer (mol e- mol chla-1 h-1 ).

PPFD (=E) - Photosynthetically active photon flux density -> μmol m-2 s-1

a^chlPSII - a^chl only used for PSII photochemistry -> m2 mg chla-1

(factor 21.683 converts seconds to hours, μmol e- to mol e- and A2 quanta-1 to m2 mol RCII-1)

nPSII - photosynthetic unit size of PSII

JVPSII - PSII flux per unit volume -> electrons m–3 s–1

[RCII] - concentration of functional PS II reaction centers -> m-3

aLHII - LHII (light harvesting complex II) absorption coefficient -> m-1


```{r example of different labels on plot}

# data_textF0 <- data.frame(facetsActinicPAR  = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"), facetsExcitation  = c("Excitation~(nm)"), PAR  = c(0), Ex_WL  = c(445), Strain  = c("PE-rich_048"), label = c("italic(F)[0]^{-1}"))

# data_textF0 <- data.frame(facetsActinicPAR = c("Actinic~PAR~(µmol~photons~m^{-2}~s^{-1})"),
#                           facetsExcitation = c("Excitation~(nm)"),
#                           PAR = c(0),
#                           Ex_WL = c(445),
#                           Strain = c("PE-rich_048"),
#                           label = c("~\"''\""))
# 
# LIFTMeta %>%
#   filter(Time_us < 1000) %>%
#   ggplot() +
#   geom_point(aes(x = Time_us, y = EM), colour = "brown1", alpha = 0.8, size = 2, show.legend = FALSE) +
#   geom_text(data = data_textF0, aes(x = 50, y = 100, label = label), size = 3.5, parse = TRUE) +
#   ggh4x::facet_nested(cols = vars(facetsActinicPAR, PAR), rows = vars(facetsExcitation, Ex_WL), labeller = label_parsed, scales = "free_y") +
#   theme_bw()

```
