---
title: "Process_SolisensePigmentsData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_SolisensePigmentsData.Rmd processes and combines BalticPhotoperiod_Imported_SolisenseDarkafterLight.Rds and BalticPhotoperiod_Imported_SolisenseLight.Rds from Data/ImportedData/ImportedSolisenseData folder. This .Rmd generates BalticPhotoperiod_Processed_SolisensePigmentsExp.Rds (stored in Data/ProcessedData/ProcessedSolisenseData folder) and three plots: Sigma_SupPlot.png, SigmavsPigments590_Plot, SigmavsPigments445_SupPlot.png (stored in Output/Plots folder).

# Load Libraries and set Project Variables

```{r load libraries, warning = FALSE, echo=FALSE} 
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(ggpubr)
library(caret)
library(reshape2)
library(gcookbook)
library(scales)
library(Cairo) #for greek symbols
library(googledrive)
library(googlesheets4)
library(readxl)
```

```{r set project variables}
Project <- "BalticPhotoperiod"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedSolisenseData")
DataIn <- file.path("..", "Data", "ImportedData", "ImportedSolisenseData", fsep = .Platform$file.sep)

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")
```

# List and read Imported_Solisense RDS

```{r Exported Rmd}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

# This RDS contained only data from corresponding growth light 
# Also, conteined mean sig - mean for replica measured on the same day

```{r read ProcessFile Sol}
SolisenseFile <- "../Data/ImportedData/ImportedSolisenseData/BalticPhotoperiod_Imported_SolisenseLight.Rds"  

SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits <- readRDS(SolisenseFile)  %>%
  ungroup()
```

# This RDS contained only sigma in 1s of dark after corresponding light (it caused problems when I tried to combain them with sig in the light)
# Also, conteined mean for sig1s - mean for replica measured on the same day

```{r read ProcessFile Sol1s}
# Solisense1sFile <- "../Data/ImportedData/ImportedSolisenseData/BalticPhotoperiod_Imported_SolisenseDarkafterLight.Rds"
# 
# Solisense1sFileName <- str_split(string = Solisense1sFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# 
# SolFits1s <- readRDS(Solisense1sFile)  %>%
#   ungroup()
```


```{r Preparing df for further analysis}
SolFits <-SolFits %>% 
  select(c(SampleID, Run, Strain, ExpDate, Par_ue, Photoperiod, MC, Tube, O2, WL, LightShape, ExpEndDate, PARPhotonDose_day, FilenameSolisense, ObsDate, ObsTime, Ex_WL, ActPAR, LR_s, nm445, nm590, nm445Corr, nm590Corr, ActPARCorr, Sig, Sig_nm2psii, Sigdark, Sigdark_nm2psii, ActPARCorr_photonsm2s, FoOxbo, qpOxbo,  JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRqpOxbo_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig, E_days, Time_h)) %>% 
  filter(Strain=="BA127R"| Strain=="BA48R"| Strain=="BA56G"| Strain=="BA77G") %>% 
  filter(WL=="WW") %>% 
  filter(O2==21) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 
SolFits$facetsPhotonDose_day = factor(SolFits$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))
SolFits$facetsExcitation = factor(SolFits$WL, labels = c("Excitation~(nm)"))
SolFits$facetsStrain = factor(SolFits$WL, labels = c("Strain"))


# SolFits1s <-SolFits1s %>% 
#   select(c(SampleID, Run, Strain, ExpDate, Par_ue, Photoperiod, MC, Tube, O2, WL, LightShape, ExpEndDate, PARPhotonDose_day, FilenameSolisense, ObsDate, ObsTime, Ex_WL, ActPAR, LR_s, nm445, nm590, nm445Corr, nm590Corr, ActPARCorr, Sig1s, Sig1s_nm2psii, ActPARCorr_photonsm2s, E_days, Time_h)) %>% 
#   filter(Strain=="BA127R"| Strain=="BA48R"| Strain=="BA56G"| Strain=="BA77G") %>% 
#   filter(WL=="WW") %>% 
#   filter(O2==21) %>% 
#   mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
#          Strain=="BA48R"~"PE-rich_048",
#         Strain=="BA56G"~"PC-rich_056",
#          Strain=="BA77G"~"PC-rich_077")) 
# SolFits1s$facetsPhotonDose_day = factor(SolFits1s$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))
# SolFits1s$facetsExcitation = factor(SolFits1s$WL, labels = c("Excitation~(nm)"))
# SolFits1s$facetsStrain = factor(SolFits1s$WL, labels = c("Strain"))
```

# Filter unrevelant data and outliers

```{r filter outliers}
# #Filter one unrevelant data point at 445nm, 16h, 900uE
SolFitsAll445<-SolFits %>%
  filter(Ex_WL == 445) %>%
  filter(Sig<250) 
SolFitsAll590<-SolFits %>%
  filter(Ex_WL == 590)
SolFits<-rbind(SolFitsAll445,SolFitsAll590)
  rm(SolFitsAll445,SolFitsAll590)
  
# SolFitsAll4451s<-SolFits1s %>%
#   filter(Ex_WL == 445) %>%
#   filter(Sig1s<250) 
# SolFitsAll5901s<-SolFits1s %>%
#   filter(Ex_WL == 590)
# SolFits1s<-rbind(SolFitsAll4451s,SolFitsAll5901s)
#   rm(SolFitsAll4451s,SolFitsAll5901s)  
```

# Create preliminary plots 

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFits %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = Sig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  facet_grid(rows = vars(Ex_WL), cols = vars(Photoperiod)) +
  theme_bw()
```

# Load tmaxAG catalog and create 4 df for vertical lines (coloured as Strain) contained tMaxAG values

```{r}
gs4_deauth()
tmaxAG<- read_sheet("https://docs.google.com/spreadsheets/d/1ksY7xlg9wOsICOBRmZkHPKdd9KOislNwPDzyuJ3UIUI/edit#gid=0")
as.data.frame(tmaxAG)
tmaxAG <- tmaxAG

tmaxAG<-tmaxAG %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAG = as.numeric(tMaxAG)) %>%
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))
```

```{r select revelant columns}
tMaxAGLines_056<-tmaxAG %>% 
  filter(Strain == "PC-rich_056") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_077<-tmaxAG %>% 
  filter(Strain == "PC-rich_077") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_048<-tmaxAG %>% 
  filter(Strain == "PE-rich_048") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_127<-tmaxAG %>% 
  filter(Strain == "PE-rich_127") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
```

# Choose only exp data for sigma and JVPSII in the corresponding light

```{r choose only exp data}
O1 <- SolFits %>%
  filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days <= 4)

O2 <- SolFits %>%
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days < 9)

O3 <- SolFits %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 4)

O4 <- SolFits %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 14)

O5 <- SolFits %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=14)
  
O6 <- SolFits %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days <=14)

O7 <- SolFits %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days <=10)

O8 <- SolFits %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=10)

O9 <- SolFits %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=7)

O10 <- SolFits %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days <= 8)

SolFitsExp <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)
```


# Choose only Stationary data for sigma and JVPSII in the corresponding light

```{r choose only St data}
O1 <- SolFits %>%
  filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
  filter(Photoperiod == 24) %>%
  filter(E_days > 4)

O2 <- SolFits %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >14)
  
O3 <- SolFits %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >10)

O4 <- SolFits %>%
  filter(Par_ue == 180 | Par_ue == 300) %>%
  filter(Photoperiod == 8 | Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >10)

O5 <- SolFits %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 8 | Photoperiod == 16) %>% 
  filter(E_days >7)

SolFitsSt <-rbind(O1, O2, O3, O4, O5)

rm(O1, O2, O3, O4, O5)
```



# Choose only exp data for sigma at 1s after corresponding light

```{r choose only exp data for Sig 1s}
# O1 <- SolFits1s %>%
#   filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>% 
#   filter(Photoperiod == 24) %>% 
#   filter(E_days <= 4)
# 
# O2 <- SolFits1s %>%
#   filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
#   filter(Photoperiod == 16) %>% 
#   filter(E_days < 9)
# 
# O3 <- SolFits1s %>%
#   filter(Par_ue == 900 | Par_ue == 600) %>% 
#   filter(Photoperiod == 16) %>% 
#   filter(E_days <= 4)
# 
# O4 <- SolFits1s %>%
#   filter(Par_ue == 30) %>% 
#   filter(Photoperiod == 16) %>% 
#   filter(E_days <= 14)
# 
# O5 <- SolFits1s %>%
#   filter(Par_ue == 30) %>% 
#   filter(Photoperiod == 8 | Photoperiod == 12) %>% 
#   filter(E_days <=14)
#   
# O6 <- SolFits1s %>%
#   filter(Par_ue == 90) %>% 
#   filter(Photoperiod == 8) %>% 
#   filter(E_days <=14)
# 
# O7 <- SolFits1s %>%
#   filter(Par_ue == 90) %>% 
#   filter(Photoperiod == 12) %>% 
#   filter(E_days <=10)
# 
# O8 <- SolFits1s %>%
#   filter(Par_ue == 180 | Par_ue == 300) %>% 
#   filter(Photoperiod == 8 | Photoperiod == 12) %>% 
#   filter(E_days <=10)
# 
# O9 <- SolFits1s %>%
#   filter(Par_ue == 900) %>% 
#   filter(Photoperiod == 8 | Photoperiod == 12) %>% 
#   filter(E_days <=7)
# 
# O10 <- SolFits1s %>%
#   filter(Par_ue == 30) %>% 
#   filter(Photoperiod == 24) %>% 
#   filter(E_days <= 8)
# 
# SolFitsExp1s <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)
# 
# rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)
```


# Choose only Stationary data for sigma at 1s after corresponding light

```{r choose only St data}
# O1 <- SolFits1s %>%
#   filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
#   filter(Photoperiod == 24) %>%
#   filter(E_days > 4)
# 
# O2 <- SolFits1s %>%
#   filter(Par_ue == 30) %>%
#   filter(Photoperiod == 12 | Photoperiod == 16) %>%
#   filter(E_days >14)
#   
# O3 <- SolFits1s %>%
#   filter(Par_ue == 90) %>%
#   filter(Photoperiod == 12 | Photoperiod == 16) %>%
#   filter(E_days >10)
# 
# O4 <- SolFits1s %>%
#   filter(Par_ue == 180 | Par_ue == 300) %>%
#   filter(Photoperiod == 8 | Photoperiod == 12 | Photoperiod == 16) %>%
#   filter(E_days >10)
# 
# O5 <- SolFits1s %>%
#   filter(Par_ue == 900 | Par_ue == 600) %>% 
#   filter(Photoperiod == 8 | Photoperiod == 16) %>% 
#   filter(E_days >7)
# 
# SolFitsSt1s <-rbind(O1, O2, O3, O4, O5)
# 
# rm(O1, O2, O3, O4, O5)
```


# Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFits %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

SolFitsExp %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

SolFitsSt %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```
# Combine Exp and St data

```{r}
  SolFitsExp$Phase <- 'Exponential'
  # SolFitsExp1s$Phase <- 'Exponential'
  
  SolFitsSt$Phase <- 'Pre-stationary'
  # SolFitsSt1s$Phase <- 'Pre-stationary'
  
  SolFitsExpSt <-rbind(SolFitsExp, SolFitsSt)
  # SolFitsExpSt1s <-rbind(SolFitsExp1s, SolFitsSt1s)
  
  rm(SolFitsExp, SolFitsSt, SolFits)
  #rm(SolFitsExp1s, SolFitsSt1s, SolFits1s)
```

#Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsExpSt %>%
  # filter(E_days!=2) %>% 
  filter(Ex_WL==445) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab3) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
```

# Calculate Sigma mean from 3 replica measured on the same day
# 6 replica b/c 3 replica * 2 values ("up" and "down")

```{r calculate Sigma mean from 3 replica measured on the same day}
SolFitsExpSt <- SolFitsExpSt %>%
  group_by(SampleID, Ex_WL, ObsDate, Par_ue, Photoperiod, WL, O2, Phase) %>%
  
  summarize(SampleID, Ex_WL, FilenameSolisense, Run, Strain, ExpDate, Par_ue, Photoperiod, O2, WL, Phase,  PARPhotonDose_day, ObsDate, ObsTime, Sig, Sig_nm2psii, ActPARCorr_photonsm2s, Sigdark_nm2psii, FoOxbo, qpOxbo, JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRqpOxbo_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig, facetsPhotonDose_day, facetsExcitation, facetsStrain,
            meanSig_nm2psii = mean(Sig_nm2psii),
            sdSig_nm2psii = sd(Sig_nm2psii),
            meanSigdark_nm2psii = mean(Sigdark_nm2psii),
            sdSigdark_nm2psii = sd(Sigdark_nm2psii)) %>%
  ungroup()

SolFitsExpSt<- SolFitsExpSt %>%
group_by(SampleID) %>%
  arrange(ObsDate) %>%
  mutate(E_days = as.numeric((ObsDate - ExpDate[1]))) %>%
ungroup()

SolFitsExpSt<- SolFitsExpSt %>%
  mutate(Time_h = E_days*24)
```

# Calculate Sigma1s mean from 3 replica measured on the same day
# 6 replica b/c 3 replica * 2 values ("up" and "down")

```{r calculate Sigma1s mean from 3 replica measured on the same day}
# SolFitsExpSt1s <- SolFitsExpSt1s %>%
#   group_by(SampleID, Ex_WL, ObsDate, Par_ue, Photoperiod, WL, O2, Phase) %>%
#   
#   summarize(SampleID, Ex_WL, FilenameSolisense, Run, Strain, ExpDate, Par_ue, Photoperiod, O2, WL, Phase,  PARPhotonDose_day, ObsDate, ObsTime, Sig1s, Sig1s_nm2psii, ActPARCorr_photonsm2s, facetsPhotonDose_day, facetsExcitation, facetsStrain,
#             meanSig1s_nm2psii = mean(Sig1s_nm2psii),
#             sdSig1s_nm2psii = sd(Sig1s_nm2psii)) %>%
#   ungroup()
# 
# SolFitsExpSt1s<- SolFitsExpSt1s %>%
# group_by(SampleID) %>%
#   arrange(ObsDate) %>%
#   mutate(E_days = as.numeric((ObsDate - ExpDate[1]))) %>%
# ungroup()
# 
# SolFitsExpSt1s<- SolFitsExpSt1s %>%
#   mutate(Time_h = E_days*24)
```

Make "one big - All" mean to combine all days (divided by Exp and St) and all replica when samples were measured 
(This give me only one value of JVPSII for further growth vs JVPSII plot and sig plot as well)


# Calculate Sigma mean from all data measured on Exp or St phase 
# Usually Allmean contains 12 replica - two different days of measurements * 3 replica * 2 values (up and down)

```{r calculate Sigma mean from exp phase}

SolFitsExpSt<-SolFitsExpSt %>% 
  group_by(Strain, Ex_WL, Par_ue, Photoperiod, WL, O2, Phase) %>%
  
  summarize(SampleID, Ex_WL, FilenameSolisense, Run, Strain, ExpDate, Par_ue, Photoperiod, O2, WL, Phase,  PARPhotonDose_day, ObsDate, ObsTime, Sig, Sig_nm2psii, meanSig_nm2psii, sdSig_nm2psii, ActPARCorr_photonsm2s, Sigdark_nm2psii, meanSigdark_nm2psii, sdSigdark_nm2psii, FoOxbo, qpOxbo, JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRqpOxbo_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig, facetsPhotonDose_day, facetsExcitation, facetsStrain, E_days, Time_h,
              
            #  AllmeanJVPSII_aLHIIOxbomax= mean(JVPSII_aLHIIOxbomax),
            #  AllmeanJVPSII_ETRtauav_FoSig= mean(JVPSII_ETRtauav_FoSig),
            #  AllmeanJVPSII_ETRqpOxbo_FoSig= mean(JVPSII_ETRqpOxbo_FoSig),
            # AllmeanJVPSII_ETRtauav_aLHII_Sig = mean(JVPSII_ETRtauav_aLHII_Sig),
            #  AllmeanJVPSII_ETRqpOxbo_aLHII_Sig= mean(JVPSII_ETRqpOxbo_aLHII_Sig),
            AllmeanSig_nm2psii = mean(Sig_nm2psii),
            AllsdSig_nm2psii = sd(Sig_nm2psii),
            AllmeanSigdark_nm2psii = mean(Sigdark_nm2psii),
            AllsdSigdark_nm2psii = sd(Sigdark_nm2psii)) %>%
  ungroup()
```

# Filter otliers to calculate exponential decay function

```{r filter outliers (5 data points from Exp)}

Sol7<-SolFitsExpSt %>% 
  filter(Ex_WL==445) 

Sol3<-SolFitsExpSt %>% #keeping all data except <180 (one data point)
  filter(Phase == "Exponential") %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue !=900) %>% 
  filter(Strain=="PC-rich_056") %>% 
  filter(Sig>180)
Sol6<-SolFitsExpSt %>% # keeping all except 2 data points
  filter(Phase == "Exponential") %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue ==900) %>% 
  filter(Strain=="PC-rich_056") 

Sol8<-SolFitsExpSt %>% 
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain=="PC-rich_056") %>% 
  filter(Par_ue ==900 | Par_ue ==600) %>% 
  filter(Sig<230)

Sol9<-SolFitsExpSt %>% 
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain=="PC-rich_056") %>% 
  filter(Par_ue !=900 & Par_ue !=600) %>% 
  filter(Sig>130)

#BA127
Sol4<-SolFitsExpSt %>% #removing one data point
  filter(Phase == "Exponential") %>%
  filter(Ex_WL==590) %>%
  filter(Par_ue ==30) %>%
  filter(Strain=="PE-rich_127") %>%
  filter(Sig>310)
Sol5<-SolFitsExpSt %>%
  filter(Phase == "Exponential") %>% #removing 3 data points
  filter(Ex_WL==590) %>%
  filter(Par_ue ==300 | Par_ue ==180 | Par_ue ==90) %>%
  filter(Strain=="PE-rich_127") %>%
  filter(Sig>200)
Sol16<-SolFitsExpSt %>% # keeping all except 2 data points
  filter(Phase == "Exponential") %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue ==900 | Par_ue ==600) %>% 
  filter(Strain=="PE-rich_127")  %>% 
  filter(Sig<520)
Sol12<-SolFitsExpSt %>% 
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain=="PE-rich_127")

#BA48
Sol1<-SolFitsExpSt %>% #keeping all data
  filter(Phase == "Exponential") %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue !=900) %>% 
  filter(Strain=="PE-rich_048") 
Sol15<-SolFitsExpSt %>% # removing 2 data points
  filter(Phase == "Exponential") %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue ==900 | Par_ue ==600) %>% 
  filter(Strain=="PE-rich_048") %>% 
  filter(Sig<520) 
Sol10<-SolFitsExpSt %>% # removing few data points
  filter(Phase == "Pre-stationary") %>% 
  filter(Par_ue !=900) %>% 
  filter(Strain=="PE-rich_048") %>% 
  filter(Sig>290)
Sol11<-SolFitsExpSt %>% #keeping all data
  filter(Phase == "Pre-stationary") %>%
  filter(Par_ue ==900) %>%
  filter(Strain=="PE-rich_048")


#BA77
Sol2<-SolFitsExpSt %>% #keeping all data
  filter(Phase == "Exponential") %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue !=900) %>% 
  filter(Strain=="PC-rich_077") 
Sol13<-SolFitsExpSt %>% #keeping all data
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain=="PC-rich_077") %>% 
  filter(Par_ue != 600)  
  #filter(Sig<490)
Sol14<-SolFitsExpSt %>% #filter 1 data point
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain=="PC-rich_077") %>% 
  filter(Par_ue==600) %>% 
  filter(Sig<250)
Sol17<-SolFitsExpSt %>% # removing 2 data points
  filter(Phase == "Exponential") %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue ==900 | Par_ue ==600) %>% 
  filter(Strain=="PC-rich_077") %>% 
  filter(Sig<520) 

SolFitsExpFitAll<-rbind(Sol1, Sol2, Sol3, Sol4, Sol5, Sol6, Sol7, Sol8, Sol9, Sol10, Sol11, Sol12, Sol13, Sol14, Sol15, Sol16, Sol17)

rm(Sol1, Sol2, Sol3, Sol4, Sol5, Sol6, Sol7, Sol8, Sol9, Sol10, Sol11, Sol12, Sol13, Sol14, Sol15, Sol16, Sol17)


SolFitsExpFitAll_1<-SolFitsExpFitAll %>%
  filter(Phase == "Exponential") 
SolFitsExpFitAll_2<-SolFitsExpFitAll %>%
  filter(Phase == "Pre-stationary") %>%
  filter(Strain=="PC-rich_056" | Strain=="PC-rich_077") %>%
  filter(Par_ue!=90)
SolFitsExpFitAll_3<-SolFitsExpFitAll %>%
  filter(Phase == "Pre-stationary") %>%
  filter(Strain=="PE-rich_048" | Strain=="PE-rich_127") 

SolFitsExpFitAll<-rbind(SolFitsExpFitAll_1, SolFitsExpFitAll_2, SolFitsExpFitAll_3)

```

# Create plot to check data before and after filtering outliers

```{r checking data before and after filtering outliers}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsExpSt %>% 
  filter(Ex_WL == 590) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = Sig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3",  "goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 

SolFitsExpFitAll %>% 
  filter(Ex_WL == 590) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = Sig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3",  "goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
```

# Fit the data to exponential decays

```{r fit the data to exponential decays, echo=FALSE, warning = FALSE}
SolFitsExpFit590Clean <-SolFitsExpFitAll %>% 
  drop_na(Sig_nm2psii) %>%
  filter(Ex_WL == 590) %>% 
  select(c(Sig_nm2psii, PARPhotonDose_day, Strain, Phase, O2, WL)) 

# Fit the data
fitted590 <- SolFitsExpFit590Clean %>% 
  nest(-c(Strain, Phase, O2, WL)) %>%
  mutate(
    fit = map(data, ~nls(Sig_nm2psii ~ SSasymp(PARPhotonDose_day, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented590 = map(fit, augment))  

# Produce a table of fit parameters: y0, yf, alpha
fitted_Param590<-fitted590 %>% 
  unnest(tidied) %>% 
  select(Strain, Phase, term, estimate) %>% 
pivot_wider(., names_from = c(term), values_from = c(estimate)) %>% 
  mutate(alpha = exp(log_alpha))
```

```{r unnest, preparing df to preparing final plot, echo=FALSE, warning = FALSE}
augmented590<-fitted590  %>%
  unnest(augmented590) %>%
  select(c(Strain, Phase, O2, WL, PARPhotonDose_day,Sig_nm2psii, .fitted)) 
```

# Create Sigma plot at 590

```{r create Sigma plot, fig.height = 8, fig.width = 8, warning = FALSE}
data_text_y0Exp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('y0 = 7.4', 'y0 = 5.9', 'y0 = 8.5', 'y0 = 7.9'))
data_text_yfExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('yf = 3.3', 'yf = 1.9', 'yf = 4.4', 'yf = 3.7'))
data_text_lambdaExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('    \u03BB = 3.6e-07', '    \u03BB = 3.1e-07', '    \u03BB = 2.4e-07', '    \u03BB = 3.3e-07'))

data_text_y0St<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c(' y0 = 20.8', 'y0 = 9.8', 'y0 = 8.8', 'y0 = 9.5'))
data_text_yfSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('yf = 1.7', 'yf = 1.4', 'yf = 3.0', 'yf = 2.3'))
data_text_lambdaSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('    \u03BB = 1.3e-06', '    \u03BB = 5.3e-07', '    \u03BB = 5.5e-07', '    \u03BB = 6.6e-07'))

data_text_AnovaExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, b', ' ANOVA, p < 0.05, ab'))
data_text_AnovaSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, b', ' ANOVA, p < 0.05, bc', 'ANOVA, p < 0.05, d'))

WL.labs <- c("Phase of growth")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsExpFitAll590<-SolFitsExpFitAll %>% 
  filter(Ex_WL==590) 

ggplot(SolFitsExpFitAll590, aes(x = PARPhotonDose_day, y = Sig_nm2psii)) +
  geom_point(aes(x = PARPhotonDose_day, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_point(aes(x = PARPhotonDose_day, y = Sig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, show.legend = F) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue)), width=0, size=0.3, show.legend = F) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "blue", linetype = "solid", size = 0.3, show.legend = F, augmented590) +
  geom_text(data=data_text_y0Exp, aes(x=70000000, y=10, label=label), size=3.5) +
  geom_text(data=data_text_yfExp, aes(x=70000000, y=8.5, label=label), size=3.5) +
  geom_text(data=data_text_lambdaExp, aes(x=70000000, y=7, label=label), size=3.5) +
  
  geom_text(data=data_text_y0St, aes(x=7500000, y=10, label=label), size=3.5) +
  geom_text(data=data_text_yfSt, aes(x=7500000, y=8.5, label=label), size=3.5) +
  geom_text(data=data_text_lambdaSt, aes(x=7500000, y=7, label=label), size=3.5) +
  
  geom_text(data=data_text_AnovaExp, aes(x=15000000, y=0.5, label=label), colour = "blue", size=3.5) +
  geom_text(data=data_text_AnovaSt, aes(x=15000000, y=0.5, label=label), colour = "blue", size=3.5) +
  
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3",  "goldenrod2", "khaki2"), name="", labels = lab2) +
  labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*" quanta"^"-1"*")")), x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 10, by = 2)) +
  coord_cartesian(xlim = c(0, 80000000), ylim = c(0, 11)) +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(WL, Phase), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.9),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_Sigma590",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Calculated Anova and Tukey test from data points

```{r calculated statistics}
SigFit590Stats <-SolFitsExpFitAll %>% 
  filter(Ex_WL == 590) 

SigFit590Stats$Par_ue <- factor(SigFit590Stats$Par_ue)
SigFit590Stats$Photoperiod <- factor(SigFit590Stats$Photoperiod)
SigFit590Stats$Strain <- factor(SigFit590Stats$Strain)
SigFit590Stats$Phase <- factor(SigFit590Stats$Phase)
SigFit590Stats$PARPhotonDose_day <- factor(SigFit590Stats$PARPhotonDose_day)

# Three way Anova with interactions
model<-aov(Sig_nm2psii~PARPhotonDose_day*Phase*Strain, data=SigFit590Stats)
AnovaTest_Sig<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
TukeyHSDTest_Sig<-TukeyHSD(model, which = c("PARPhotonDose_day", "Phase", "Strain"))
```

# Calculated Anova and Tukey test from exponential decay parameters

```{r calculated statistics}
Sig590Stats<-fitted_Param590
Sig590Stats2<-rbind(Sig590Stats, Sig590Stats)
Sig590Stats2$Strain <- factor(Sig590Stats2$Strain)
Sig590Stats2$Phase <- factor(Sig590Stats2$Phase)

# Two-way Anova
model<-aov(y0~Strain*Phase, data=Sig590Stats2)
AnovaTest_Sig590_y0<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
AnovaTest_Sig590_y0$Parameter <- 'y0'

model<-aov(yf~Strain*Phase, data=Sig590Stats2)
AnovaTest_Sig590_yf<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
AnovaTest_Sig590_yf$Parameter <- 'yf'

model<-aov(alpha~Strain*Phase, data=Sig590Stats2)
AnovaTest_Sig590_alpha<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
AnovaTest_Sig590_alpha$Parameter <- 'alpha'

AnovaTest_Sig590_Param<-rbind(AnovaTest_Sig590_y0, AnovaTest_Sig590_yf, AnovaTest_Sig590_alpha)

rm(AnovaTest_Sig590_y0, AnovaTest_Sig590_yf, AnovaTest_Sig590_alpha, Sig590Stats, Sig590Stats2, model)
```

# Exstracting models for each fit

```{r}
fittedmodel<-fitted590  %>%
  select(c(Strain, Phase, fit))
```

# Anova from the model 

```{r}
#1->048 Exp
#2->077 Exp
#3->056 Exp
#4->127 Exp
#5->056 St
#6->077 ST
#7->048 St
#8->127 St

#Comparing model for strains from Exp phase
fittedmodelStrainExp<-fittedmodel
  anova056077Exp<-anova(fittedmodelStrainExp[[3]][[2]], fittedmodelStrainExp[[3]][[3]])
  anova056077Exp$FitComparison <- '056_077'
  anova048127Exp<-anova(fittedmodelStrainExp[[3]][[1]], fittedmodelStrainExp[[3]][[4]])
  anova048127Exp$FitComparison <- '048_127'
  anova056048Exp<-anova(fittedmodelStrainExp[[3]][[1]], fittedmodelStrainExp[[3]][[3]])
  anova056048Exp$FitComparison <- '056_048'
  anova077048Exp<-anova(fittedmodelStrainExp[[3]][[1]], fittedmodelStrainExp[[3]][[2]])
  anova077048Exp$FitComparison <- '077_048'
  anova056127Exp<-anova(fittedmodelStrainExp[[3]][[3]], fittedmodelStrainExp[[3]][[4]])
  anova056127Exp$FitComparison <- '056_127'
  anova077127Exp<-anova(fittedmodelStrainExp[[3]][[2]], fittedmodelStrainExp[[3]][[4]])
  anova077127Exp$FitComparison <- '077_127'
  anova_SigModelStrainExp<-rbind(anova056077Exp, anova048127Exp, anova056048Exp, anova077048Exp, anova056127Exp, anova077127Exp)
  anova_SigModelStrainExp <-anova_SigModelStrainExp %>% 
  drop_na(Df) 
  rm(anova056077Exp, anova048127Exp, anova056048Exp, anova077048Exp, anova056127Exp, anova077127Exp)

#Comparing model for strains from St phase
fittedmodelStrainSt<-fittedmodel 
  anova056077St<-anova(fittedmodelStrainSt[[3]][[5]], fittedmodelStrainSt[[3]][[6]])
  anova056077St$FitComparison <- '056_077'
  anova048127St<-anova(fittedmodelStrainSt[[3]][[7]], fittedmodelStrainSt[[3]][[8]])
  anova048127St$FitComparison <- '048_127'
  anova056048St<-anova(fittedmodelStrainSt[[3]][[5]], fittedmodelStrainSt[[3]][[7]])
  anova056048St$FitComparison <- '056_048'
  anova077048St<-anova(fittedmodelStrainSt[[3]][[6]], fittedmodelStrainSt[[3]][[7]])
  anova077048St$FitComparison <- '077_048'
  anova056127St<-anova(fittedmodelStrainSt[[3]][[5]], fittedmodelStrainSt[[3]][[8]])
  anova056127St$FitComparison <- '056_127'
  anova077127St<-anova(fittedmodelStrainSt[[3]][[6]], fittedmodelStrainSt[[3]][[8]])
  anova077127St$FitComparison <- '077_127'
  anova_SigModelStrainSt<-rbind(anova056077St, anova048127St, anova056048St, anova077048St, anova056127St, anova077127St)
  anova_SigModelStrainSt <-anova_SigModelStrainSt %>% 
  drop_na(Df) 
  
  rm(anova056077St, anova048127St, anova056048St, anova077048St, anova056127St, anova077127St)
  
  
#Comparing model for each strains from different phase (Exp vs St)
fittedmodelPhase<-fittedmodel 
  anova056ExpSt<-anova(fittedmodelPhase[[3]][[3]], fittedmodelPhase[[3]][[5]])
  anova056ExpSt$FitComparison <- '056_Exp_St'
  anova077ExpSt<-anova(fittedmodelPhase[[3]][[2]], fittedmodelPhase[[3]][[6]])
  anova077ExpSt$FitComparison <- '077_Exp_St'
  anova048ExpSt<-anova(fittedmodelPhase[[3]][[1]], fittedmodelPhase[[3]][[7]])
  anova048ExpSt$FitComparison <- '048_Exp_St'
  anova127ExpSt<-anova(fittedmodelPhase[[3]][[4]], fittedmodelPhase[[3]][[8]])
  anova127ExpSt$FitComparison <- '127_Exp_St'
  anova_SigModelPhase<-rbind(anova056ExpSt, anova077ExpSt, anova048ExpSt, anova127ExpSt)
  anova_SigModelPhase <-anova_SigModelPhase %>% 
  drop_na(Df) 
  
  rm(anova056ExpSt, anova077ExpSt, anova048ExpSt, anova127ExpSt)
```

# Save RDS that create stats and tables

```{r}
# saveRDS(AnovaTest_Sig590_Param, file.path(RDSTablePath, paste(Project, "Sig590_Anova.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

# saveRDS(TukeyHSDTest_y0_alpha, file.path(RDSTablePath, paste(Project, "GSTukey_y0.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Removed unneccessary df from the environment

```{r}
rm(SolFitsExpFit590Clean, fitted_Param590, data_text_lambdaExp, data_text_y0Exp, data_text_yfExp, data_text_lambdaSt, data_text_y0St, data_text_yfSt, data_text_AnovaExp, data_text_AnovaSt, fitted590, fittedmodel, fittedmodelPhase, fittedmodelStrainExp, fittedmodelStrainSt, SigFit590Stats, SolFitsExpFitAll590, SolFitsExpFitAll_1, SolFitsExpFitAll_2, SolFitsExpFitAll_3, augmented590)
```

```{r}
SolFitsExpFit445Clean <-SolFitsExpFitAll %>% 
  drop_na(Sig_nm2psii) %>%
  filter(Ex_WL == 445) %>% 
  select(c(Sig_nm2psii, PARPhotonDose_day, Strain, Phase, O2, WL)) 

# Fit the data
fitted445 <- SolFitsExpFit445Clean %>% 
  nest(-c(Strain, Phase, O2, WL)) %>%
  mutate(Linear_Model = map(data, ~lm(Sig_nm2psii ~ PARPhotonDose_day, data = .))) %>% 
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))   

augmented445<-fitted445 %>% 
  unnest(Linear_Model_Predict) %>% 
  select(c(Strain, Phase, O2, WL, PARPhotonDose_day,Sig_nm2psii, .fitted)) 
```

# Create Sigma plot at 445

```{r create Sigma plot, fig.height = 8, fig.width = 8, warning = FALSE}

WL.labs <- c("Phase of growth")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsExpFitAll445<-SolFitsExpFitAll %>% 
  filter(Ex_WL==445) 

ggplot(SolFitsExpFitAll445, aes(x = PARPhotonDose_day, y = Sig_nm2psii)) +
  geom_point(aes(x = PARPhotonDose_day, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_point(aes(x = PARPhotonDose_day, y = Sig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, show.legend = F) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue)), width=0, size=0.3, show.legend = F) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "blue", linetype = "solid", size = 0.3, show.legend = F, augmented445) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3",  "goldenrod2", "khaki2"), name="", labels = lab2) +
  labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*" quanta"^"-1"*")")), x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 10, by = 2)) +
  coord_cartesian(xlim = c(0, 80000000), ylim = c(0, 10)) +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(WL, Phase), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.93,0.9),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_Sigma445",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Exstracting models for each fit

```{r}
fittedmodel445<-fitted445  %>%
  select(c(Strain, Phase, Linear_Model))
```

# Anova from the model - doesnt work for linear models "models were not all fitted to the same size of dataset"

```{r}
# #1->056 Exp
# #2->077 Exp
# #3->048 Exp
# #4->127 Exp
# #5->056 St
# #6->077 ST
# #7->048 St
# #8->127 St
# 
# #Comparing model for strains from Exp phase
# fittedmodelStrainExp<-fittedmodel445
#   anova056077Exp<-anova(fittedmodelStrainExp[[3]][[1]], fittedmodelStrainExp[[3]][[2]])
#   anova056077Exp$FitComparison <- '056_077'
#   anova048127Exp<-anova(fittedmodelStrainExp[[3]][[3]], fittedmodelStrainExp[[3]][[4]])
#   anova048127Exp$FitComparison <- '048_127'
#   anova056048Exp<-anova(fittedmodelStrainExp[[3]][[1]], fittedmodelStrainExp[[3]][[3]])
#   anova056048Exp$FitComparison <- '056_048'
#   anova077048Exp<-anova(fittedmodelStrainExp[[3]][[2]], fittedmodelStrainExp[[3]][[3]])
#   anova077048Exp$FitComparison <- '077_048'
#   anova056127Exp<-anova(fittedmodelStrainExp[[3]][[1]], fittedmodelStrainExp[[3]][[4]])
#   anova056127Exp$FitComparison <- '056_127'
#   anova077127Exp<-anova(fittedmodelStrainExp[[3]][[2]], fittedmodelStrainExp[[3]][[4]])
#   anova077127Exp$FitComparison <- '077_127'
#   anovaStrainExp445<-rbind(anova056077Exp, anova048127Exp, anova056048Exp, anova077048Exp, anova056127Exp, anova077127Exp)
#   anovaStrainExp445 <-anovaStrainExp445 %>% 
#   drop_na(Df) 
#   rm(anova056077Exp, anova048127Exp, anova056048Exp, anova077048Exp, anova056127Exp, anova077127Exp)
# 


```


# Save RDS that create plot

```{r}
# saveRDS(SolFitsExpFitAll, file.path(FigRdsPath, paste(Project, "Fig_Sigma_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
# 
# saveRDS(augmented590, file.path(FigRdsPath, paste(Project, "Fig_Sigma_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
# 
# saveRDS(fitted_Param590, file.path(FigRdsPath, paste(Project, "Fig_Sigma_3.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Removed unneccessary df from the environment

```{r}
# rm(SolFitsExpFit590Clean, fitted_Param590, data_text_lambdaExp, data_text_y0Exp, data_text_yfExp, data_text_lambdaSt, data_text_y0St, data_text_yfSt, data_text_AnovaExp, data_text_AnovaSt, fitted590, fittedmodel, fittedmodelPhase, fittedmodelStrainExp, fittedmodelStrainSt, SigFit590Stats, SolFitsExpFitAll590, SolFitsExpFitAll_1, SolFitsExpFitAll_2, SolFitsExpFitAll_3, augmented590)
```

# Removed unneccessary df from the environment

```{r}
rm(fitted445, fittedmodel445, SolFitsExpFit445Clean, SolFitsExpFitAll445, augmented445)
```

# Sig per phyco/chla ratio

Issue - not always pigment based on Olis correspond to Solisense data-> I choose the time (range) that pigments correspond to Sig measurements (for exp and st phase separately). Then I made a mean for pigments.

```{r set project variables}
Project <- "BalticPhotoperiod"
DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedPigmentsData", fsep = .Platform$file.sep)
```

```{r Exported Rmd}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read pigments File}
#df ontained mean OD per day from Multiculti and Abs from Olis spectra for selected nm. Based on this I calculated pigments per mL and per cell (pg/cell)

MCPigmentAllFile <- "../Data/ProcessedData/ProcessedPigmentsData/BalticPhotoperiod_Processed_PigmentsAll.Rds"
MCPigmentAllFileName <- str_split(string = MCPigmentAllFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MCPigmentAll <- readRDS(MCPigmentAllFile)  %>%
  ungroup()
```

```{r}
MCPigmentAll <- MCPigmentAll %>% 
  filter(ToD==10) # When I choose 12 (peak) then I loose a few data point from 12h and 900UE
```


# Altrough MCPigmentAll already contain Exp and St phase, I took exactly the same parameters (settings) like Sig, b/c MCPigmentAll do not contain information on 600 uE. And for one case I took date from very early st phase.

# Choose only exp data

```{r choose only exp data}
O1 <- MCPigmentAll %>%
  filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
  filter(Photoperiod == 24) %>%
  filter(E_days <= 4)

O2 <- MCPigmentAll %>%
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days < 9)

O3 <- MCPigmentAll %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days <= 4)

O4 <- MCPigmentAll %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days <= 14)

O5 <- MCPigmentAll %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 8 | Photoperiod == 12) %>%
  filter(E_days <=14)

O6 <- MCPigmentAll %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 8) %>%
  filter(E_days <=14)

O7 <- MCPigmentAll %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 12) %>%
  filter(E_days <=10)

O8 <- MCPigmentAll %>%
  filter(Par_ue == 180 | Par_ue == 300) %>%
  filter(Photoperiod == 8 | Photoperiod == 12) %>%
  filter(E_days <=10)

O9 <- MCPigmentAll %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 8 | Photoperiod == 12) %>%
  filter(E_days <=7)

O10 <- MCPigmentAll %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 24) %>%
  filter(E_days <= 8)

MCPigmentAllExp <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10)
```

# Choose only Stationary data 

```{r choose only St data}
O1 <- MCPigmentAll %>%
  filter(Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 600 | Par_ue == 900) %>%
  filter(Photoperiod == 24) %>%
  filter(E_days > 4)

O2 <- MCPigmentAll %>%
  filter(Par_ue == 30) %>%
  filter(Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >14)

O3 <- MCPigmentAll %>%
  filter(Par_ue == 90) %>%
  filter(Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >10)

O4 <- MCPigmentAll %>%
  filter(Par_ue == 180 | Par_ue == 300) %>%
  filter(Photoperiod == 8 | Photoperiod == 12 | Photoperiod == 16) %>%
  filter(E_days >10)

O5 <- MCPigmentAll %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 16) %>%
  filter(E_days >=6)

O6 <- MCPigmentAll %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 12) %>%
  filter(E_days >=4)

O6 <- MCPigmentAll %>%
  filter(Par_ue == 900 | Par_ue == 600) %>%
  filter(Photoperiod == 8) %>%
  filter(E_days >7)

MCPigmentAllSt <-rbind(O1, O2, O3, O4, O5, O6)

rm(O1, O2, O3, O4, O5, O6)
```

# Combine Exp and St data

```{r}
MCPigmentAllExp<-MCPigmentAllExp %>%
  select(-c(Phase)) # Removed previous Phase b/c do not contained 600uE data

MCPigmentAllSt<-MCPigmentAllSt %>%
  select(-c(Phase)) # Removed previous Phase b/c do not contained 600uE data

  MCPigmentAllExp$Phase <- 'Exponential'
  MCPigmentAllSt$Phase <- 'Pre-stationary'

  MCPigmentAllExpSt <-rbind(MCPigmentAllExp, MCPigmentAllSt)
```

# Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

MCPigmentAll %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = PhycoChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

MCPigmentAllExp %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = PhycoChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

MCPigmentAllSt %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = PhycoChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```

# Not always E_days from Sig and Phyco/Chla ratio matches. Thus, I took only pigments from the range of days when Sig was measured. Later I made a mean from the pigment value taken from choosem pig value

# Choose only pigment data when Sig was measured (time range)

```{r choose pigment data when Sig was measured}
O2 <- MCPigmentAllExpSt %>%
  filter(Phase == "Exponential") %>% 
  filter(Photoperiod == 24)
O3 <- MCPigmentAllExpSt %>%
  filter(Phase == "Exponential") %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days>5)
O4 <- MCPigmentAllExpSt %>%
  filter(Phase == "Exponential") %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days>3)
O5 <- MCPigmentAllExpSt %>%
  filter(Phase == "Exponential") %>% 
  filter(Photoperiod == 16) %>% 
  filter(Par_ue == 30 | Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  filter(E_days>5)
O6 <- MCPigmentAllExpSt %>%
  filter(Phase == "Exponential") %>% 
  filter(Photoperiod == 16) %>% 
  filter(Par_ue == 600 | Par_ue == 900)

MCPigmentAllExpStChoosen_1 <-rbind(O2, O3, O4, O5, O6)

O7 <- MCPigmentAllExpStChoosen_1 %>% 
  filter(Phase == "Exponential") %>% 
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(E_days<=8)
O8 <- MCPigmentAllExpStChoosen_1 %>% 
  filter(Phase == "Exponential") %>% 
  filter(Par_ue == 30 | Par_ue == 90 | Par_ue == 600 | Par_ue == 900) 
  #filter(E_days<=8)
O1 <- MCPigmentAllExpSt %>%
  filter(Phase == "Pre-stationary")

MCPigmentAllExpStChoosen <-rbind(O1, O7, O8)

rm(O1, O2, O3, O4, O5, O6, O7, O8, MCPigmentAllExpStChoosen_1)
```

# Filter lag or very early exp phase and unrevelant value

```{r}
MCPigmentAllExpStChoosen<-MCPigmentAllExpStChoosen %>% 
  filter(E_days >1) 
```

# Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

MCPigmentAllExpStChoosen %>%
  filter(Phase == "Exponential") %>% 
  ggplot() +
  geom_point(aes(x = Time_h, y = PhycoChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

MCPigmentAllExpStChoosen %>%
  filter(Phase == "Pre-stationary") %>% 
  ggplot() +
  geom_point(aes(x = Time_h, y = PhycoChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```

```{r}
rm(tmaxAG, tMaxAGLines_056, tMaxAGLines_077, tMaxAGLines_048, tMaxAGLines_127, MCPigmentAllSt, MCPigmentAllExp)
```

#Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

MCPigmentAllExpSt %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = PhycoChlaRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab3) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 

MCPigmentAllExpStChoosen %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = PhycoChlaRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab3) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


MCPigmentAllExpSt %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = PURPARRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab3) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 

MCPigmentAllExpStChoosen %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = PURPARRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab3) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
```
# Make "one big - All" mean to combine all days (divided by Exp and St) and all replica when samples were measured 
(This give me only one value of Phyco/Chla ratio JVPSII plot and sig plot as well)

# Calculate one "big" mean from Phyco/Chla ratio from all data measured on Exp or St phase 
# AllmeanPhycoChlaRatio contains 1-7 measurements (different days)

```{r calculate Sigma mean from exp phase}
#E_days, Time_h, caused problem

MCPigmentAllExpStChoosen<-MCPigmentAllExpStChoosen %>%
  group_by(Strain, Par_ue, Photoperiod, WL, O2, Phase) %>%

  summarize(SampleID, ToD, Run, Strain, ExpDate, FilenameMC, Tube, Par_ue, Photoperiod, O2, WL, MC, LightShape, ExpEndDate, meanActinic_par_h, meanOD680_h, meanOD720_h, meanDeltaOD_h, facetsPar_ue, facetsPhotoperiod, cellmL_OD680, PARPhotonDose_day, ObsDateOlis, PUR, PURPhotonDose_day, ChlaugmL, CarugmL, PEugmL, PCugmL, APCugmL, Chlapgcell, Carpgcell, PEpgcell, PCpgcell, APCpgcell, Phycopgcell, CarChlaRatio, PhycoChlaRatio, PEPCRatio, cellL_OD680, tMaxAG, AchivePreStationary, MaxDG, MaxAG, Max_deriv, dayRound_tmaxAG, facetsStrain, facetsPARPhotonDose_day, PURPARRatio, Phase,

            AllmeanPhycoChlaRatio = mean(PhycoChlaRatio),
            AllsdPhycoChlaRatio = sd(PhycoChlaRatio),
            AllmeanPURPARRatio = mean(PURPARRatio),
            AllsdPURPARRatio = sd(PURPARRatio)) %>%
  ungroup()
```

```{r calculate Sigma mean from exp phase}
#E_days, Time_h, caused problem

# MCPigmentAllExpSt<-MCPigmentAllExpSt %>%
#   group_by(Strain, Par_ue, Photoperiod, WL, O2, Phase) %>%
# 
#   summarize(SampleID, ToD, Run, Strain, ExpDate, FilenameMC, Tube, Par_ue, Photoperiod, O2, WL, MC, LightShape, ExpEndDate, meanActinic_par_h, meanOD680_h, meanOD720_h, meanDeltaOD_h, facetsPar_ue, facetsPhotoperiod, cellmL_OD680, PARPhotonDose_day, ObsDateOlis, PUR, PURPhotonDose_day, ChlaugmL, CarugmL, PEugmL, PCugmL, APCugmL, Chlapgcell, Carpgcell, PEpgcell, PCpgcell, APCpgcell, Phycopgcell, CarChlaRatio, PhycoChlaRatio, PEPCRatio, cellL_OD680, tMaxAG, AchivePreStationary, MaxDG, MaxAG, Max_deriv, dayRound_tmaxAG, facetsStrain, facetsPARPhotonDose_day, PURPARRatio, Phase,
# 
#             AllmeanPhycoChlaRatio = mean(PhycoChlaRatio),
#             AllsdPhycoChlaRatio = sd(PhycoChlaRatio),
#             AllmeanPURPARRatio = mean(PURPARRatio),
#             AllsdPURPARRatio = sd(PURPARRatio)) %>%
#   ungroup()
```


# Filter outliers - few data points

```{r}

S1<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127") #keep all

S2<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_056") %>% 
  filter(Phase == "Exponential") %>% 
  filter(Par_ue == 30 | Par_ue == 90) %>% 
  filter(PhycoChlaRatio>0.5) 
S3<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_056") %>% 
  filter(Phase == "Exponential") %>% 
  filter(Par_ue == 180 | Par_ue == 300 | Par_ue == 600 | Par_ue == 900) 
S4<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_056") %>% 
  filter(Phase == "Pre-stationary") %>% 
  filter(Par_ue == 30 | Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  filter(PhycoChlaRatio<3)
S5<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_056") %>% 
  filter(Phase == "Pre-stationary") %>% 
  filter(Par_ue == 600 | Par_ue == 900) %>% 
  filter(PhycoChlaRatio<1.8)


S6<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_077") %>% 
  filter(Phase == "Exponential") %>% 
  filter(Par_ue == 30 | Par_ue == 90) %>% 
  filter(PhycoChlaRatio>1.0)
S7<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_077") %>% 
  filter(Phase == "Exponential") %>% 
  filter(Par_ue == 180 | Par_ue == 300 | Par_ue == 600 | Par_ue == 900) 
S8<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_077") %>% 
  filter(Phase == "Pre-stationary") %>% 
  filter(Par_ue == 30 | Par_ue == 90 | Par_ue == 180 | Par_ue == 300) 
S9<-MCPigmentAllExpStChoosen %>%
  filter(Strain == "PC-rich_077") %>% 
  filter(Phase == "Pre-stationary") %>% 
  filter(Par_ue == 600 | Par_ue == 900) %>% 
  filter(PhycoChlaRatio<1.3)

PhycoChlaRatioChoosen<-rbind(S1, S2, S3, S4, S5, S6, S7, S8, S9)

rm(S1, S2, S3, S4, S5, S6, S7, S8, S9)
```



# Fit the data to exponential decays - Phyco/Chla ratio

```{r fit the data to exponential decays, echo=FALSE, warning = FALSE}
SolFitsExpFit590CleanPig <-PhycoChlaRatioChoosen %>% 
  drop_na(PhycoChlaRatio) %>%
  select(c(PhycoChlaRatio, PARPhotonDose_day, Strain, Phase, O2, WL)) 

# Fit the data
fitted590Pig <- SolFitsExpFit590CleanPig %>% 
  nest(-c(Strain, Phase, O2, WL)) %>%
  mutate(
    fit = map(data, ~nls(PhycoChlaRatio ~ SSasymp(PARPhotonDose_day, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented590 = map(fit, augment))  

# Produce a table of fit parameters: y0, yf, alpha
fitted_Param590Pig<-fitted590Pig %>% 
  unnest(tidied) %>% 
  select(Strain, Phase, term, estimate) %>% 
pivot_wider(., names_from = c(term), values_from = c(estimate)) %>% 
  mutate(alpha = exp(log_alpha))
```

```{r unnest, preparing df to preparing final plot, echo=FALSE, warning = FALSE}
augmented590Pig<-fitted590Pig  %>%
  unnest(augmented590) %>%
  select(c(Strain, Phase, O2, WL, PARPhotonDose_day, PhycoChlaRatio, .fitted)) 
```

# Create Phyco/Chla ratio plot at 590

```{r create Sigma plot, fig.height = 8, fig.width = 8, warning = FALSE}
data_text_y0Exp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('y0 = 2.2', 'y0 = 3.1', 'y0 = 4.1', 'y0 = 3.9'))
data_text_yfExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('yf = 0.2', 'yf = -0.3', 'yf = -0.3', 'yf = 0.2'))
data_text_lambdaExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('    \u03BB = 5.9e-08', '    \u03BB = 2.8e-08', '    \u03BB = 2.6e-08', '    \u03BB = 4.2e-08'))

data_text_y0St<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('y0 = 7.2', ' y0 = 10.8', 'y0 = 3.0', 'y0 = 2.9'))
data_text_yfSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('yf = 0.6', 'yf = 0.8', 'yf = -0.4', 'yf = -0.2'))
data_text_lambdaSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('    \u03BB = 9.3e-07', '    \u03BB = 7.0e-07', '    \u03BB = 2.9e-08', '    \u03BB = 2.4e-08'))

data_text_AnovaExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, b', 'ANOVA, p < 0.05, b', 'ANOVA, p < 0.05, c'))
data_text_AnovaSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, a'))

WL.labs <- c("Phase of growth")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))


ggplot(PhycoChlaRatioChoosen, aes(x = PARPhotonDose_day, y = PhycoChlaRatio)) +
  geom_point(aes(x = PARPhotonDose_day, y = AllmeanPhycoChlaRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_point(aes(x = PARPhotonDose_day, y = PhycoChlaRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, show.legend = F) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = AllmeanPhycoChlaRatio - AllsdPhycoChlaRatio, ymax = AllmeanPhycoChlaRatio + AllsdPhycoChlaRatio, colour=as.factor(Par_ue)), width=0, size=0.3, show.legend = F) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "blue", linetype = "solid", size = 0.3, show.legend = F, augmented590Pig) +
  geom_text(data=data_text_y0Exp, aes(x=70000000, y=8, label=label), size=3.5) +
  geom_text(data=data_text_yfExp, aes(x=70000000, y=6.5, label=label), size=3.5) +
  geom_text(data=data_text_lambdaExp, aes(x=70000000, y=5, label=label), size=3.5) +
  
  geom_text(data=data_text_y0St, aes(x=7500000, y=8, label=label), size=3.5) +
  geom_text(data=data_text_yfSt, aes(x=7500000, y=6.5, label=label), size=3.5) +
  geom_text(data=data_text_lambdaSt, aes(x=7500000, y=5, label=label), size=3.5) +
  
  geom_text(data=data_text_AnovaExp, aes(x=15000000, y=-0.5, label=label), colour = "blue", size=3.5) +
  geom_text(data=data_text_AnovaSt, aes(x=15000000, y=-0.5, label=label), colour = "blue", size=3.5) +
  
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3",  "goldenrod2", "khaki2"), name="", labels = lab2) +
  labs(y="Total phyco/Chl" ~italic(a)~ "ratio", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(xlim = c(0, 80000000), ylim = c(-1.2, 9)) +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(WL, Phase), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.9),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_PhycoChlaRatio2",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```


# Calculated Anova and Tukey test from data points

```{r calculated statistics}
StatsPig <-PhycoChlaRatioChoosen 

StatsPig$Par_ue <- factor(StatsPig$Par_ue)
StatsPig$Photoperiod <- factor(StatsPig$Photoperiod)
StatsPig$Strain <- factor(StatsPig$Strain)
StatsPig$Phase <- factor(StatsPig$Phase)
StatsPig$PARPhotonDose_day <- factor(StatsPig$PARPhotonDose_day)

# Three way Anova with interactions
model<-aov(PhycoChlaRatio~PARPhotonDose_day*Phase*Strain, data=StatsPig)
AnovaTest_PhycoChlaRatio<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
TukeyHSDTest_PhycoChlaRatio<-TukeyHSD(model, which = c("PARPhotonDose_day", "Phase", "Strain"))

rm(model, StatsPig)
```

# Calculated Anova and Tukey test from exponential decay parameters

```{r calculated statistics}
StatsPigParam<-fitted_Param590Pig
StatsPigParam<-rbind(StatsPigParam, StatsPigParam)
StatsPigParam$Strain <- factor(StatsPigParam$Strain)
StatsPigParam$Phase <- factor(StatsPigParam$Phase)

# Two-way Anova
model<-aov(y0~Strain*Phase, data=StatsPigParam)
AnovaTest_PhycoChlaRatio_y0<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
AnovaTest_PhycoChlaRatio_y0$Parameter <- 'y0'

model<-aov(yf~Strain*Phase, data=StatsPigParam)
AnovaTest_PhycoChlaRatio_yf<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
AnovaTest_PhycoChlaRatio_yf$Parameter <- 'yf'

model<-aov(alpha~Strain*Phase, data=StatsPigParam)
AnovaTest_PhycoChlaRatio_alpha<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
AnovaTest_PhycoChlaRatio_alpha$Parameter <- 'alpha'

AnovaTest_PhycoChlaRatio_Param<-rbind(AnovaTest_PhycoChlaRatio_y0, AnovaTest_PhycoChlaRatio_yf, AnovaTest_PhycoChlaRatio_alpha)

rm(AnovaTest_PhycoChlaRatio_y0, AnovaTest_PhycoChlaRatio_yf, AnovaTest_PhycoChlaRatio_alpha, model, StatsPigParam)
```

# Exstracting models for each fit

```{r}
fittedmodelPig<-fitted590Pig  %>%
  select(c(Strain, Phase, fit))
```

# Anova from the model 

```{r}
#1->048 Exp
#2->048 St
#3->127 Exp
#4->127 St
#5->056 Exp
#6->056 St
#7->077 Exp
#8->077 St


#Comparing model for strains from Exp phase
fittedmodelStrainExp<-fittedmodelPig
  anova056077Exp<-anova(fittedmodelStrainExp[[3]][[5]], fittedmodelStrainExp[[3]][[7]])
  anova056077Exp$FitComparison <- '056_077'
  anova048127Exp<-anova(fittedmodelStrainExp[[3]][[1]], fittedmodelStrainExp[[3]][[3]])
  anova048127Exp$FitComparison <- '048_127'
  anova056048Exp<-anova(fittedmodelStrainExp[[3]][[5]], fittedmodelStrainExp[[3]][[1]])
  anova056048Exp$FitComparison <- '056_048'
  anova077048Exp<-anova(fittedmodelStrainExp[[3]][[7]], fittedmodelStrainExp[[3]][[1]])
  anova077048Exp$FitComparison <- '077_048'
  anova056127Exp<-anova(fittedmodelStrainExp[[3]][[5]], fittedmodelStrainExp[[3]][[3]])
  anova056127Exp$FitComparison <- '056_127'
  anova077127Exp<-anova(fittedmodelStrainExp[[3]][[7]], fittedmodelStrainExp[[3]][[3]])
  anova077127Exp$FitComparison <- '077_127'
  anova_PhycoChlaRatioModelStrainExp<-rbind(anova056077Exp, anova048127Exp, anova056048Exp, anova077048Exp, anova056127Exp, anova077127Exp)
  anova_PhycoChlaRatioModelStrainExp <-anova_PhycoChlaRatioModelStrainExp %>% 
  drop_na(Df) 
  rm(anova056077Exp, anova048127Exp, anova056048Exp, anova077048Exp, anova056127Exp, anova077127Exp)

#Comparing model for strains from St phase
fittedmodelStrainSt<-fittedmodelPig 
  anova056077St<-anova(fittedmodelStrainSt[[3]][[6]], fittedmodelStrainSt[[3]][[8]])
  anova056077St$FitComparison <- '056_077'
  anova048127St<-anova(fittedmodelStrainSt[[3]][[2]], fittedmodelStrainSt[[3]][[4]])
  anova048127St$FitComparison <- '048_127'
  anova056048St<-anova(fittedmodelStrainSt[[3]][[6]], fittedmodelStrainSt[[3]][[2]])
  anova056048St$FitComparison <- '056_048'
  anova077048St<-anova(fittedmodelStrainSt[[3]][[8]], fittedmodelStrainSt[[3]][[2]])
  anova077048St$FitComparison <- '077_048'
  anova056127St<-anova(fittedmodelStrainSt[[3]][[6]], fittedmodelStrainSt[[3]][[4]])
  anova056127St$FitComparison <- '056_127'
  anova077127St<-anova(fittedmodelStrainSt[[3]][[8]], fittedmodelStrainSt[[3]][[4]])
  anova077127St$FitComparison <- '077_127'
  anova_PhycoChlaRatioModelStrainSt<-rbind(anova056077St, anova048127St, anova056048St, anova077048St, anova056127St, anova077127St)
  anova_PhycoChlaRatioModelStrainSt <-anova_PhycoChlaRatioModelStrainSt %>% 
  drop_na(Df) 
  
  rm(anova056077St, anova048127St, anova056048St, anova077048St, anova056127St, anova077127St)
  
  
#Comparing model for each strains from different phase (Exp vs St)
fittedmodelPhase<-fittedmodelPig 
  anova056ExpSt<-anova(fittedmodelPhase[[3]][[5]], fittedmodelPhase[[3]][[6]])
  anova056ExpSt$FitComparison <- '056_Exp_St'
  anova077ExpSt<-anova(fittedmodelPhase[[3]][[7]], fittedmodelPhase[[3]][[8]])
  anova077ExpSt$FitComparison <- '077_Exp_St'
  anova048ExpSt<-anova(fittedmodelPhase[[3]][[1]], fittedmodelPhase[[3]][[2]])
  anova048ExpSt$FitComparison <- '048_Exp_St'
  anova127ExpSt<-anova(fittedmodelPhase[[3]][[3]], fittedmodelPhase[[3]][[4]])
  anova127ExpSt$FitComparison <- '127_Exp_St'
  anova_PhycoChlaRatioModelPhase<-rbind(anova056ExpSt, anova077ExpSt, anova048ExpSt, anova127ExpSt)
  anova_PhycoChlaRatioModelPhase <-anova_PhycoChlaRatioModelPhase %>% 
  drop_na(Df) 
  
  rm(anova056ExpSt, anova077ExpSt, anova048ExpSt, anova127ExpSt)
```

# Save RDS that create stats and tables

```{r}
# saveRDS(AnovaTest_Sig590_Param, file.path(RDSTablePath, paste(Project, "Sig590_Anova.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

# saveRDS(TukeyHSDTest_y0_alpha, file.path(RDSTablePath, paste(Project, "GSTukey_y0.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Removed unneccessary df from the environment

```{r}
# rm(SolFitsExpFit590Clean, fitted_Param590, data_text_lambdaExp, data_text_y0Exp, data_text_yfExp, data_text_lambdaSt, data_text_y0St, data_text_yfSt, data_text_AnovaExp, data_text_AnovaSt, fitted590, fittedmodel, fittedmodelPhase, fittedmodelStrainExp, fittedmodelStrainSt, SigFit590Stats, SolFitsExpFitAll590, SolFitsExpFitAll_1, SolFitsExpFitAll_2, SolFitsExpFitAll_3, augmented590)
```

# Preliminary plot PUR/PAR ratio 

```{r}
SS %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = PURPARRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab3) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
```



# Filter outliers - few data points for PURPAR ratio

```{r}
S1<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(PURPARRatio>0.356)
S2<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain == "PE-rich_048") %>% 
  filter(PARPhotonDose_day<40000000)

S3<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain == "PC-rich_077") %>% 
  filter(PARPhotonDose_day<20000000) %>% 
  filter(PURPARRatio>0.35)

S4<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain == "PC-rich_077") %>% 
  filter(PARPhotonDose_day>20000000) %>% 
  filter(PURPARRatio<0.3)
S5<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Pre-stationary") %>% 
  filter(Strain == "PE-rich_127") %>% 
  filter(PARPhotonDose_day<70000000) %>% 
  filter(PURPARRatio<0.56) %>% 
  filter(PURPARRatio>0.44)
S6<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Exponential") %>% 
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127") %>% 
  filter(PARPhotonDose_day>20000000) %>% 
  filter(PURPARRatio<0.6)
S7<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Exponential") %>% 
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127") %>% 
  filter(PARPhotonDose_day<20000000) %>% 
  filter(PURPARRatio>0.4)
S8<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Exponential") %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(PARPhotonDose_day>10000000) %>% 
  filter(PURPARRatio<0.49)
S9<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Exponential") %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(PARPhotonDose_day<10000000)  
S10<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Exponential") %>% 
  filter(Strain == "PC-rich_077") %>% 
  filter(PARPhotonDose_day>10000000) %>% 
  filter(PURPARRatio<0.49) %>% 
  filter(PURPARRatio>0.3)
S11<-MCPigmentAllExpStChoosen %>%
  filter(Phase == "Exponential") %>% 
  filter(Strain == "PC-rich_077") %>% 
  filter(PARPhotonDose_day<10000000) %>% 
  filter(PURPARRatio>0.41)
  
PhycoChlaRatioChoosenPUR<-rbind(S1, S2, S3, S4, S5, S6, S7, S8, S9, S10, S11)

rm(S1, S2, S3, S4, S5, S6, S7, S8, S9, S10, S11)
```


# Fit the data to exponential decays - PURPARRatio

```{r fit the data to exponential decays, echo=FALSE, warning = FALSE}
SolFitsExpFit590CleanPUR <-PhycoChlaRatioChoosenPUR %>% 
  drop_na(PURPARRatio) %>%
  #filter(Phase == "Pre-stationary") %>% 
  #filter(Strain == "PC-rich_077") %>% 
  select(c(PURPARRatio, PARPhotonDose_day, Strain, Phase, O2, WL)) 

# Fit the data
fitted590PUR <- SolFitsExpFit590CleanPUR %>% 
  nest(-c(Strain, Phase, O2, WL)) %>%
  mutate(
    fit = map(data, ~nls(PURPARRatio ~ SSasymp(PARPhotonDose_day, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented590 = map(fit, augment))  

# Produce a table of fit parameters: y0, yf, alpha
fitted_Param590PUR<-fitted590PUR %>% 
  unnest(tidied) %>% 
  select(Strain, Phase, term, estimate) %>% 
pivot_wider(., names_from = c(term), values_from = c(estimate)) %>% 
  mutate(alpha = exp(log_alpha))
```



```{r unnest, preparing df to preparing final plot, echo=FALSE, warning = FALSE}
augmented590PUR<-fitted590PUR  %>%
  unnest(augmented590) %>%
  select(c(Strain, Phase, O2, WL, PARPhotonDose_day,PURPARRatio, .fitted)) 
```

# Create PUR/PAR ratio plot 

```{r create Sigma plot, fig.height = 8, fig.width = 8, warning = FALSE}
data_text_y0Exp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('y0 = 2.2', 'y0 = 3.1', 'y0 = 4.1', 'y0 = 3.9'))
data_text_yfExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('yf = 0.2', 'yf = -0.3', 'yf = -0.3', 'yf = 0.2'))
data_text_lambdaExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('    \u03BB = 5.9e-08', '    \u03BB = 2.8e-08', '    \u03BB = 2.6e-08', '    \u03BB = 4.2e-08'))

data_text_y0St<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('y0 = 7.2', ' y0 = 10.8', 'y0 = 3.0', 'y0 = 2.9'))
data_text_yfSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('yf = 0.6', 'yf = 0.8', 'yf = -0.4', 'yf = -0.2'))
data_text_lambdaSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('    \u03BB = 9.3e-07', '    \u03BB = 7.0e-07', '    \u03BB = 2.9e-08', '    \u03BB = 2.4e-08'))

data_text_AnovaExp<- data.frame(WL = c("WW", "WW"), Phase = c("Exponential"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, b', 'ANOVA, p < 0.05, b', 'ANOVA, p < 0.05, c'))
data_text_AnovaSt<- data.frame(WL = c("WW", "WW"), Phase = c("Pre-stationary"), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, a', 'ANOVA, p < 0.05, a'))

WL.labs <- c("Phase of growth")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))


ggplot(PhycoChlaRatioChoosenPUR, aes(x = PARPhotonDose_day, y = PURPARRatio)) +
  geom_point(aes(x = PARPhotonDose_day, y = AllmeanPURPARRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_point(aes(x = PARPhotonDose_day, y = PURPARRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, show.legend = F) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = AllmeanPURPARRatio - AllsdPURPARRatio, ymax = AllmeanPURPARRatio + AllsdPURPARRatio, colour=as.factor(Par_ue)), width=0, size=0.3, show.legend = F) +
  geom_line(aes(PARPhotonDose_day, .fitted), colour = "blue", linetype = "solid", size = 0.3, show.legend = F, augmented590PUR) +
  # geom_text(data=data_text_y0Exp, aes(x=70000000, y=4, label=label), size=3.5) +
  # geom_text(data=data_text_yfExp, aes(x=70000000, y=2.5, label=label), size=3.5) +
  # geom_text(data=data_text_lambdaExp, aes(x=70000000, y=1, label=label), size=3.5) +
  # 
  # geom_text(data=data_text_y0St, aes(x=7500000, y=4, label=label), size=3.5) +
  # geom_text(data=data_text_yfSt, aes(x=7500000, y=2.5, label=label), size=3.5) +
  # geom_text(data=data_text_lambdaSt, aes(x=7500000, y=1, label=label), size=3.5) +
  
  # geom_text(data=data_text_AnovaExp, aes(x=15000000, y=0, label=label), colour = "blue", size=3.5) +
  # geom_text(data=data_text_AnovaSt, aes(x=15000000, y=0, label=label), colour = "blue", size=3.5) +
  
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3",  "goldenrod2", "khaki2"), name="", labels = lab2) +
  labs(y="PUR/PAR ratio", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.3)) +
  coord_cartesian(xlim = c(0, 80000000), ylim = c(0, 1.2)) +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(WL, Phase), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.9),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```












# Merge Solisense data with Pigment data

```{r Joining Solisense and pig data}
SolFitsPigmentExp <- SolFitsExpSt %>% 
  left_join(., MCPigmentAllExpStChoosen, by = c("SampleID" = "SampleID", "Strain"="Strain", "Par_ue"="Par_ue", "Photoperiod"="Photoperiod", "Run"="Run", "WL"="WL", "O2"="O2", "Phase"="Phase", "PARPhotonDose_day"="PARPhotonDose_day", "ExpDate"="ExpDate", "facetsStrain" = "facetsStrain")) 
 SolFitsPigmentExp$facetsPhase <- "Phase~of~growth"

# SolFitsPigmentExp1s <- SolFitsExpSt1s %>% 
#   left_join(., MCPigmentAllExpStChoosen, by = c("SampleID" = "SampleID", "Strain"="Strain", "Par_ue"="Par_ue", "Photoperiod"="Photoperiod", "Run"="Run", "WL"="WL", "O2"="O2", "Phase"="Phase", "PARPhotonDose_day"="PARPhotonDose_day", "ExpDate"="ExpDate", "facetsStrain" = "facetsStrain")) 
# SolFitsPigmentExp1s$facetsPhase <- "Phase~of~growth"

 
rm(SolFitsExpSt, MCPigmentAllExpStChoosen)
#rm(SolFitsExpSt, SolFitsExpSt1s, MCPigmentExp)
```

```{r Joining Solisense and pig exp data}
# SolFitsPigmentExp <- SolFitsExpSt %>% 
#   left_join(., MCPigmentAllExpSt, by = c("Strain"="Strain","Par_ue"="Par_ue","Photoperiod"="Photoperiod")) 
# 
# SolFitsPigmentExp1s <- SolFitsExpSt1s %>% 
#   left_join(., MCPigmentAllExpSt, by = c("Strain"="Strain","Par_ue"="Par_ue","Photoperiod"="Photoperiod")) 

#rm(SolFitsExpSt, SolFitsExpSt1s, MCPigmentExp)
```

# Filter unrevelant data

```{r}
# SolFitsPigmentExp <- SolFitsPigmentExp %>% 
#   filter(AllmeanPhycoChlaRatio>0)
# 
# SolFitsPigmentExp1s <- SolFitsPigmentExp1s %>% 
#   filter(AllmeanPhycoChlaRatio>0)
```


# Create preliminary plots

```{r preliminary plots}
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  # geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Phase, Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()


SolFitsPigmentExp %>% 
  filter(Ex_WL==590) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  # geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()


SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSig_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSigdark_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSigdark_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


# SolFitsPigmentExp1s %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = Sig1s_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
#   # geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Par_ue))) +
#   scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
#   scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
#   ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
#   theme_bw() 
# 
# 
# SolFitsPigmentExp1s %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = Sig1s_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
#     # geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain))) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw()
```

# Combine PC and PE-rich strains together

```{r combine PC and PE-rich strains}
SolFitsAllPigmentPC<-SolFitsPigmentExp %>% 
  filter(Strain == "PC-rich_056" | Strain == "PC-rich_077") 
SolFitsAllPigmentPC$StrainGroup = "PC-rich"
SolFitsAllPigmentPE<-SolFitsPigmentExp %>% 
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127")  
SolFitsAllPigmentPE$StrainGroup = "PE-rich"

SolFitsAllPigmentPCPE<-rbind(SolFitsAllPigmentPC, SolFitsAllPigmentPE)
rm(SolFitsAllPigmentPC, SolFitsAllPigmentPE)


# SolFitsAllPigmentPC1s<-SolFitsPigmentExp1s %>% 
#   filter(Strain == "PC-rich_056" | Strain == "PC-rich_077") 
# SolFitsAllPigmentPC1s$StrainGroup = "PC-rich"
# SolFitsAllPigmentPE1s<-SolFitsPigmentExp1s %>% 
#   filter(Strain == "PE-rich_048" | Strain == "PE-rich_127")  
# SolFitsAllPigmentPE1s$StrainGroup = "PE-rich"
#   
# SolFitsAllPigmentPCPE1s<-rbind(SolFitsAllPigmentPC1s, SolFitsAllPigmentPE1s)

#rm(SolFitsAllPigmentPC1s, SolFitsAllPigmentPE1s)
```

# Filtering data measured from log and very early exponential phase of growth

```{r filtering data from log phase}
SolFitsAllPigmentPCPE<-SolFitsAllPigmentPCPE %>%
  filter(E_days>=2) 

# SolFitsAllPigmentPCPE1s<-SolFitsAllPigmentPCPE1s %>%
#   filter(E_days>=2) 
```

# Linear fit per Ex_WL

```{r linear fit}
SolFitsAllPigmentfitPhycoChlalinearExWL <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%  
  nest(data = -c("Ex_WL", "Phase")) %>%  
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalineardarkExWL <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>% 
  nest(data = -c("Ex_WL", "Phase")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


# SolFitsAllPigmentfitPhycoChlalinearExWL1s <- SolFitsAllPigmentPCPE1s %>%  
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>% 
#   nest(data = -c("Ex_WL", "Phase")) %>% 
#   mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%    
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

# Creat preliminary plot

```{r preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsAllPigmentfitPhycoChlalinearExWL %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  # geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL, Phase), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalineardarkExWL %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL, Phase), labeller = label_parsed) +
  theme_bw() 


# SolFitsAllPigmentfitPhycoChlalinearExWL1s %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   ggh4x::facet_nested(cols = vars(Ex_WL, Phase), labeller = label_parsed) +
#   theme_bw() 
```

# Linear fit per par_ue

```{r linear fit}

SolFitsAllPigmentfitPhycoChlalinear <- SolFitsAllPigmentPCPE %>%   
  drop_na(Par_ue, Ex_WL, Phase, meanSig_nm2psii, AllmeanPhycoChlaRatio) %>% 
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%  
  nest(data = -c("Par_ue", "Ex_WL", "Phase")) %>%   
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalineardark <- SolFitsAllPigmentPCPE %>%  
    drop_na(Par_ue, Ex_WL, Phase, meanSig_nm2psii, AllmeanPhycoChlaRatio) %>% 
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%  
  nest(data = -c("Par_ue", "Ex_WL", "Phase")) %>%   
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


# SolFitsAllPigmentfitPhycoChlalinear1s <- SolFitsAllPigmentPCPE1s %>%  
#     drop_na(Par_ue, Ex_WL, Phase, meanSig1s_nm2psii, AllmeanPhycoChlaRatio) %>% 
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>% 
#   nest(data = -c("Par_ue", "Ex_WL", "Phase")) %>%   
#   mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))
# 
# 
# SolFitsAllPigmentfitPhycoChlalinearPCPE1s <- SolFitsAllPigmentPCPE1s %>%   
#     drop_na(Par_ue, Ex_WL, Phase, meanSig1s_nm2psii, AllmeanPhycoChlaRatio) %>% 
#   select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%  
#   nest(data = -c("Par_ue", "Ex_WL", "StrainGroup", "Phase")) %>%  
#   mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%    
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

# Create preliminary plot

```{r preliminary plot}

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsAllPigmentfitPhycoChlalinear %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(Ex_WL, Phase), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalineardark %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) + 
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL, Phase), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


# SolFitsAllPigmentfitPhycoChlalinear1s %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE1s) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) + 
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   ggh4x::facet_nested(cols = vars(Ex_WL, Phase), rows = vars(Par_ue), labeller = label_parsed) +
#   theme_bw()
```

# Combine 590 sigma and sigma in the dark

```{r}
# SolFitsAllPigmentPCPE$facetsPar_ue = factor(SolFitsAllPigmentPCPE$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
# SolFitsAllPigmentPCPE$facetsExcitation590 = factor(SolFitsAllPigmentPCPE$O2, labels = c("Excitation~590~nm"))
# 
# SolFitsAllPigmentPCPEMerge1<-SolFitsAllPigmentPCPE %>% 
#   select(c(Strain, Ex_WL, WL, Par_ue, Photoperiod, Sig_nm2psii, AllmeanSig_nm2psii, AllsdSig_nm2psii, AllmeanPhycoChlaRatio, facetsPar_ue, facetsExcitation590)) %>% 
#   filter(Ex_WL ==590) %>% 
#   mutate(DifferentSigma = WL) %>%
#   mutate(DifferentSigma = case_when(DifferentSigma=="WW"~"Light~condition")) %>% 
#   rename(Sigma_value = Sig_nm2psii) %>% 
#   rename(AllmeanSigma_value = AllmeanSig_nm2psii) %>% 
#   rename(AllsdSigma_value = AllsdSig_nm2psii)
# 
# SolFitsAllPigmentPCPEMerge2<-SolFitsAllPigmentPCPE %>% 
#   select(c(Strain, Ex_WL, WL, Par_ue, Photoperiod, Sigdark_nm2psii, AllmeanSigdark_nm2psii, AllsdSigdark_nm2psii, AllmeanPhycoChlaRatio, facetsPar_ue, facetsExcitation590)) %>% 
#   filter(Ex_WL ==590) %>% 
#   mutate(DifferentSigma = WL) %>%
#   mutate(DifferentSigma = case_when(DifferentSigma=="WW"~"Dark~condition")) %>% 
#   rename(Sigma_value = Sigdark_nm2psii) %>% 
#   rename(AllmeanSigma_value = AllmeanSigdark_nm2psii) %>% 
#   rename(AllsdSigma_value = AllsdSigdark_nm2psii)
# 
# SolFitsAllPigmentPCPEMerge590<-rbind(SolFitsAllPigmentPCPEMerge1, SolFitsAllPigmentPCPEMerge2)
#   rm(SolFitsAllPigmentPCPEMerge1, SolFitsAllPigmentPCPEMerge2)
# 
# 
# SolFitsAllPigmentfitPhycoChlalinearMerge590 <- SolFitsAllPigmentPCPEMerge590 %>%   
#   drop_na(Sigma_value, AllmeanPhycoChlaRatio) %>% 
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, Sigma_value, AllmeanPhycoChlaRatio, WL, DifferentSigma, facetsPar_ue, facetsExcitation590)) %>%  
#   nest(data = -c("Par_ue", "DifferentSigma", "facetsPar_ue", "facetsExcitation590")) %>%   
#   mutate(Linear_Model = map(data, ~lm(Sigma_value ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))

```

# Create a preliminary plot

```{r preliminary plot}

# SolFitsAllPigmentfitPhycoChlalinearMerge590 %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSigma_value, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPEMerge590) + 
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigma_value - AllsdSigma_value, ymax = AllmeanSigma_value + AllsdSigma_value, colour=as.factor(Strain)), SolFitsAllPigmentPCPEMerge590) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   ggh4x::facet_nested(cols = vars(facetsExcitation590, DifferentSigma), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
#   theme_bw() 
```

# Create Sigma vs pigments ratio plot

```{r}
# scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"),expression("900 µE"))
# 
# SolFitsAllPigmentfitPhycoChlalinearMerge590 %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSigma_value, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPEMerge590) + 
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = Sigma_value, colour=as.factor(Strain)), size = 1, show.legend = F, SolFitsAllPigmentPCPEMerge590) +
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigma_value - AllsdSigma_value, ymax = AllmeanSigma_value + AllsdSigma_value, colour = as.factor(Strain)), show.legend = F, width=0, size=0.3, SolFitsAllPigmentPCPEMerge590) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   scale_y_continuous(breaks=seq(0, 12, by = 3)) +
#   coord_cartesian(ylim = c(0, 12)) +
#   labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*" quanta"^"-1"*")")), x = "Total phyco/Chl" ~italic(a)~ "ratio") +
#   ggh4x::facet_nested(cols = vars(facetsExcitation590, DifferentSigma), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
#   theme_bw() 
```

# Save RDS that create plot

```{r}
# saveRDS(SolFitsAllPigmentfitPhycoChlalinearMerge590, file.path(RDSPlotPath, paste(Project, "Plot_SigmavsPigments_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
# 
# saveRDS(SolFitsAllPigmentPCPEMerge590, file.path(RDSPlotPath, paste(Project, "Plot_SigmavsPigments_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Save plot 

```{r save plot}
# ggsave(file = file.path(PlotsPath, paste("SigmavsPigments590_Plot",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```



# Combine 445 sigma and sigma in the dark

```{r}

# SolFitsAllPigmentPCPE$facetsExcitation445 = factor(SolFitsAllPigmentPCPE$O2, labels = c("Excitation~445~nm"))
# 
# SolFitsAllPigmentPCPEMerge1<-SolFitsAllPigmentPCPE %>% 
#   select(c(Strain, Ex_WL, WL, Par_ue, Photoperiod, Sig_nm2psii, AllmeanSig_nm2psii, AllsdSig_nm2psii, AllmeanPhycoChlaRatio, facetsPar_ue, facetsExcitation445)) %>% 
#   filter(Ex_WL ==445) %>% 
#   mutate(DifferentSigma = WL) %>%
#   mutate(DifferentSigma = case_when(DifferentSigma=="WW"~"Light~condition")) %>% 
#   rename(Sigma_value = Sig_nm2psii) %>% 
#   rename(AllmeanSigma_value = AllmeanSig_nm2psii) %>% 
#   rename(AllsdSigma_value = AllsdSig_nm2psii)
# 
# SolFitsAllPigmentPCPEMerge2<-SolFitsAllPigmentPCPE %>% 
#   select(c(Strain, Ex_WL, WL, Par_ue, Photoperiod, Sigdark_nm2psii, AllmeanSigdark_nm2psii, AllsdSigdark_nm2psii, AllmeanPhycoChlaRatio, facetsPar_ue, facetsExcitation445)) %>% 
#   filter(Ex_WL ==445) %>% 
#   mutate(DifferentSigma = WL) %>%
#   mutate(DifferentSigma = case_when(DifferentSigma=="WW"~"Dark~condition")) %>% 
#   rename(Sigma_value = Sigdark_nm2psii) %>% 
#   rename(AllmeanSigma_value = AllmeanSigdark_nm2psii) %>% 
#   rename(AllsdSigma_value = AllsdSigdark_nm2psii)
# 
# SolFitsAllPigmentPCPEMerge445<-rbind(SolFitsAllPigmentPCPEMerge1, SolFitsAllPigmentPCPEMerge2)
#   rm(SolFitsAllPigmentPCPEMerge1, SolFitsAllPigmentPCPEMerge2)
# 
# 
# SolFitsAllPigmentfitPhycoChlalinearMerge445 <- SolFitsAllPigmentPCPEMerge445 %>%   
#   drop_na(Sigma_value, AllmeanPhycoChlaRatio) %>% 
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, Sigma_value, AllmeanPhycoChlaRatio, WL, DifferentSigma, facetsPar_ue, facetsExcitation445)) %>%  
#   nest(data = -c("Par_ue", "DifferentSigma", "facetsPar_ue", "facetsExcitation445")) %>%   
#   mutate(Linear_Model = map(data, ~lm(Sigma_value ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))

```

# Create a preliminary plot

```{r preliminary plot}

# SolFitsAllPigmentfitPhycoChlalinearMerge445 %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSigma_value, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPEMerge445) + 
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigma_value - AllsdSigma_value, ymax = AllmeanSigma_value + AllsdSigma_value, colour=as.factor(Strain)), SolFitsAllPigmentPCPEMerge445) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   ggh4x::facet_nested(cols = vars(facetsExcitation445, DifferentSigma), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
#   theme_bw() 
```

# Create Sigma vs pigments ratio plot

```{r}
# scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))
# 
# SolFitsAllPigmentfitPhycoChlalinearMerge445 %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSigma_value, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPEMerge445) + 
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = Sigma_value, colour=as.factor(Strain)), size = 1, show.legend = F, SolFitsAllPigmentPCPEMerge445) +
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigma_value - AllsdSigma_value, ymax = AllmeanSigma_value + AllsdSigma_value, colour = as.factor(Strain)), show.legend = F, width=0, size=0.3, SolFitsAllPigmentPCPEMerge445) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   scale_y_continuous(breaks=seq(0, 2.5, by = 0.5)) +
#   coord_cartesian(ylim = c(0, 2.5)) +
#   labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*" quanta"^"-1"*")")), x = "Total phyco/Chl" ~italic(a)~ "ratio") +
#   ggh4x::facet_nested(cols = vars(facetsExcitation445, DifferentSigma), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
#   theme_bw() 
```

# Save RDS that create plot

```{r}
# saveRDS(SolFitsAllPigmentfitPhycoChlalinearMerge445, file.path(RDSPlotPath, paste(Project, "SupPlot_SigmavsPigments_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
# 
# saveRDS(SolFitsAllPigmentPCPEMerge445, file.path(RDSPlotPath, paste(Project, "SupPlot_SigmavsPigments_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Save plot 

```{r save plot}
# ggsave(file = file.path(PlotsPath, paste("SigmavsPigments445_SupPlot",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Linear fit per Strain

```{r linear fit}
SolFitsAllPigmentfitPhycoChlalinearStrain <- SolFitsAllPigmentPCPE %>%  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase, facetsExcitation, facetsStrain, facetsPhase)) %>%  
  nest(data = -c("Strain", "Ex_WL", "Phase", "facetsPhase", "facetsStrain")) %>%  
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalineardarkStrain <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase, facetsExcitation, facetsStrain, facetsPhase)) %>%  
  nest(data = -c("Strain", "Ex_WL", "Phase", "facetsPhase", "facetsStrain")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


# SolFitsAllPigmentfitPhycoChlalinearStrain1s <- SolFitsAllPigmentPCPE1s %>%  
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%  
#   nest(data = -c("Strain", "Ex_WL", "Phase")) %>% 
#   mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%    
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))

#xxxxxx

# SolFitsAllPigmentfitPhycoChlalinearStrainGroup <- SolFitsAllPigmentPCPE %>%   
#   select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%  
#   nest(data = -c("StrainGroup", "Ex_WL", "Phase")) %>% 
#   mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))
# 
# 
# SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup <- SolFitsAllPigmentPCPE %>%   
#   select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%  
#   nest(data = -c("StrainGroup", "Ex_WL", "Phase")) %>% 
#   mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))
# 
# 
# SolFitsAllPigmentfitPhycoChlalinearStrainGroup1s <- SolFitsAllPigmentPCPE1s %>%   
#   select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, AllmeanPhycoChlaRatio, O2, WL, Phase)) %>%
#   nest(data = -c("StrainGroup", "Ex_WL", "Phase")) %>%  
#   mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ AllmeanPhycoChlaRatio, data = .x))) %>%     
#   mutate(Linear_Model_Param = map(Linear_Model, tidy),          
#          Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
#          Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

# Create preliminary plot

```{r preliminary plot}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

SolFitsAllPigmentfitPhycoChlalinearStrain %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
  # scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  # scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL, Phase), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalineardarkStrain %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) + 
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL, facetsPhase, Phase), rows = vars(facetsStrain, Strain),labeller = label_parsed) +
  theme_bw() 
  
  
# SolFitsAllPigmentfitPhycoChlalinearStrain1s %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE1s) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   ggh4x::facet_nested(cols = vars(Ex_WL, Phase), rows = vars(Strain), labeller = label_parsed) +
#   theme_bw() 
#   
#   #xxxxxxxx
#   
# SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup %>% 
#   unnest(Linear_Model_Predict) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), show.legend = F) + 
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   ggh4x::facet_nested(cols = vars(Ex_WL, Phase), rows = vars(StrainGroup),labeller = label_parsed) +
#   theme_bw() 
```

# Create Sigma vs pigments ratio plot

```{r fig.height = 8, fig.width = 8, warning = FALSE}
# WL.labs <- c("Excitation (nm)")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)
# 
# scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))
# 
# SolFitsAllPigmentPCPE590<-SolFitsAllPigmentPCPE %>% 
#     filter(Ex_WL==590) 
# 
# SolFitsAllPigmentfitPhycoChlalinearStrain %>% 
#   unnest(Linear_Model_Predict, data) %>% 
#   #filter(Ex_WL==590) %>% 
#   ggplot() +
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE590) + 
#   geom_point(aes(x = AllmeanPhycoChlaRatio, y = Sig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, show.legend = F, SolFitsAllPigmentPCPE590) + 
#   
#   geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour = as.factor(Par_ue)), show.legend = F, width=0, size=0.3, SolFitsAllPigmentPCPE590) +
#   geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), colour = "blue", linetype = "solid", size = 0.3, show.legend = F) +   
#   scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
#   scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab2) +
#   scale_y_continuous(breaks=seq(0, 8, by = 2)) +
#   coord_cartesian(ylim = c(0, 9)) +
#   labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*" quanta"^"-1"*")")), x = "Total phyco/Chl" ~italic(a)~ "ratio") +
#   ggh4x::facet_nested(cols = vars(Phase), rows = vars(O2, Strain), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="white"),
#         legend.position = c(0.92,0.88),
#         legend.key.height= unit(0.005, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         legend.title = element_blank(),
#         legend.text = element_text(size=10))
```

```{r unnest, preparing df to preparing final plot, echo=FALSE, warning = FALSE}
augmented590pigment<-SolFitsAllPigmentfitPhycoChlalinearStrain  %>%
  unnest(Linear_Model_Predict) %>%
  select(c(Strain, Ex_WL, meanSig_nm2psii, AllmeanPhycoChlaRatio, Phase, .fitted, facetsPhase, facetsStrain)) %>% 
  filter(Ex_WL == 590)

SolFitsAllPigmentPCPE590<-SolFitsAllPigmentPCPE %>% 
filter(Ex_WL == 590) 
#SolFitsAllPigmentPCPE590$facetsStrain <- 'Strain'
# SolFitsAllPigmentPCPE590$facetsPhase <- "Phase~of~growth"
```


```{r fig.height = 8, fig.width = 8, warning = FALSE}
# WL.labs <- c("Excitation (nm)")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

  
SolFitsAllPigmentPCPE590 %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE590) + 
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = Sig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, show.legend = F, SolFitsAllPigmentPCPE590) + 
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour = as.factor(Par_ue)), show.legend = F, width=0, size=0.3, SolFitsAllPigmentPCPE590) +
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), colour = "blue", linetype = "solid", size = 0.3, show.legend = F, augmented590pigment) +   
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab2) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*" quanta"^"-1"*")")), x = "Total phyco/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.88),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
```


# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_SigmaPig590",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

```{r unnest, preparing df to preparing final plot, echo=FALSE, warning = FALSE}
augmented590pigmentdark<-SolFitsAllPigmentfitPhycoChlalineardarkStrain  %>%
  unnest(Linear_Model_Predict) %>%
  select(c(Strain, Ex_WL, meanSigdark_nm2psii, AllmeanPhycoChlaRatio, Phase, .fitted, facetsPhase, facetsStrain)) %>% 
  filter(Ex_WL == 590)

SolFitsAllPigmentPCPE590dark <- SolFitsAllPigmentPCPE %>% 
filter(Ex_WL == 590) 

#SolFitsAllPigmentPCPE590$facetsStrain <- 'Strain'
# SolFitsAllPigmentPCPE590$facetsPhase <- "Phase~of~growth"
```

```{r fig.height = 8, fig.width = 8, warning = FALSE}
# WL.labs <- c("Excitation (nm)")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))


SolFitsAllPigmentPCPE590dark %>% 
  ggplot() +
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = AllmeanSigdark_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE590dark) + 
  geom_point(aes(x = AllmeanPhycoChlaRatio, y = Sigdark_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, show.legend = F, SolFitsAllPigmentPCPE590dark) + 
  geom_errorbar(aes(x = AllmeanPhycoChlaRatio, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour = as.factor(Par_ue)), show.legend = F, width=0, size=0.3, SolFitsAllPigmentPCPE590dark) +
  geom_line(aes(x = AllmeanPhycoChlaRatio, y = `.fitted`), colour = "blue", linetype = "solid", size = 0.3, show.legend = F, augmented590pigmentdark) +   
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "goldenrod2", "khaki2"), name="", labels = lab2) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*" quanta"^"-1"*")")), x = "Total phyco/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.88),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_SigmaPig590dark",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```




The anova() function will take the model objects as arguments, and return an ANOVA testing whether the more complex model is significantly better at capturing the data than the simpler model. If the resulting p-value is sufficiently low (usually less than 0.05), we conclude that the more complex model is significantly better than the simpler model, and thus favor the more complex model. If the p-value is not sufficiently low (usually greater than 0.05), we should favor the simpler model.

# Exstracting models for each fit - models were not all fitted to the same size of dataset

```{r}
# SolFitsBA56Exp<-SolFitsAllPigmentPCPE %>% 
#   filter(Phase=="Exponential") %>% 
#   filter(Strain == "PC-rich_056") %>% 
#   select(c(Sig, AllmeanPhycoChlaRatio)) %>% 
#   rename(PigExp=AllmeanPhycoChlaRatio)
# 
# SolFitsBA56St<-SolFitsAllPigmentPCPE %>% 
#   filter(Phase=="Pre-stationary") %>% 
#   filter(Strain == "PC-rich_056") %>% 
#   select(c(Sig, AllmeanPhycoChlaRatio)) %>% 
#   rename(PigSt=AllmeanPhycoChlaRatio)
# 
# SolFitsAllExp<-merge(SolFitsBA56Exp, SolFitsBA56St, by="Sig", all = T)
#   fit <- lm(Sig ~ ., data = SolFitsAllExp)
# anova(fit)
# 
#  diamonds.mod1 <- lm(Sig_nm2psii~AllmeanPhycoChlaRatio, data = SolFitsAllExp)
#   diamonds.mod2 <- lm(Sig_nm2psii~AllmeanPhycoChlaRatio+Strain, data = SolFitsAllSt)
#   anova(diamonds.mod1, diamonds.mod2, test="Chisq")
#   
#  
#   LifeCycleSavings<-LifeCycleSavings
#   ## sequential table
# fit <- lm(sr ~ ., data = LifeCycleSavings)
# anova(fit)


```

# Anova from the model - error - no applicable method for 'anova' applied to an object of class "character"









# Clean the environment

```{r}
rm(SolFitsAllPigmentfitPhycoChlalineardarkStrain, SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup, SolFitsAllPigmentfitPhycoChlalinearStrain, SolFitsAllPigmentfitPhycoChlalinearStrain1s, SolFitsAllPigmentfitPhycoChlalinearStrainGroup, SolFitsAllPigmentfitPhycoChlalinearStrainGroup1s)
```


# Load Turner catalog

```{r load turner catalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()
Turnercatalog<- read_sheet("https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0")

as.data.frame(Turnercatalog)
ChlData <- Turnercatalog 

ChlData <- ChlData %>%  
  mutate(TurChl_ugL = as.numeric(Reading_rfu) * as.numeric(Chl_slope) + as.numeric(Chl_intercept)) %>% 
  mutate(DATE = ymd(`DATE`)) %>% 
  rename(SampleID=CultureID) %>% 
  rename(ObsDate=DATE) %>% 
  select(c(SampleID, ObsDate, TurChl_ugL)) %>% 
  filter(TurChl_ugL<212354.754) #outliers
```

# Calculate Chl mean from 3 technical replica

```{r}
ChlData <- ChlData %>%
  group_by(SampleID, ObsDate) %>%
  summarize(SampleID, ObsDate, TurChl_ugL,
            meanTurChl_ugL = mean(TurChl_ugL),
            sdTurChl_ugL = sd(TurChl_ugL)) %>%
  ungroup()
```
# Merge Sigma with chlorophyll Turner data

```{r}
SolFitsAllPigmentPCPETurner <- ChlData %>%
  left_join(., SolFitsPigmentExp, by = c("SampleID"="SampleID", "ObsDate"="ObsDate"))

SolFitsAllPigmentPCPETurner<-SolFitsAllPigmentPCPETurner %>% 
  filter(Strain=="PC-rich_056" | Strain == "PC-rich_077" | Strain == "PE-rich_048" | Strain == "PE-rich_127")
```

# Create preliminary JVPSII vs Chl Turner (ug/L) plot

```{r preliminary plots, warning = FALSE}
SolFitsAllPigmentPCPETurner %>% 
  ggplot() +
  geom_point(aes(x = TurChl_ugL, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()


SolFitsAllPigmentPCPETurner %>%
  ggplot() +
  geom_point(aes(x = cellL_OD680, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()


SolFitsAllPigmentPCPETurner %>% 
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3","goldenrod2", "khaki2"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()
```

# Clean the environment

```{r}
rm(Turnercatalog, ChlData, SolFitsAllPigmentPCPE, SolFitsAllPigmentPCPE1s)
```

# Save rds for further analysis

```{r save rds}
saveRDS(SolFitsAllPigmentPCPETurner, file.path(DataOut, paste(Project, "Processed_SolisensePigmentsAllcheckthis.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Variable names used in Data Dictionary

```{r}
colnames(SolFitsAllPigmentPCPETurner)
```







Set up R codes for Greek letters

\u0391  Α   Greek Capital Letter Alpha
\u0392  Β   Greek Capital Letter Beta
\u0393  Γ   Greek Capital Letter Gamma
\u0394  Δ   Greek Capital Letter Delta
\u0395  Ε   Greek Capital Letter Epsilon
\u0396  Ζ   Greek Capital Letter Zeta
\u0397  Η   Greek Capital Letter Eta
\u0398  Θ   Greek Capital Letter Theta
\u0399  Ι   Greek Capital Letter Iota
\u039A  Κ   Greek Capital Letter Kappa
\u039B  Λ   Greek Capital Letter Lambda
\u039C  Μ   Greek Capital Letter Mu
\u039D  Ν   Greek Capital Letter Nu
\u039E  Ξ   Greek Capital Letter Xi
\u039F  Ο   Greek Capital Letter Omicron
\u03A0  Π   Greek Capital Letter Pi
\u03A1  Ρ   Greek Capital Letter Rho
\u03A3  Σ   Greek Capital Letter Sigma
\u03A4  Τ   Greek Capital Letter Tau
\u03A5  Υ   Greek Capital Letter Upsilon
\u03A6  Φ   Greek Capital Letter Phi
\u03A7  Χ   Greek Capital Letter Chi
\u03A8  Ψ   Greek Capital Letter Psi
\u03A9  Ω   Greek Capital Letter Omega
\u03B1  α   Greek Small Letter alpha
\u03B2  β   Greek Small Letter beta
\u03B3  γ   Greek Small Letter gamma
\u03B4  δ   Greek Small Letter delta
\u03B5  ε   Greek Small Letter epsilon
\u03B6  ζ   Greek Small Letter zeta
\u03B7  η   Greek Small Letter eta
\u03B8  θ   Greek Small Letter theta
\u03B9  ι   Greek Small Letter iota
\u03BA  κ   Greek Small Letter kappa
\u03BB  λ   Greek Small Letter lambda
\u03BC  μ   Greek Small Letter mu
\u03BD  ν   Greek Small Letter nu
\u03BE  ξ   Greek Small Letter xi
\u03BF  ο   Greek Small Letter omicron
\u03C0  π   Greek Small Letter pi
\u03C1  ρ   Greek Small Letter rho
\u03C2  ς   Greek Small Letter final sigma
\u03C3  σ   Greek Small Letter sigma
\u03C4  τ   Greek Small Letter tau
\u03C5  υ   Greek Small Letter upsilon
\u03C6  φ   Greek Small Letter phi
\u03C7  χ   Greek Small Letter chi
\u03C8  ψ   Greek Small Letter psi
\u03C9  ω   Greek Small Letter omega





