---
title: "Import OLIS spectral data data"
author: "Sylwia Sliwinska-Wilczewska"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer

```{r setup, include = FALSE}
# knitr::opts_chunk$set(echo = TRUE, message = FALSE)
# knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "SySlmanuscriptWWPhotoperiod")
#DataIn <- file.path("..", "OLISSpectraCorr", "WWPhotoperiodSingle", fsep = .Platform$file.sep)
#FileID <- "Smooth"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)

library(dplyr)
library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)

library(photobiologyWavebands)
library(reshape2)
library(photobiology)

library(gcookbook)
library(RColorBrewer)
library(viridis)
library(scales)

library(reshape)
library(patchwork)
library(minpack.lm)

```

Load Multiculti catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
# gs4_deauth()
# 
# MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
#   drop_na(WL) %>%
#   mutate(WL = unlist(WL))
# 
# as.data.frame(MetaData)
# MetaData <- MetaData %>%
#    mutate(ExpDate = ymd(ExpDate),
#           ExpEndDate = ymd_hms(`ExpEndDate`))
# 
# 
# MetaData <- MetaData %>%
# summarize(Run, ID, Strain, MC, InnocDate, ExpDate, Par_ue, Photoperiod, Tube, O2, WL, LightShape) %>% 
#   filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") 
#   
# MetaData1 <- MetaData %>%
#   filter(Photoperiod != "24") %>% 
#   mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
#   
#   MetaData2 <- MetaData %>%
#   filter(Photoperiod == "24") %>% 
#   mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
#   
#   MetaData <-rbind(MetaData1, MetaData2)
#   rm(MetaData1,MetaData2)
#   
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```
Olis file
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..", "ImportedData", "OLIS", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```

Olis file
Exported Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```
Olis file
```{r read ProcessFile}
#File choosen for spectra plot - 4 spectra only
OLISSpectraMeta440File <- "../ImportedData/OLIS/PicoBaltic_OLISSpectraWWPhotoperiod.Rds"
OLISSpectraMeta440FileName <- str_split(string = OLISSpectraMeta440File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraMeta440 <- readRDS(OLISSpectraMeta440File)  %>%
  ungroup()

```


Jaz file
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..", "ImportedData", "Jaz", fsep = .Platform$file.sep)

FileEncode <- "UTF-8"
Delimiter <- ","

HeaderRows <- 0
```

Jaz file
Exported from PICO_SySlJazSpec_MultiCulti.Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Jaz file
```{r read ProcessFile}
JazFile <- "../ImportedData/Jaz/PicoBaltic_MultiCultiSpectraSySlWWPhotoperiodAll.Rds"

JazFileName <- str_split(string = JazFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

JazData <- readRDS(JazFile)  %>%
  ungroup()

colnames(JazData)
```

```{r}
JazData <- JazData %>%
   mutate(WavelengthRound = round(Wavelength))
colnames(JazData)

JazDataRound <- JazData %>%
group_by(Filename, WavelengthRound) %>%
  summarize(Counts, Filename, Instrument, Date, Strain, Par, WL, CDateTime, WavelengthRound, CountsMean = mean(Counts)) %>%
ungroup()

JazDataRound <- JazDataRound %>%
  summarize(Filename, Strain, Par, WL, WavelengthRound, CountsMean) %>%
  unique()

JazDataRound <- JazDataRound %>%
  filter(WavelengthRound >= 400 & WavelengthRound <= 700)

```
Normalization at 439
```{r}

EmissionJazWW <- JazDataRound %>%
  group_by(WL, Strain, Par) %>%
  filter(WavelengthRound == 439) %>%
  mutate(EmJaz439 = CountsMean) %>%
  select(Strain, EmJaz439, Par) %>%
  ungroup()

JazDataRoundMeta <- JazDataRound %>%
  left_join(., EmissionJazWW) %>%
  mutate(EmNormJaz439 = CountsMean / EmJaz439)
  
```
Combine Olis spectra and Jaz
```{r}

OLISSpectraMetaAll <- OLISSpectraMeta440 %>%
  left_join(., JazDataRoundMeta, by = c("Par_ue" = "Par", "nm" = "WavelengthRound", "Strain" = "Strain", "WL" = "WL")) %>%
  unique()

```

PUR Mireille idea
```{r}

OLISSpectraMetaAllPUR <- OLISSpectraMetaAll %>%

  mutate(PURNorm = (AbsNorm440*EmNormJaz439)) %>% # green line

  group_by(WL, Strain, Par_ue, Photoperiod, E_days) %>%
  mutate(PURNormSum = sum(PURNorm)) %>% #sum of the green line
  mutate(SumEmNormJaz439 = sum(EmNormJaz439)) %>% #sum of the blue line
  mutate(PUR = Par_ue*(PURNormSum/SumEmNormJaz439)) %>% 
  ungroup() 



OLISSpectraMetaAllPUR1 <- OLISSpectraMetaAllPUR %>%
  filter(Photoperiod != "24") %>% 
  mutate(PURPhotonDose =(PUR/2)*Photoperiod*3600)
  
OLISSpectraMetaAllPUR2 <- OLISSpectraMetaAllPUR %>%
  filter(Photoperiod == "24") %>% 
  mutate(PURPhotonDose = PUR*Photoperiod*3600) 
  
  OLISSpectraMetaAllPUR <-rbind(OLISSpectraMetaAllPUR1, OLISSpectraMetaAllPUR2)
  rm(OLISSpectraMetaAllPUR1,OLISSpectraMetaAllPUR2)


```

Clean OLISSpectraMetaAllPUR for WW photoperiod manuscript
```{r}
#colnames(OLISSpectraMetaAllPURClean)

OLISSpectraMetaAllPURClean<-OLISSpectraMetaAllPUR %>% 
  filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") %>%
  select(-c(PrimaryOperator, doi, ProjectID, Inoc_mL, Media_mL, Plate, Well, Salinity,  N2, Ar, CO2, Media, MediaDate, SourceSalinity, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...44, ...45, Description, Motivation, EndDate,  ExpCul, ExpStartTime, Source, Optode, Range, Cdatetime, Project, "Calculated_µmolPhotons_m-2d-1", Temp_c, O2_Category, Filename.x, Filename.y, SumAb, SumAbNorm, CountsMean, PURNormSum, SumEmNormJaz439))

  OLISSpectraMetaAllPURClean1 <- OLISSpectraMetaAllPURClean %>%
  filter(Photoperiod != "24") %>% 
  mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
  
  OLISSpectraMetaAllPURClean2 <- OLISSpectraMetaAllPURClean %>%
  filter(Photoperiod == "24") %>% 
  mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
  
  OLISSpectraMetaAllPURClean <-rbind(OLISSpectraMetaAllPURClean1, OLISSpectraMetaAllPURClean2)
  rm(OLISSpectraMetaAllPURClean1,OLISSpectraMetaAllPURClean2)
  rm(EmissionJazWW,JazData,JazDataRound, JazDataRoundMeta, OLISSpectraMeta440, OLISSpectraMetaAll)
```





Open WWphotoperiod Rds
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "SySlmanuscriptWWPhotoperiod", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```


Exported Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Olis, PUR and Pigments file
```{r read ProcessFile}
#File choosen for spectra plot - 4 spectra only
OLISSpectraMetaAllPURShortFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_OLISSpectraMetaAllPURShort.Rds"
OLISSpectraMetaAllPURShortFileName <- str_split(string = OLISSpectraMetaAllPURShortFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraMetaAllPURShort <- readRDS(OLISSpectraMetaAllPURShortFile)  %>%
  ungroup()

#All PUR data combined with MultiCulti Catalog
OLISSpectraMetaAllPURPARRatioCleanFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_OLISSpectraMetaAllPURPARRatioClean.Rds"
OLISSpectraMetaAllPURPARRatioCleanFileName <- str_split(string = OLISSpectraMetaAllPURPARRatioCleanFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraMetaAllPURPARRatioClean <- readRDS(OLISSpectraMetaAllPURPARRatioCleanFile)  %>%
  ungroup()

#Choosen PUR exponential - 80 values
OLISSpectraMetaAllPURPARRatioCleanExpPURFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_OLISSpectraMetaAllPURPARRatioCleanExpPUR.Rds"
OLISSpectraMetaAllPURPARRatioCleanExpPURFileName <- str_split(string = OLISSpectraMetaAllPURPARRatioCleanExpPURFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraMetaAllPURPARRatioCleanExpPUR <- readRDS(OLISSpectraMetaAllPURPARRatioCleanExpPURFile)  %>%
  ungroup()

#Choosen PUR pre-stationary - 80 values
OLISSpectraMetaAllPURPARRatioCleanStatPURFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_OLISSpectraMetaAllPURPARRatioCleanStatPUR.Rds"
OLISSpectraMetaAllPURPARRatioCleanStatPURFileName <- str_split(string = OLISSpectraMetaAllPURPARRatioCleanStatPURFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraMetaAllPURPARRatioCleanStatPUR <- readRDS(OLISSpectraMetaAllPURPARRatioCleanStatPURFile)  %>%
  ungroup()

#Pigments from Clariostar combined with Olis Abs- for correlation 
ClarioPigmentFileDataAll2File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_ClarioPigmentFileDataAll2.Rds"
ClarioPigmentFileDataAll2FileName <- str_split(string = ClarioPigmentFileDataAll2File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
ClarioPigmentFileDataAll2 <- readRDS(ClarioPigmentFileDataAll2File)  %>%
  ungroup()

#Turner, MD Pico and pugments per mL
# ClarioOlisPigmentTurnerDataFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_ClarioOlisPigmentTurnerData.Rds"
# ClarioOlisPigmentTurnerDataFileName <- str_split(string = ClarioOlisPigmentTurnerDataFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# ClarioOlisPigmentTurnerData <- readRDS(ClarioOlisPigmentTurnerDataFile)  %>%
#   ungroup()

```

#ClarioOlisPigmentTurnerData <-contained pigments per ml and per cell (fg/cell) based on MD Pico data
(No PAMAS calibration for N here!)


Olis Plot
```{r fig.height = 6, fig.width = 8}

Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "Phase of growth", "900 µE")
names(Par_ue.labs) <- c("30", "90", "180", "300", "900")

Photoperiod.labs <- c("8 h", "Photoperiod: 12 h", "16 h", "24 h")
names(Photoperiod.labs) <- c("8", "12", "16", "24")

E_days.labs <- c("Exponential", "Pre-stationary")
names(E_days.labs) <- c("3", "7")

Strain.labs <- c("PE-rich_127", "PC-rich_077")
names(Strain.labs) <- c("BA127R", "BA77G")

data_textPUR0 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("BA127R", "BA127R"), Photoperiod = c(12), label = c('PAR = 300 µE', 'PAR = 300 µE'))

data_textPUR1 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("BA127R", "BA127R"), Photoperiod = c(12), label = c('PUR (PE-rich) = 176 µE', 'PUR (PE-rich) = 129 µE'))

data_textPUR2 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("BA127R", "BA127R"), Photoperiod = c(12), label = c('PUR (PC-rich) = 139 µE', 'PUR (PC-rich) = 128 µE'))

data_textpigment1 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('Chl a 440 nm'))
data_textpigment2 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('PEB-rich PE 570 nm'))
data_textpigment3 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('Chl a 680 nm'))
data_textpigment4 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('PCB-rich PC 620 nm'))
data_textpigment5 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('Car 480 nm'))
data_textpigment6 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('PUB-rich PE or PC 500 nm'))

arrowdf1 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
arrowdf2 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
arrowdf3 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
arrowdf4 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
arrowdf5 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
arrowdf6 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)


Plot <- OLISSpectraMetaAllPURShort %>%
  filter(Photoperiod == "12") %>%
  filter(Strain == "BA127R" | Strain == "BA77G") %>%
  filter(Par_ue == 300) %>%
  filter(E_days == "3" | E_days == "7") %>%
  ggplot() +
  geom_area(aes(x = nm, y = EmNormJaz439, fill = "gray84"), alpha = 0.6, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA127R, fill = "brown4"), alpha = 0.5, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA77G, fill = "palegreen3"), alpha = 0.5, show.legend = F) +
  geom_line(aes(x = nm, y = AbsNorm440, colour = as.factor(Strain), linetype = as.factor(Strain)), show.legend = F, size = 0.7) +

  geom_text(data=data_textPUR0, aes(x=435, y=1.26, label=label), size=3.5) +
  geom_text(data=data_textPUR1, aes(x=462, y=1.21, label=label), size=3.5) +
  geom_text(data=data_textPUR2, aes(x=462, y=1.16, label=label), size=3.5) +

  geom_text(data=data_textpigment1, aes(x=450, y=1.07, label=label), size=4, colour = "darkgreen") + #chla440
  geom_text(data=data_textpigment5, aes(x=430, y=0.36, label=label), size=4, colour = "coral3") + #Car
  geom_text(data=data_textpigment2, aes(x=520, y=0.92, label=label), size=4, colour = "darkmagenta") + #PE
  geom_text(data=data_textpigment3, aes(x=660, y=1.08, label=label), size=4, colour = "darkgreen") +#chla680
  geom_text(data=data_textpigment4, aes(x=605, y=1.0, label=label), size=4, colour = "deepskyblue4") + #PC
  geom_text(data=data_textpigment6, aes(x=485, y=0.08, label=label), size=4, colour = "sienna4") + #PUB

  geom_segment(data = arrowdf1,
               aes(x = 470, xend = 440, y = 1.04, yend = 1.02),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla440
    geom_segment(data = arrowdf5,
               aes(x = 450, xend = 470, y = 0.4, yend = 0.48),
               colour = "coral3", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #Car
  geom_segment(data = arrowdf2,
               aes(x = 538, xend = 568, y = 0.88, yend = 0.86),
               colour = "darkmagenta", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PE
  geom_segment(data = arrowdf3,
               aes(x = 697, xend = 680, y = 1.05, yend = 0.92),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla680
  geom_segment(data = arrowdf4,
               aes(x = 632, xend = 630, y = 0.95, yend = 0.82),
               colour = "deepskyblue4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PC
  geom_segment(data = arrowdf4,
               aes(x = 465, xend = 500, y = 0.12, yend = 0.52),
               colour = "sienna4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PUB
  
  # scale_color_manual(values = c("BA127R" ="black", "BA48R" ="brown1", "BA56G" ="palegreen4", "BA77G" ="black")) +
  scale_color_manual(values = c("BA127R" ="brown4", "BA77G" ="palegreen3")) +
  scale_linetype_manual(values = c("BA127R" ="longdash", "BA77G" ="solid")) +
  stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.025, alpha = 0.5) + 
  scale_fill_identity() +
  
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c (-0.01, 1.25)) +

  
  ggh4x::facet_nested(cols = vars(Par_ue, E_days), labeller = labeller(Ex_WL = label_both, WL = label_both, E_days = E_days.labs, Photoperiod = Photoperiod.labs, Par_ue = Par_ue.labs, Strain = Strain.labs)) +
  
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot


```
```{r}
rm(data_textpigment1,data_textpigment2,data_textpigment3,data_textpigment4,data_textpigment5,data_textpigment6,arrowdf1,arrowdf2,arrowdf3,arrowdf4,arrowdf5,arrowdf6, data_textPUR0, data_textPUR1,data_textPUR2)

```


```{r fig.height = 10, fig.width = 8}
Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "Phase of growth", "900 µE")
names(Par_ue.labs) <- c("30", "90", "180", "300", "900")

Photoperiod.labs <- c("8 h", "Photoperiod: 12 h", "16 h", "24 h")
names(Photoperiod.labs) <- c("8", "12", "16", "24")

E_days.labs <- c("Exponential", "Pre-stationary")
names(E_days.labs) <- c("3", "7")

Strain.labs <- c("PC-rich_077", "PE-rich_127")
names(Strain.labs) <- c("BA77G", "BA127R")

data_textPUR0 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("BA127R", "BA127R"), Photoperiod = c(12), label = c('PAR = 300 µE', 'PAR = 300 µE'))

data_textPUR00 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("BA77G", "BA77G"), Photoperiod = c(12), label = c('PAR = 300 µE', 'PAR = 300 µE'))

data_textPUR1 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("BA127R", "BA127R"), Photoperiod = c(12), label = c('PUR = 176 µE', 'PUR = 129 µE'))

data_textPUR2 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("BA77G", "BA77G"), Photoperiod = c(12), label = c('PUR = 139 µE', 'PUR = 128 µE'))


# data_textpigment1 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('Chl a 440 nm'))
# data_textpigment2 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('PEB-rich PE 570 nm'))
# data_textpigment3 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('Chl a 680 nm'))
# data_textpigment4 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('PCB-rich PC 620 nm'))
# data_textpigment5 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('Car 480 nm'))
# data_textpigment6 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("BA127R"), Photoperiod = c(12), label = c('PUB-rich PE or PC 500 nm'))

# arrowdf1 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
# arrowdf2 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
# arrowdf3 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
# arrowdf4 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
# arrowdf5 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)
# arrowdf6 <- tibble(Strain = "BA127R", E_days = 3, Par_ue = 300)


OLISSpectraMetaAllPURPlot <- OLISSpectraMetaAllPURShort %>%
  filter(Photoperiod == "12") %>%
  filter(Strain == "BA77G" | Strain == "BA127R") %>%
  filter(Par_ue == 300) %>%
  filter(E_days == "3" | E_days == "7") %>%
  ggplot() +

  geom_area(aes(x = nm, y = EmNormJaz439, fill = "gray84"), alpha = 0.6, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA127R, fill = "brown4"), alpha = 0.5, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA77G, fill = "palegreen3"), alpha = 0.5, show.legend = F) +
  geom_line(aes(x = nm, y = AbsNorm440, colour = as.factor(Strain), linetype = as.factor(Strain)), show.legend = F, size = 0.7) +

  geom_text(data=data_textPUR0, aes(x=446, y=1.26, label=label), size=3.7) +
  geom_text(data=data_textPUR00, aes(x=446, y=1.26, label=label), size=3.7) +
  geom_text(data=data_textPUR1, aes(x=446, y=1.21, label=label), size=3.7) +
  geom_text(data=data_textPUR2, aes(x=446, y=1.21, label=label), size=3.7) +

  geom_text(data=data_textpigment1, aes(x=500, y=1.1, label=label), size=4, colour = "darkgreen") + #chla440
  geom_text(data=data_textpigment5, aes(x=500, y=0.8, label=label), size=4, colour = "orange") + #Car
  geom_text(data=data_textpigment2, aes(x=580, y=1.0, label=label), size=4, colour = "darkmagenta") + #PE
  geom_text(data=data_textpigment3, aes(x=650, y=1.2, label=label), size=4, colour = "darkgreen") +#chla680
  geom_text(data=data_textpigment4, aes(x=600, y=0.17, label=label), size=4, colour = "deepskyblue4") + #PC
  geom_text(data=data_textpigment6, aes(x=485, y=0.35, label=label), size=4, colour = "sienna4") + #PUB

  geom_segment(data = arrowdf1,
               aes(x = 480, xend = 445, y = 1.05, yend = 1),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla440
  geom_segment(data = arrowdf5,
               aes(x = 480, xend = 475, y = 0.75, yend = 0.55),
               colour = "orange", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #Car
  geom_segment(data = arrowdf2,
               aes(x = 590, xend = 575, y = 0.95, yend = 0.85),
               colour = "darkmagenta", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PE
  geom_segment(data = arrowdf3,
               aes(x = 660, xend = 680, y = 1.14, yend = 0.85),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla680
  geom_segment(data = arrowdf4,
               aes(x = 610, xend = 630, y = 0.2, yend = 0.3),
               colour = "deepskyblue4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PC
  geom_segment(data = arrowdf4,
               aes(x = 490, xend = 500, y = 0.40, yend = 0.52),
               colour = "sienna4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PUB

  scale_color_manual(values = c("BA77G" ="palegreen3", "BA127R" ="brown4")) +
  scale_linetype_manual(values = c("BA77G" ="solid", "BA127R" ="longdash")) +

  stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.025, alpha = 0.5) +
  scale_fill_identity() +

  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c (-0.01, 1.25)) +
  ggh4x::facet_nested(cols = vars(Par_ue, E_days), rows = vars(Strain),labeller = labeller(Ex_WL = label_both, WL = label_both, E_days = E_days.labs, Photoperiod = Photoperiod.labs, Par_ue = Par_ue.labs, Strain = Strain.labs)) +
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
OLISSpectraMetaAllPURPlot


```




Only for nice PUR/PAR ratio plot - photoperiod and Par_ue - delete multiple data for 16h and 900uE
```{r}
OLISSpectraMetaAllPURPARRatioClean2 <- OLISSpectraMetaAllPURPARRatioClean %>%
      mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

OLISSpectraMetaAllPURPARRatioClean3 <- OLISSpectraMetaAllPURPARRatioClean2 %>%
  filter(Par_ue == 900) %>%
  filter(Photoperiod == "16") %>%
  filter(E_days == 4)

OLISSpectraMetaAllPURPARRatioClean4 <- OLISSpectraMetaAllPURPARRatioClean2 %>%
  filter(Par_ue == 900) %>%
  filter(Photoperiod != "16")

OLISSpectraMetaAllPURPARRatioClean5 <- OLISSpectraMetaAllPURPARRatioClean2 %>%
  filter(Par_ue != 900)

OLISSpectraMetaAllPURPARRatioClean2 <- rbind(OLISSpectraMetaAllPURPARRatioClean3, OLISSpectraMetaAllPURPARRatioClean4, OLISSpectraMetaAllPURPARRatioClean5)


rm(OLISSpectraMetaAllPURPARRatioClean3, OLISSpectraMetaAllPURPARRatioClean4, OLISSpectraMetaAllPURPARRatioClean5,OLISSpectraMetaAllPURPARRatioClean)
```


#OLISSpectraMetaAllPURPARRatioClean2 <-delete multiple data for 16h and 900uE - all PUR and PAR data


```{r}
colnames(OLISSpectraMetaAllPURPARRatioCleanExpPUR)

OLISSpectraMetaAllPURPARRatioCleanExpPUR<-OLISSpectraMetaAllPURPARRatioCleanExpPUR %>% 
mutate(SpectraDateExp = SpectraDate) %>% 
mutate(E_daysExp = E_days) %>% 
mutate(PURExp = PUR) %>% 
mutate(PURPhotonDoseExp = PURPhotonDose) %>% 
mutate(PURPARRatioExp = PURPARRatio) %>% 
mutate(Time_hExp = Time_h) %>% 
select(-c(Tube,"Filename.x",SpectraDate,E_days,PUR,PURPhotonDose,PURPARRatio,Time_h))


OLISSpectraMetaAllPURPARRatioCleanStatPUR<-OLISSpectraMetaAllPURPARRatioCleanStatPUR %>% 
mutate(SpectraDateSt = SpectraDate) %>% 
mutate(E_daysSt = E_days) %>% 
mutate(PURSt = PUR) %>% 
mutate(PURPhotonDoseSt = PUR) %>% 
mutate(PURPARRatioSt = PURPARRatio) %>% 
mutate(Time_hSt = PURPARRatio) %>% 
select(-c(Tube,"Filename.x",SpectraDate,E_days,PUR,PURPhotonDose,PURPARRatio,Time_h))


OLISSpectraMetaPURExpSt <- OLISSpectraMetaAllPURPARRatioCleanExpPUR %>%
  left_join(., OLISSpectraMetaAllPURPARRatioCleanStatPUR, by = c("Run"="Run","ID"="ID","Strain"="Strain","InnocDate"="InnocDate","ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","LightShape"="LightShape","PARPhotonDose"="PARPhotonDose")) 

rm(OLISSpectraMetaAllPURPARRatioCleanExpPUR,OLISSpectraMetaAllPURPARRatioCleanStatPUR)
```



```{r}

data_vline1 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(347,321.02,240.90,187.92,110,347,245.39,189.48,162.62,110,347,168.39,113.76,111.56,110,154.64,114.68,93.32,93.78,110))

data_vline2 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(346,319.92,240.81,214.41,109.5,346,216.33,163.44,136.03,109.5,299.38,166.28,137.32,111.28,109.45,119.35,103.77,100.38,79.20,94.23))

data_vline3 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(345,347,266.84,240.72,109,345,296.45,217.80,191.03,109,345,191.49,114.95,112.75,108,157.85,120.27,110.28,95.79,79.66))

data_vline4 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(344, 345, 266.93, 215.42, 108.5,344, 244.38,190.39,163.62,108.5,299.57, 168.85, 137.50, 112.29, 107,138.78, 120.18, 108.08, 98.36, 107))

```



PUR/PAR ratio - photoperiod and PAR
```{r fig.height = 8, fig.width = 8}

#OLISSpectraMetaAllPURPARRatioCleanExpPUR <- OLISSpectraMetaAllPURPARRatioClean2 %>%

OLISSpectraMetaPURExpSt$facets = factor(OLISSpectraMetaPURExpSt$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))

OLISSpectraMetaPURExpSt$facets2 = factor(OLISSpectraMetaPURExpSt$WL, labels = c("Photoperiod~(h)"))



lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# Par_ue.labs <- c("30", "90", "180", "300", "900")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# Photoperiod.labs <- c("8", "12", "16", "24")
# names(Photoperiod.labs) <- c("8", "12", "16", "24")
# WL.labs <- c("Photoperiod (h)")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level (µE)")
# names(O2.labs) <- c(21)

Plot <- OLISSpectraMetaPURExpSt %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_hExp, y = PURPARRatioExp, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +

  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.97),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot




Plot <- OLISSpectraMetaPURExpSt %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_hSt, y = PURPARRatioSt, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.97),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot




OLISSpectraMetaAllPURPARRatioClean2$facets = factor(OLISSpectraMetaAllPURPARRatioClean2$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
OLISSpectraMetaAllPURPARRatioClean2$facets2 = factor(OLISSpectraMetaAllPURPARRatioClean2$WL, labels = c("Photoperiod~(h)"))

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# Par_ue.labs <- c("30", "90", "180", "300", "900")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# Photoperiod.labs <- c("8", "12", "16", "24")
# names(Photoperiod.labs) <- c("8", "12", "16", "24")
# WL.labs <- c("Photoperiod (h)")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level (µE)")
# names(O2.labs) <- c(21)

Plot <- OLISSpectraMetaAllPURPARRatioClean2 %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.97),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot


```

PAR vs PUR exp
```{r fig.height = 5, fig.width = 8}

# scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# 
# PARvsPURPlot <- OLISSpectraMetaAllPURPARRatioCleanExpPUR %>%
#   ggplot() +
#   geom_point(aes(x = PUR, y = Par_ue, colour = as.factor(Strain), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3, show.legend = T) +
#   
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#     scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
#    scale_x_continuous(label=scientific_10) +
#    scale_y_continuous(label=scientific_10) +
#   labs(y = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
#   # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
#   # coord_cartesian(ylim = c(0, 1.7)) +
#   # ggh4x::facet_nested(cols = vars(WL, Photoperiod), rows = vars(O2, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.09,0.80),
#         legend.key.height= unit(0.005, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=10))
# PARvsPURPlot


```

df for all PAR photondose
```{r}

# data_vline5 <- data.frame(PARPhotonDose= c(432000,54000,108000,180000,540000,27000,1944000,3888000,6480000,810000,864000,108000,216000,8640000,1080000,1080000,324000,648000,1080000,77760000),facets=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(347,321.02,240.90,187.92,110,347,245.39,189.48,162.62,110,347,168.39,113.76,111.56,110,154.64,114.68,93.32,93.78,110))
# 
# 
# data_vline6 <- data.frame(PARPhotonDose= c(432000,54000,108000,180000,540000,27000,1944000,3888000,6480000,810000,864000,108000,216000,8640000,1080000,1080000,324000,648000,1080000,77760000),facets=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(346,319.92,240.81,214.41,109.5,346,216.33,163.44,136.03,109.5,299.38,166.28,137.32,111.28,109.45,119.35,103.77,100.38,79.20,94.23))
# 
# data_vline7 <- data.frame(PARPhotonDose= c(432000,54000,108000,180000,540000,27000,1944000,3888000,6480000,810000,864000,108000,216000,8640000,1080000,1080000,324000,648000,1080000,77760000),facets=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(345,347,266.84,240.72,109,345,296.45,217.80,191.03,109,345,191.49,114.95,112.75,108,157.85,120.27,110.28,95.79,79.66))
# 
# data_vline8 <- data.frame(PARPhotonDose= c(432000,54000,108000,180000,540000,27000,1944000,3888000,6480000,810000,864000,108000,216000,8640000,1080000,1080000,324000,648000,1080000,77760000),facets=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(344, 345, 266.93, 215.42, 108.5,344, 244.38,190.39,163.62,108.5,299.57, 168.85, 137.50, 112.29, 107,138.78, 120.18, 108.08, 98.36, 107))

```



```{r}


# data_vline1 <- data.frame(PARPhotonDose= c(432000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(347))
# data_vline2 <- data.frame(PARPhotonDose= c(432000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(346))
# data_vline3 <- data.frame(PARPhotonDose= c(432000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(345))
# data_vline4 <- data.frame(PARPhotonDose= c(432000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(344))
# 
# # data_vline5 <- data.frame(PhotonDose= c(54000),WL= c("WW"),value = c(321.02))
# # data_vline6 <- data.frame(PhotonDose= c(54000),WL= c("WW"),value = c(319.92))
# # data_vline7 <- data.frame(PhotonDose= c(54000),WL= c("WW"),value = c(347))
# # data_vline8 <- data.frame(PhotonDose= c(54000),WL= c("WW"),value = c(345))
# 
# # data_vline9 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(240.90))
# # data_vline10 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(240.81))
# # data_vline11 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(266.84))
# # data_vline12 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(266.93))
# 
# # data_vline13 <- data.frame(PhotonDose= c(180000),WL= c("WW"),value = c(187.92))
# # data_vline14 <- data.frame(PhotonDose= c(180000),WL= c("WW"),value = c(214.41))
# # data_vline15 <- data.frame(PhotonDose= c(180000),WL= c("WW"),value = c(240.72))
# # data_vline16 <- data.frame(PhotonDose= c(180000),WL= c("WW"),value = c(215.42))
# 
# # data_vline17 <- data.frame(PhotonDose= c(540000),WL= c("WW"),value = c(110))
# # data_vline18 <- data.frame(PhotonDose= c(540000),WL= c("WW"),value = c(109.5))
# # data_vline19 <- data.frame(PhotonDose= c(540000),WL= c("WW"),value = c(109))
# # data_vline20 <- data.frame(PhotonDose= c(540000),WL= c("WW"),value = c(108.5))
# 
# # data_vline21 <- data.frame(PhotonDose= c(27000),WL= c("WW"),value = c(347))
# # data_vline22 <- data.frame(PhotonDose= c(27000),WL= c("WW"),value = c(346))
# # data_vline23 <- data.frame(PhotonDose= c(27000),WL= c("WW"),value = c(345))
# # data_vline24 <- data.frame(PhotonDose= c(27000),WL= c("WW"),value = c(344))
# 
# data_vline25 <- data.frame(PARPhotonDose= c(1944000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(245.39))
# data_vline26 <- data.frame(PARPhotonDose= c(1944000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(216.33))
# data_vline27 <- data.frame(PARPhotonDose= c(1944000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(296.45))
# data_vline28 <- data.frame(PARPhotonDose= c(1944000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(244.38))
# 
# data_vline29 <- data.frame(PARPhotonDose= c(3888000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(189.48))
# data_vline30 <- data.frame(PARPhotonDose= c(3888000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(163.44))
# data_vline31 <- data.frame(PARPhotonDose= c(3888000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(217.80))
# data_vline32 <- data.frame(PARPhotonDose= c(3888000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(190.39))
# 
# data_vline33 <- data.frame(PARPhotonDose= c(6480000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(162.62))
# data_vline34 <- data.frame(PARPhotonDose= c(6480000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(136.03))
# data_vline35 <- data.frame(PARPhotonDose= c(6480000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(191.03))
# data_vline36 <- data.frame(PARPhotonDose= c(6480000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(163.62))
# 
# # data_vline37 <- data.frame(PhotonDose= c(810000),WL= c("WW"),value = c(110))
# # data_vline38 <- data.frame(PhotonDose= c(810000),WL= c("WW"),value = c(109.5))
# # data_vline39 <- data.frame(PhotonDose= c(810000),WL= c("WW"),value = c(109))
# # data_vline40 <- data.frame(PhotonDose= c(810000),WL= c("WW"),value = c(108.5))
# 
# data_vline41 <- data.frame(PARPhotonDose= c(864000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(347))
# data_vline42 <- data.frame(PARPhotonDose= c(864000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(299.38))
# data_vline43 <- data.frame(PARPhotonDose= c(864000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(345))
# data_vline44 <- data.frame(PARPhotonDose= c(864000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(299.57))
# 
# # data_vline45 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(168.39))
# # data_vline46 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(166.28))
# # data_vline47 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(191.49))
# # data_vline48 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(168.85))
# 
# # data_vline49 <- data.frame(PhotonDose= c(216000),WL= c("WW"),value = c(113.76))
# # data_vline50 <- data.frame(PhotonDose= c(216000),WL= c("WW"),value = c(137.32))
# # data_vline51 <- data.frame(PhotonDose= c(216000),WL= c("WW"),value = c(114.95))
# # data_vline52 <- data.frame(PhotonDose= c(216000),WL= c("WW"),value = c(137.50))
# 
# data_vline53 <- data.frame(PARPhotonDose= c(8640000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(111.56))
# data_vline54 <- data.frame(PARPhotonDose= c(8640000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(111.28))
# data_vline55 <- data.frame(PARPhotonDose= c(8640000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(112.75))
# data_vline56 <- data.frame(PARPhotonDose= c(8640000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(112.29))
# 
# # data_vline57 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(110))
# # data_vline58 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(109.45))
# # data_vline59 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(108))
# # data_vline60 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(107))
# 
# # data_vline61 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(154.64))
# # data_vline62 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(119.35))
# # data_vline63 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(157.85))
# # data_vline64 <- data.frame(PhotonDose= c(108000),WL= c("WW"),value = c(138.78))
# 
# # data_vline65 <- data.frame(PhotonDose= c(324000),WL= c("WW"),value = c(114.68))
# # data_vline66 <- data.frame(PhotonDose= c(324000),WL= c("WW"),value = c(103.77))
# # data_vline67 <- data.frame(PhotonDose= c(324000),WL= c("WW"),value = c(120.27))
# # data_vline68 <- data.frame(PhotonDose= c(324000),WL= c("WW"),value = c(120.18))
# 
# # data_vline69 <- data.frame(PhotonDose= c(648000),facets= c("Photon~dose~(µmol~photons~m^{-2}~h^{-1})"),value = c(93.32))
# # data_vline70 <- data.frame(PhotonDose= c(648000),facets= c("Photon~dose~(µmol~photons~m^{-2}~h^{-1})"),value = c(100.38))
# # data_vline71 <- data.frame(PhotonDose= c(648000),facets= c("Photon~dose~(µmol~photons~m^{-2}~h^{-1})"),value = c(110.28))
# # data_vline72 <- data.frame(PhotonDose= c(648000),facets= c("Photon~dose~(µmol~photons~m^{-2}~h^{-1})"),value = c(108.08))
# 
# # data_vline73 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(93.78))
# # data_vline74 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(79.20))
# # data_vline75 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(95.79))
# # data_vline76 <- data.frame(PhotonDose= c(1080000),WL= c("WW"),value = c(98.36))
# 
# data_vline77 <- data.frame(PARPhotonDose= c(77760000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(110))
# data_vline78 <- data.frame(PARPhotonDose= c(77760000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(94.23))
# data_vline79 <- data.frame(PARPhotonDose= c(77760000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(79.66))
# data_vline80 <- data.frame(PARPhotonDose= c(77760000),facets= c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),value = c(107))

```

df for choosen PAR photondose data
```{r}


data_vline5 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(347, 245.39,189.48,162.62, 347, 111.56,110))


data_vline6 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(346, 216.33,163.44,136.03, 299.38,111.28,94.23))

data_vline7 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(345, 296.45,217.80,191.03, 345,112.75,79.66))

data_vline8 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(344, 244.38,190.39,163.62, 299.57, 112.29, 107))

```



PUR/PAR ratio vs PARphotondose
```{r fig.height = 5, fig.width = 8}

OLISSpectraMetaAllPURPARRatioClean2$facets3 = factor(OLISSpectraMetaAllPURPARRatioClean2$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# Photoperiod.labs <- c("8 h", "12 h", "16 h", "24 h")
# names(Photoperiod.labs) <- c("8", "12", "16", "24")
# WL.labs <- c("Photon dose")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level")
# names(O2.labs) <- c(21)


# data_text <- data.frame(
#   facets   = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),
#   PARPhotonDose = c(77760000),
#   label = c('B'))

Plot <- OLISSpectraMetaAllPURPARRatioClean2 %>%
  #filter(Photoperiod != "24") %>%
  #filter(Par_ue != 900) %>%
  filter(PURPARRatio<=1) %>% 
  # filter(PhotonDose!= 540000) %>% 
  # filter(PhotonDose!= 648000) %>% 
  # filter(PhotonDose!= 810000) %>%
  # filter(PhotonDose!= 324000) %>%
  # filter(PhotonDose!= 54000) %>%
  # filter(PhotonDose!= 1080000) %>%
  # filter(PhotonDose!= 27000) %>%
  # filter(PhotonDose!= 180000) %>%
  # filter(PhotonDose!= 108000) %>%
  # filter(PhotonDose!= 216000) %>%
  # 
  
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%

  #filter(E_days != "1") %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  
  #geom_text(data=data_text, aes(x=300, y=1.45, label=label), size=5) +
  
  # geom_hline(yintercept = 0.32, linetype="dotted", colour = "palegreen3") +
  # geom_hline(yintercept = 0.4, linetype="dotted", colour = "brown1") +
  # 
  # geom_hline(yintercept = 0.31, linetype="dotted", colour = "palegreen4") +
  # geom_hline(yintercept = 0.39, linetype="dotted", colour = "brown4") +
  
  geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +

  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.5)) +
  ggh4x::facet_nested(cols = vars(facets3, PARPhotonDose), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets, PhotonDose), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = label_parsed, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11.5),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.065,0.91),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot


```

PUR/PAR ratio vs PARphotondose
```{r fig.height = 8, fig.width = 8}

OLISSpectraMetaAllPURPARRatioClean2$facets3 = factor(OLISSpectraMetaAllPURPARRatioClean2$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# Photoperiod.labs <- c("8 h", "12 h", "16 h", "24 h")
# names(Photoperiod.labs) <- c("8", "12", "16", "24")
# WL.labs <- c("Photon dose")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level")
# names(O2.labs) <- c(21)


# data_text <- data.frame(
#   facets   = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),
#   PARPhotonDose = c(77760000),
#   label = c('B'))

Plot <- OLISSpectraMetaAllPURPARRatioClean2 %>%
  #filter(Photoperiod != "24") %>%
  #filter(Par_ue != 900) %>%
  filter(PURPARRatio<=1) %>% 

  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  
  # geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  # geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  # geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  # geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +

  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.5)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets, PhotonDose), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = label_parsed, O2 = O2.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11.5),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.065,0.91),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot


```


```{r}
rm(OLISSpectraMetaAllPURPARRatioClean2)
```

#OLISSpectraMetaAllPURPARRatioClean - the same data in MultiCultiDataCleanGrowth2


665 - chl
480 - car
565	- PE
620	- PC
650 - APC

pigments corelation - to get raw spectra (without dilution factor from olis, I multipied Absorbance *7; 1ml culture and 7 ml of f2 media from olis)


Pearson Correlation Coefficient and Linear Regression and coefficient of determination or R²  - filter method
https://www.datacamp.com/tutorial/linear-regression-R
```{r}

ClarioPigmentFileDataAll2Chla <- ClarioPigmentFileDataAll2 %>% 
    filter(Strain != "BA127R") 
my_dataChla <- ClarioPigmentFileDataAll2Chla
ggscatter(my_dataChla, x = "Abs665", y = "Chla_ugmL", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson")
my_dataChla
lmChla = lm(Chla_ugmL~Abs665, data = my_dataChla)
summary(lmChla)
# ChlaugmL = (Abs665*13.411029)+0.154793
# Adjusted R-squared: 0.8654
# R=0.93


ClarioPigmentFileDataAll2Car <- ClarioPigmentFileDataAll2 %>% 
    filter(Strain != "BA127R") 
my_dataCar <- ClarioPigmentFileDataAll2Car
ggscatter(my_dataCar, x = "Abs480", y = "Car_ugmL", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson")
my_dataCar
lmCar = lm(Car_ugmL~Abs480, data = my_dataCar)
summary(lmCar)
# CarugmL = (Abs480*5.469880)+0.089971
# Adjusted R-squared: 0.7913
# R=0.89



ClarioPigmentFileDataAll2PE <- ClarioPigmentFileDataAll2 %>% 
    filter(PE_ugmL < 10) %>% 
    filter(Strain != "BA56G")
my_dataPE <- ClarioPigmentFileDataAll2PE
ggscatter(my_dataPE, x = "Abs565", y = "PE_ugmL", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson")
my_dataPE
lmPE = lm(PE_ugmL~Abs565, data = my_dataPE)
summary(lmPE)
# PEugmL = (Abs565*26.760737)-0.143872
# Adjusted R-squared:  0.6979
# R=0.84


ClarioPigmentFileDataAll2PC <- ClarioPigmentFileDataAll2 %>% 
    filter(Strain != "BA56G")
my_dataPC <- ClarioPigmentFileDataAll2PC
ggscatter(my_dataPC, x = "Abs620", y = "PC_ugmL", 
          # color = "Strain",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson")
my_dataPC
lmPC = lm(PC_ugmL~Abs620, data = my_dataPC)
summary(lmPC)
# PCugmL = (Abs620*29.979866)-0.182611
# Adjusted R-squared:  0.8073
# R=0.9


ClarioPigmentFileDataAll2APC <- ClarioPigmentFileDataAll2 
my_dataAPC <- ClarioPigmentFileDataAll2APC
ggscatter(my_dataAPC, x = "Abs650", y = "APC_ugmL", 
          # color = "Strain",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson")
my_dataAPC
lmPC = lm(APC_ugmL~Abs650, data = my_dataAPC)
summary(lmPC)
# APCugmL = (Abs620*3.873803)+0.021964
# Adjusted R-squared:  0.08721
# R=0.19



```

```{r}

rm(ClarioPigmentFileDataAll2Chla,my_dataChla, ClarioPigmentFileDataAll2Car, my_dataCar, ClarioPigmentFileDataAll2PE, my_dataPE, ClarioPigmentFileDataAll2PC, my_dataPC, ClarioPigmentFileDataAll2APC, my_dataAPC)

```


Calculated pigment content based on Olis calibration
#ClarioPigmentFileDataAll2Olis <- contained pigments per ml based on Clariostar (eg chla_ugmL) and Olis (eg chlaugmL)
```{r}


# ClarioPigmentFileDataAll2Olis <- ClarioPigmentFileDataAll2 %>% 
# 
#   mutate(ChlaugmL = (Abs665*13.411029)+0.154793) %>% 
#   mutate(CarugmL = (Abs480*5.469880)+0.089971) %>% 
#   mutate(PEugmL = (Abs565*26.760737)-0.143872) %>% 
#   mutate(PCugmL = (Abs620*29.979866)-0.182611) %>% 
#   mutate(APCugmL = (Abs650*3.873803)+0.021964) 

rm(ClarioPigmentFileDataAll2)

```



Growth file
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "SySlmanuscriptWWPhotoperiod", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```

Growth file
Exported Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Growth file
```{r read ProcessFile}

#Growth rate combined with all PUR data
MultiCultiDataCleanGrowth2File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_MultiCultiDataCleanGrowth2.Rds"
MultiCultiDataCleanGrowth2FileName <- str_split(string = MultiCultiDataCleanGrowth2File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MultiCultiDataCleanGrowth2 <- readRDS(MultiCultiDataCleanGrowth2File)  %>%
  ungroup()

#Growth rate with flags and SE combined with only exp PUR data - 80 values
MultiCultiDataCleanGrowth3File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_MultiCultiDataCleanGrowth3.Rds"
MultiCultiDataCleanGrowth3FileName <- str_split(string = MultiCultiDataCleanGrowth3File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MultiCultiDataCleanGrowth3 <- readRDS(MultiCultiDataCleanGrowth3File)  %>%
  ungroup()

#data necessary for plot growth curve (round time) for all runs - contained od750, od680 and Actinic Par data
MultiCultiDataAllStrainsokFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_MultiCultiDataAllStrainsokAll.Rds"
MultiCultiDataAllStrainsokFileName <- str_split(string = MultiCultiDataAllStrainsokFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MultiCultiDataAllStrainsok <- readRDS(MultiCultiDataAllStrainsokFile)  %>%
  ungroup()

#contained mean od per day from Multiculti and based on this od calculated pigments per mL and per cell (pg/cell)
MultiCultiPigmentMaxFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_MultiCultiPigmentMax.Rds"
MultiCultiPigmentMaxFileName <- str_split(string = MultiCultiPigmentMaxFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MultiCultiPigmentMax <- readRDS(MultiCultiPigmentMaxFile)  %>%
  ungroup()

#contained pigments only from exp growth - 80 values (now 72 - fix this Sylwia!!!!)
MultiCultiPigmentExp2File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_MultiCultiPigmentExp2.Rds"
MultiCultiPigmentExp2FileName <- str_split(string = MultiCultiPigmentExp2File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MultiCultiPigmentExp <- readRDS(MultiCultiPigmentExp2File)  %>%
  ungroup()


```

```{r}

#colnames(MultiCultiPigmentMax)


MultiCultiPigmentMax<-MultiCultiPigmentMax %>% 
  mutate(MultiDay=Day) %>% 
  mutate(OlisDate = Date) %>% 
  select(-c(meanActinic_parDay,FilenameMultiCulti,Filename,Day,Date))  
  
MultiCultiDataCleanGrowth2<-MultiCultiDataCleanGrowth2 %>% 
    # mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
    #      Strain=="BA48R"~"PE-rich_048",
    #     Strain=="BA56G"~"PC-rich_056",
    #      Strain=="BA77G"~"PC-rich_077")) %>%
  select(-c("Filename.x", Filename))


MultiCultiPigmentMaxAll <- MultiCultiPigmentMax %>%
  left_join(., MultiCultiDataCleanGrowth2, by = c("Run"="Run","ID"="ID", "Tube"="Tube", "Strain"="Strain", "InnocDate"="InnocDate","ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","LightShape"="LightShape","PARPhotonDose"="PARPhotonDose", "Time_h"="Time_h")) 

rm(MultiCultiPigmentMax,MultiCultiDataCleanGrowth2)
```



```{r}
MultiCultiDataCleanGrowth3 <- MultiCultiDataCleanGrowth3 %>%
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 


MultiCultiDataCleanGrowth31 <- MultiCultiDataCleanGrowth3 %>%
  filter(Run==77) %>% 
  filter(Tube != 6) %>% 
  filter(Tube != 3) 
  
MultiCultiDataCleanGrowth32 <- MultiCultiDataCleanGrowth3 %>%
  filter(Run==121) %>% 
  filter(Tube != 6) %>% 
  filter(Tube != 3) 

MultiCultiDataCleanGrowth33 <- MultiCultiDataCleanGrowth3 %>%
  filter(Run!=77) %>% 
  filter(Run!=121)  

MultiCultiDataCleanGrowthFilter<-rbind(MultiCultiDataCleanGrowth31,
                                       MultiCultiDataCleanGrowth32,
                                       MultiCultiDataCleanGrowth33)
```


Manuscript plot - growth -> x-PAR photon dose
Manuscript plot - growth -> x-PUR photon dose
```{r fig.height = 5.5, fig.width = 8, warning = FALSE}

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))

# data_textA <- data.frame(
#   O2 = c(21),
#   Strain  = c("PE-rich_127"),
#   label = c("A"))

# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
#Delta_2
# Strain.labs <- c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127")
# names(Strain.labs) <- c("BA56G", "BA77G", "BA48R", "BA127R")
# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# WL.labs <- c("Strain")
# names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

Plot <- MultiCultiDataCleanGrowthFilter %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # labs(shape="Photoperiod (h)", colour="Strain") +
   geom_errorbar(aes(x = PARPhotonDose, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=6000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  #geom_text(data=data_textA, aes(x=78000000, y=0.25, label=label), size=5) +
  # scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  # coord_cartesian(xlim = c(6, 26)) +
  # scale_y_continuous(breaks=seq(0, 0.3, by = 0.1)) +
  # coord_cartesian(ylim = c(0, 0.3)) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
    # ggh4x::facet_nested(cols = vars(Strain), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  # scale_y_continuous(trans = log10_trans(),
  #                    breaks = trans_breaks("log10", function(x) 10^x),
  #                    labels = trans_format("log10", math_format(10^.x))) +
  # annotation_logticks(sides = "l", colour = "gray60") +
  #scale_x_continuous(labels = comma) + 
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.06,0.80),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot



lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
# data_textB <- data.frame(
#   O2 = c(21),
#   Strain  = c("PE-rich_127"),
#   label = c("B"))
# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
#Delta_2
# Strain.labs <- c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127")
# names(Strain.labs) <- c("BA56G", "BA77G", "BA48R", "BA127R")
# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# WL.labs <- c("Strain")
# names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

Plot <- MultiCultiDataCleanGrowth3 %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  # geom_smooth(aes(x = Photoperiod, y = deltaOD_Lmu_corr, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = F) +
  geom_point(aes(x = PURPhotonDose, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) + 
    #geom_text(data=data_textB, aes(x=32000000, y=0.25, label=label), size=5) +

  # labs(shape="Photoperiod (h)", colour="Strain") +
   geom_errorbar(aes(x = PURPhotonDose, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +

  # scale_x_continuous(breaks=seq(0, 20000000, by = 10000000)) +
  # coord_cartesian(xlim = c(-500, 37000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  # scale_y_continuous(trans = log10_trans(),
  #                    breaks = trans_breaks("log10", function(x) 10^x),
  #                    labels = trans_format("log10", math_format(10^.x))) +
  #annotation_logticks(sides = "l", colour = "gray60") +
  #scale_x_continuous(labels = comma) + 
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.06,0.80),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot

```
Plot arrange
```{r fig.height = 11, fig.width = 8, warning = FALSE}
# 
# library(ggpubr)
# ggarrange(GrowthratePAR,GrowthratePUR,
#           ncol = 1, nrow = 2)
```


Load MaxGrowth catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

MaxGrowthMetaData <- read_sheet("https://docs.google.com/spreadsheets/d/10KUt0r2I6eOPPkBGIDMhh3-KyVVRW8FFIPXtK-PZqi8/edit#gid=0") 

as.data.frame(MaxGrowthMetaData)
MaxGrowthMetaData <- MaxGrowthMetaData 

```
#MaxGrowthMetaData contained max growth per day and per h and max deriv - 80 values

```{r}
#colnames(ClarioOlisPigmentSmall)

MaxGrowthMetaData<-MaxGrowthMetaData %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>% 
  mutate(Photoperiod = as.double(Photoperiod)) %>% 
  mutate(MaxGrowthH = as.numeric(MaxGrowthH)) %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 

MaxGrowth2 <- MultiCultiDataCleanGrowth3 %>%
  left_join(., MaxGrowthMetaData, by = c("Strain" = "Strain", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod")) 

rm(MaxGrowthMetaData, MultiCultiDataCleanGrowth3)

```

#MaxGrowth2 contained exp PUR, growth rate with se and flags, and max growth per day, per h and max deriv - 80 values

```{r}

#colnames(MaxGrowth2)

MaxGrowth3<-MaxGrowth2 %>% 
  select(-c("Filename.x", SpectraDate, E_days, PUR,PURPhotonDose,PURPARRatio,Time_h,MaxMin_derivRatio,Max,Filename))

MaxGrowthExpSt <- MaxGrowth3 %>%
  left_join(., OLISSpectraMetaPURExpSt, by = c("Run"="Run","ID"="ID","Strain"="Strain","InnocDate"="InnocDate","ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","LightShape"="LightShape","PARPhotonDose"="PARPhotonDose")) 

rm(OLISSpectraMetaPURExpSt,MaxGrowth3,MaxGrowth2)

```

#MaxGrowthExpSt contained exp and st PUR, growth rate with se and flags, and max growth per day, per h and max deriv - 80 values





STATISTICS

```{r}
# library("writexl")
# write_xlsx(MultiCultiDataCleanGrowth,"C:/Users/Lenovo/Desktop/JassbyPlatt//growthrateWWPhotoperiod.xlsx")

```

Two factor ANOVA without replication
```{r}
# result <- aov(response ~ factor.A + factor.B + factor.A:factor.B, data = fever)
# summary(result)

# GrowthBA127R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_127")
# GrowthBA127R <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA127R)
# anova(GrowthBA127R)
# 
# GrowthBA127R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_127")
# GrowthBA127R <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA127R)
# anova(GrowthBA127R)
# 
# 
# GrowthBA48R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_048")
# GrowthBA48R <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA48R)
# anova(GrowthBA48R)
# 
# GrowthBA48R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_048")
# GrowthBA48R <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA48R)
# anova(GrowthBA48R)
# 
# 
# GrowthBA56G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_056")
# GrowthBA56G <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA56G)
# anova(GrowthBA56G)
# 
# GrowthBA56G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_056")
# GrowthBA56G <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA56G)
# anova(GrowthBA56G)
# 
# 
# GrowthBA77G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_077")
# GrowthBA77G <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA77G)
# anova(GrowthBA77G)
# 
# GrowthBA77G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_077")
# GrowthBA77G <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA77G)
# anova(GrowthBA77G)

```

Tukey test
```{r}

# GrowthBA77G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_077")
# data.aov.factor = aov(deltaOD_Lmu_corr ~ factor(Par_ue) + factor(Photoperiod), data = GrowthBA77G)
# TukeyHSD(data.aov.factor)


# letters
#https://stackoverflow.com/questions/69309101/automatically-adding-letters-of-significance-to-a-ggplot-barplot-using-output-fr


```

```{r}
MultiCultiDataAllStrainsok2 <- MultiCultiDataAllStrainsok %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 

MultiCultiDataAllStrainsok2 <- MultiCultiDataAllStrainsok2 %>% 
  group_by(ID, timeRound) %>% 
  mutate(DeltaOD = meanOD680-meanOD720) %>% 
ungroup()

MultiCultiDataAllStrainsok2 <- MultiCultiDataAllStrainsok2 %>% 
  filter(Par_ue != 600) %>% 
  filter(Run!=77)


MultiCultiDataAllStrainsok3 <- MultiCultiDataAllStrainsok2 %>% 
  filter(Par_ue==900) %>% 
  filter(timeRound<=170)

MultiCultiDataAllStrainsok4 <- MultiCultiDataAllStrainsok2 %>% 
  filter(Photoperiod==24) %>% 
  filter(timeRound<=170)

MultiCultiDataAllStrainsok5 <- MultiCultiDataAllStrainsok2 %>% 
  filter(Photoperiod!=24) %>% 
  filter(Par_ue!=900)

MultiCultiDataAllStrainsok6<- rbind(MultiCultiDataAllStrainsok3, MultiCultiDataAllStrainsok4, MultiCultiDataAllStrainsok5)

```


Growth curve - per strain combine with max growth
```{r fig.height = 8, fig.width = 8, warning = FALSE}


MultiCultiDataAllStrainsok$facets = factor(MultiCultiDataAllStrainsok$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))

MultiCultiDataAllStrainsok$facets2 = factor(MultiCultiDataAllStrainsok$WL, labels = c("Photoperiod~(h)"))

# lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

# Par_ue.labs <- c("30", "90", "180", "300", "900")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# 
# Photoperiod.labs <- c("8", "12", "16", "24")
# names(Photoperiod.labs) <- c("8", "12", "16", "24")

# WL.labs <- c("Photoperiod (h)")
# names(WL.labs) <- c("WW")

# O2.labs <- c("Light level")
# names(O2.labs) <- c(21)

Plot <- MultiCultiDataAllStrainsok6 %>%
  #filter(timeRound <= 110) %>%
  ggplot() +
  geom_area(aes(x = timeRound, y = meanActinic_par), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = timeRound, y = meanOD680, colour = as.factor(Strain)), size = 0.7, show.legend = T) +

  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  labs(y = "Optical density ("~OD[680]~")", x = "Elapsed time (h)") +

    # ggh4x::facet_nested(rows = vars(WL, Photoperiod), cols = vars(O2, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs), scale="free_x") +
  
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed, scale="free_x") +

  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.085,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))

Plot




Plot <- MultiCultiDataAllStrainsok6 %>%
  #filter(timeRound <= 110) %>%
  ggplot() +
  geom_area(aes(x = timeRound, y = meanActinic_par), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = timeRound, y = meanOD680, colour = as.factor(Strain)), size = 0.7, show.legend = T) +

  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  labs(y = "Optical density ("~OD[680]~")", x = "Elapsed time (h)") +

    # ggh4x::facet_nested(rows = vars(WL, Photoperiod), cols = vars(O2, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs), scale="free_x") +
  
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +

  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.085,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))

Plot
```

#MultiCultiDataAllStrainsok <-contain all data for growt curve


```{r}
MultiCultiPigmentMaxAll <- MultiCultiPigmentMaxAll %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 
```


pigments Exp and St ->photoperiod and Par_ue 
```{r fig.height = 8, fig.width = 8}

MultiCultiPigmentMaxAll$facets = factor(MultiCultiPigmentMaxAll$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
MultiCultiPigmentMaxAll$facets2 = factor(MultiCultiPigmentMaxAll$WL, labels = c("Photoperiod~(h)"))

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# Par_ue.labs <- c("30", "90", "180", "300", "900")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# Photoperiod.labs <- c("8", "12", "16", "24")
# names(Photoperiod.labs) <- c("8", "12", "16", "24")
# WL.labs <- c("Photoperiod (h)")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level (µE)")
# names(O2.labs) <- c(21)

Plot <- MultiCultiPigmentMaxAll %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_h, y = Chlapgcell, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +

  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.97),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot




Plot <- MultiCultiPigmentMaxAll %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_h, y = Phycopgcell, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.97),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot


MultiCultiPigmentExp$facets = factor(MultiCultiPigmentExp$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
MultiCultiPigmentExp$facets2 = factor(MultiCultiPigmentExp$WL, labels = c("Photoperiod~(h)"))

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
# Par_ue.labs <- c("30", "90", "180", "300", "900")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# Photoperiod.labs <- c("8", "12", "16", "24")
# names(Photoperiod.labs) <- c("8", "12", "16", "24")
# WL.labs <- c("Photoperiod (h)")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level (µE)")
# names(O2.labs) <- c(21)

Plot <- MultiCultiPigmentExp %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_h, y = Chlapgcell, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +

  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.97),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot




Plot <- MultiCultiPigmentExp %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = Time_h, y = Phycopgcell, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.97),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot




```


Tot Phyco - PARphotondose and chla-PARphotondose
```{r fig.height = 5, fig.width = 8, warning = FALSE}


scaleFUN <- function(x) sprintf("%.1f", x)
MultiCultiPigmentMaxAll$facets3 = factor(MultiCultiPigmentMaxAll$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

# 
# data_text <- data.frame(
#   facets   = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),
#   PARPhotonDose = c(77760000),
#   label = c('B'))

Plot <- MultiCultiPigmentMaxAll %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  
  filter(PhycoChlaRatio> 0) %>% 
  #filter(Strain == "BA77G" | Strain == "BA56G" | Strain == "BA127R" | Strain == "BA48R") %>%
  ggplot() +

  geom_point(aes(x = Time_h, y = Phycopgcell, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  #geom_text(data=data_text, aes(x=300, y=48, label=label), size=5) +
  geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  
  scale_y_continuous(breaks=seq(0, 50, by = 10)) +
  coord_cartesian(ylim = c(0, 50)) +
  labs(y = "Phyco content ( pg  " ~ cell^-1~")", x = "Elapsed time (h)") +
  
  ggh4x::facet_nested(cols = vars(facets3, PARPhotonDose), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        #axis.text.x = element_blank(),
        axis.text.x = element_text(size=11.5),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        #axis.title.x = element_blank(),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.065,0.91),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot


scaleFUN <- function(x) sprintf("%.1f", x)
# MultiCultiPigmentMaxAll$facets3 = factor(MultiCultiPigmentMaxAll$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

# data_text <- data.frame(
#   facets   = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),
#   PARPhotonDose = c(77760000),
#   label = c('B'))

Plot <- MultiCultiPigmentMaxAll %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  
  filter(PhycoChlaRatio> 0) %>% 
  #filter(Strain == "BA77G" | Strain == "BA56G" | Strain == "BA127R" | Strain == "BA48R") %>%
  ggplot() +

  geom_point(aes(x = Time_h, y = Chlapgcell, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  #geom_text(data=data_text, aes(x=300, y=48, label=label), size=5) +
  geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  # scale_y_continuous(labels=scaleFUN, breaks=seq(0, 50, by = 10)) +
  # coord_cartesian(ylim = c(-5, 55)) +
  scale_y_continuous(breaks=seq(0, 15, by = 3)) +
  coord_cartesian(ylim = c(0, 15)) +
  labs(y = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")", x = "Elapsed time (h)") +
  
  ggh4x::facet_nested(cols = vars(facets3, PARPhotonDose), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        #axis.text.x = element_blank(),
        axis.text.x = element_text(size=11.5),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        #axis.title.x = element_blank(),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.065,0.91),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot

```



car/chla and Phyco/chla - PARphotondose
```{r fig.height = 5, fig.width = 8, warning = FALSE}


lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
scaleFUN <- function(x) sprintf("%.1f", x)

# data_text <- data.frame(
#   facets   = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"),
#   PARPhotonDose = c(77760000),
#   label = c('B'))

Plot <- MultiCultiPigmentMaxAll %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  
  filter(PhycoChlaRatio> 0) %>% 
  #filter(Strain == "BA77G" | Strain == "BA56G" | Strain == "BA127R" | Strain == "BA48R") %>%
  ggplot() +

  geom_point(aes(x = Time_h, y = CarChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  #geom_text(data=data_text, aes(x=300, y=48, label=label), size=5) +
  geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  # scale_y_continuous(labels=scaleFUN, breaks=seq(0, 50, by = 10)) +
  # coord_cartesian(ylim = c(-5, 55)) +
  scale_y_continuous(breaks=seq(0, 0.8, by = 0.2)) +
  coord_cartesian(ylim = c(0, 0.8)) +
  labs(y = "Car/Chl" ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(facets3, PARPhotonDose), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        #axis.text.x = element_blank(),
        axis.text.x = element_text(size=11.5),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        #axis.title.x = element_blank(),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.065,0.91),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot






lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
scaleFUN <- function(x) sprintf("%.1f", x)

Plot <- MultiCultiPigmentMaxAll %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  
  filter(PhycoChlaRatio> 0) %>% 
  #filter(Strain == "BA77G" | Strain == "BA56G" | Strain == "BA127R" | Strain == "BA48R") %>%
  ggplot() +

  geom_point(aes(x = Time_h, y = PhycoChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  #geom_text(data=data_text, aes(x=300, y=48, label=label), size=5) +
  geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_y_continuous(labels=scaleFUN, breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 8)) +
  labs(y = "Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  
  ggh4x::facet_nested(cols = vars(facets3, PARPhotonDose), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        #axis.text.x = element_blank(),
        axis.text.x = element_text(size=11.5),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        #axis.title.x = element_blank(),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.065,0.91),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.005, 'cm'),
        # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot

```


```{r fig.height = 8, fig.width = 8, warning = FALSE}
# 
#   ggarrange(my_dataChla, my_dataCar, my_dataPE, my_dataPC,
#           ncol = 2, nrow = 2)

```

```{r}
#colnames(MultiCultiPigmentExpClean)

MultiCultiPigmentExpClean<-MultiCultiPigmentExp %>% 
  select(c(ID,Day,Strain,Par_ue,Photoperiod,ExpDate,InnocDate,meanOD680Day,meanOD720Day,cellml,Date,Chlapgcell,Carpgcell,Phycopgcell,CarChlaRatio,PhycoChlaRatio,Time_h,))
  
MultiCultiPigmentExpClean<-MultiCultiPigmentExpClean %>% 
  mutate(PigmentDayExp=Day) %>% 
  mutate(meanOD680DayExp=meanOD680Day) %>%
  mutate(meanOD720DayExp=meanOD720Day) %>% 
  mutate(cellmlExp=cellml) %>% 
  mutate(PigmentDateExp=Date) %>% 
  mutate(ChlapgcellExp=Chlapgcell) %>% 
  mutate(CarpgcellExp=Carpgcell) %>% 
  mutate(PhycopgcellExp=Phycopgcell) %>% 
  mutate(CarChlaRatioExp=CarChlaRatio) %>% 
  mutate(PhycoChlaRatioExp=PhycoChlaRatio) %>% 
  mutate(PigmentTime_hExp=Time_h) %>% 
  select(-c(Day,meanOD680Day,meanOD720Day,cellml,Date,Chlapgcell,Carpgcell,Phycopgcell,CarChlaRatio,PhycoChlaRatio,Time_h))
  
```
```{r}
MaxGrowthExpSt <- MaxGrowthExpSt %>%
  left_join(., MultiCultiPigmentExpClean, by = c("ID"="ID", "Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue", "ExpDate"="ExpDate", "InnocDate"="InnocDate")) 

```

#MaxGrowthExpSt contains: growth rate, max growth, PUR exp and St, pigments per cell Exp (dodac st!!!) - 80 values

```{r}
rm(MultiCultiPigmentExpClean,MultiCultiPigmentExp)
```

Heatmap 
```{r fig.height = 4, fig.width = 8, warning = FALSE}
HeatMap <- MaxGrowthExpSt %>%
  mutate(Par_ue = as.character(Par_ue)) %>%
  #mutate(PUR = as.character(PUR)) %>%
  mutate(Photoperiod = as.character(Photoperiod)) %>% 
  mutate(group = Strain) %>%
  select(-c(Strain)) %>%
  mutate(PURExp = round(PURExp, digits = 0)) %>%
  mutate(deltaOD_Lmu_corr = round(deltaOD_Lmu_corr, digits = 2)) 

```


Growth heatmap per PAR
```{r fig.height = 8, fig.width = 8, warning = FALSE}
# library(gtable)
# library(grid)
# library(gridExtra)
# library(egg)

cols <- setNames(c('seagreen4', 'palegreen3', 'brown1', 'brown4'), c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077"))

# group.labs <- c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077")
# names(group.labs) <- c("BA127R", "BA48R", "BA56G", "BA77G")
HeatMap$group <- factor(HeatMap$group, levels = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"))

test_split <- HeatMap %>%
  mutate(color_high = cols[group]) %>%
  group_split(group)

purrr::map(test_split, ~{
  ggplot(.x, aes(Photoperiod, Par_ue)) +
  geom_tile(aes(x = Photoperiod, y = Par_ue, fill = deltaOD_Lmu_corr), color = "black", show.legend = F) +
  geom_text(aes(x = Photoperiod, y = Par_ue, fill = deltaOD_Lmu_corr, label = deltaOD_Lmu_corr), color = "black", size = 3) + 
    
  # geom_rect(aes(xmin=1, xmax=2, ymin=Inf, ymax=3),
  #              size=1.4, colour="grey30", fill=NA) +
    
    
  geom_curve(aes(x = 4, y = 4.1, xend = 3.2, yend = 5), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
  geom_curve(aes(x = 4, y = 1.1, xend = 3.2, yend = 2), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
  geom_curve(aes(x = 3, y = 2.1, xend = 1.2, yend = 3), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
    
  geom_curve(aes(x = 4, y = 2.1, xend = 3.2, yend = 4), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
  geom_curve(aes(x = 2, y = 3.1, xend = 1.2, yend = 4), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
  xlim("8","12", "16", "24") +
  ylim("30","90", "180", "300", "900") +
  scale_fill_gradient2(unique(.x$group), 
                       low = "white",
                       #mid = "gray",
                       high = unique(.x$color_high), 
                       #midpoint=0.1,
                       #guide = "colourbar",
                       aesthetics = "fill") +
    labs(y = "PAR ( µmol photons  "~m^-2~""~s^-1~")", x = "Photoperiod (h)") +
    ggh4x::facet_nested(cols = vars(group)) +
    #ggh4x::facet_nested(cols = vars(group), labeller = labeller(group = group.labs)) 
    #facet_grid(~group)
  #     annotation_custom(
  #   grob = rectGrob(gp = gpar(fill = "white")),
  #   xmin = -Inf,
  #   xmax = Inf,
  #   ymin = 5,
  #   ymax = 6
  # ) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        # legend.position = c(0.08,0.91),
        # legend.key.height= unit(0.005, 'cm'),
        # legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_blank())
}) %>%
  wrap_plots() +
  plot_layout(guides = "collect", ncol = 2) 
  
      
  # annotate("rect", xmin=-Inf, xmax=Inf, ymin=5, ymax=Inf, alpha=0.4)
  #plot_layout(design = layout, ncol = 4, widths = c(0.5, 0.5)) 
  # save(S, file = "test.png")
```



Growth heatmap per PUR
```{r fig.height = 8, fig.width = 8, warning = FALSE}


cols <- setNames(c('seagreen4', 'palegreen3', 'brown1', 'brown4'), c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077"))

# group.labs <- c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077")
# names(group.labs) <- c("BA127R", "BA48R", "BA56G", "BA77G")
HeatMap$group <- factor(HeatMap$group, levels = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"))

test_split <- HeatMap %>%
  mutate(color_high = cols[group]) %>%
  group_split(group)

purrr::map(test_split, ~{
  ggplot(.x, aes(Photoperiod, Par_ue)) +
  geom_tile(aes(x = Photoperiod, y = Par_ue, fill = deltaOD_Lmu_corr), color = "black", show.legend = F) +
  geom_text(aes(x = Photoperiod, y = Par_ue, fill = deltaOD_Lmu_corr, label = PURExp), color = "black", size = 3) + 
  xlim("8","12", "16", "24") +
  ylim("30","90", "180", "300", "900") +
  scale_fill_gradient2(unique(.x$group), 
                       low = "white",
                       #mid = "gray",
                       high = unique(.x$color_high), 
                       #midpoint=0.1,
                       #guide = "colourbar",
                       aesthetics = "fill") +
    labs(y = "PUR ( µmol photons  "~m^-2~""~s^-1~")", x = "Photoperiod (h)") +
    ggh4x::facet_nested(cols = vars(group)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        axis.text.y = element_blank(),
        legend.background = element_rect(fill="transparent"),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        # legend.position = c(0.08,0.91),
        # legend.key.height= unit(0.005, 'cm'),
        # legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_blank())
}) %>%
  wrap_plots() +
  plot_layout(guides = "collect", ncol = 2) 
  
      
  # annotate("rect", xmin=-Inf, xmax=Inf, ymin=5, ymax=Inf, alpha=0.4)
  #plot_layout(design = layout, ncol = 4, widths = c(0.5, 0.5)) 
  # save(S, file = "test.png")
```

```{r}
rm(HeatMap)
```





GrowthSymmetry


Load GS catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# GScatalog<- read_sheet("https://docs.google.com/spreadsheets/d/1ggM66cScp1w4-hEfCVA7GSbgmpYz-pfJRkBZkMwzWlI/edit#gid=0") 


GScatalog<- read_sheet("https://docs.google.com/spreadsheets/d/1JG_GvHuJBtGf4NfWBSrgm0GxM7EpFVLQG-BARl8Lw8A/edit#gid=0")

as.data.frame(GScatalog)
GScatalog <- GScatalog 

```

```{r}
GScatalog <- GScatalog %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
  mutate(Acc_perc = as.numeric(Acc_perc)) %>% 
  mutate(Dec_perc = as.numeric(Dec_perc)) %>% 
  #mutate(GS = as.numeric(GS)) %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>% 
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAGI = as.numeric(tMaxAGI)) %>%
  mutate(tMaxDGI = as.numeric(tMaxDGI)) %>%
  # mutate(tMaxAGI = round(tMaxAGI, digits = 0)) %>% 
  # mutate(tMaxDGI = round(tMaxDGI, digits = 0)) %>% 
  #mutate(Acceleration_len=as.numeric(Acceleration_len)) %>% 
  mutate(PhotoperiodTstart_h=as.numeric(PhotoperiodTstart_h)) %>% 
  mutate(PhotoperiodTend_h=as.numeric(PhotoperiodTend_h)) %>% 
  mutate(tMaxDGI=as.numeric(tMaxDGI)) %>% 
  mutate(AccLen = tMaxDGI-PhotoperiodTstart_h) %>% 
  mutate(DecLen = PhotoperiodTend_h-tMaxDGI) %>% 
  mutate(GS = AccLen/DecLen) %>% 
  #mutate(GS_hRound = round(GS_h, digits = 0)) %>% 
  mutate(PhotoperiodTend_h = as.numeric(PhotoperiodTend_h)) %>% 
  mutate(TDG = as.numeric(TDG)) %>% 
  mutate(PeakDay = tMaxDGI/24) %>% 
  mutate(PeakDay = round(PeakDay, digits = 0)) %>% 
  mutate(PeakDay = as.numeric(PeakDay)) %>% 
  mutate(Ratio = as.numeric(Ratio)) %>% 
  mutate(Ratio=Ratio/100) 
 
```

```{r}
#colnames(GScatalog)

GScatalog<-GScatalog %>% 
  filter(DecLen>=0) %>% 
  filter(AccLen>=0) %>% 
  filter(GS>=0) %>% 
  group_by(Strain, Photoperiod, Par_ue, Phase) %>%
  
  summarize(PhotoperiodTstart_h, PhotoperiodTend_h,tMaxDGI,tMaxAGI, Phase, AchivePreStationary, MaxDGI, MaxAGI, Acceleration_len, Decceleration_len, Ratio, Acc_perc, Dec_perc, Strain, Par_ue, Photoperiod, O2, WL, OD680start, OD680end, TDG, AccLen, DecLen, GS, PeakDay,
    
            meanAccLen = mean(AccLen), 
            sdAccLen = sd(AccLen),
            meanDecLen = mean(DecLen), 
            sdDecLen = sd(DecLen),
            meanGS = mean(GS), 
            sdGS = sd(GS),
            meanRatio = mean(Ratio), 
            sdRatio = sd(Ratio)) %>%  

  ungroup() 

#sprawdz, czy phase jeszcze nie dodac!!!!
```


vertical lines without 24 photoperiod
```{r}

data_vline9 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(347,321.02,240.90,187.92,110,347,245.39,189.48,162.62,110,347,168.39,113.76,111.56,110))

data_vline10 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(346,319.92,240.81,214.41,109.5,346,216.33,163.44,136.03,109.5,299.38,166.28,137.32,111.28,109.45))

data_vline11 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(345,347,266.84,240.72,109,345,296.45,217.80,191.03,109,345,191.49,114.95,112.75,108))

data_vline12 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(344, 345, 266.93, 215.42, 108.5,344, 244.38,190.39,163.62,108.5,299.57, 168.85, 137.50, 112.29, 107))

```


```{r}

GScatalog$facets = factor(GScatalog$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))

GScatalog$facets2 = factor(GScatalog$WL, labels = c("Photoperiod~(h)"))
```


TDG plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}



# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# 
# Strain.labs <- c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077")
# names(Strain.labs) <- c("BA127R", "BA48R", "BA56G", "BA77G")
# 
# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# WL.labs <- c("Strain")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level")
# names(O2.labs) <- c(21)

#scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
Plot <- GScatalog %>%
  #filter(Photoperiod != 24) %>% 
  ggplot() +
  geom_point(aes(x = PhotoperiodTend_h, y = TDG, colour = as.factor(Strain)), size = 3.5, alpha = 0.8, show.legend = T) +
  
  
  geom_vline(data = data_vline9, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline10, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline11, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline12, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

labs(y = "TDG ("~OD[680]~")", x = "Elapsed time (h)") +
  
  # scale_x_continuous(breaks=seq(0, 4000000, by = 1000000)) +
  # coord_cartesian(xlim = c(-100, 3300000)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #   scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  
  ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.085,0.92),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot
```




```{r}
#colnames(GScatalog)
# colnames(MaxGrowthExpSt)

GScatalogPURPAR <- GScatalog %>%
  left_join(., MaxGrowthExpSt, by = c("Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue", "O2" = "O2", "WL" = "WL", "facets" = "facets", "facets2" = "facets2"))

```

Half photoperiod
```{r}

GScatalog8<-GScatalogPURPAR %>% 
  filter(Photoperiod == 8) %>% 
  mutate(halfmeanAccLen = meanAccLen/4) %>% 
  mutate(halfsdAccLen = sdAccLen/4) 

GScatalog12<-GScatalogPURPAR %>% 
  filter(Photoperiod == 12) %>% 
  mutate(halfmeanAccLen = meanAccLen/6) %>% 
  mutate(halfsdAccLen = sdAccLen/6) 

GScatalog16<-GScatalogPURPAR %>% 
  filter(Photoperiod == 16) %>% 
  mutate(halfmeanAccLen = meanAccLen/8) %>% 
  mutate(halfsdAccLen = sdAccLen/8) 
  
GScatalogPURPAR<-rbind(GScatalog8,GScatalog12,GScatalog16)

rm(GScatalog8,GScatalog12,GScatalog16)

GScatalogPURPAR<-GScatalogPURPAR %>% 
    mutate(meanAccLenRound = round(meanAccLen, digits = 0)) 

```



```{r}
data_hlineGS8 <- data.frame(Photoperiod= c(8),facets2= c("Photoperiod~(h)"),value = c(4))
data_hlineGS12 <- data.frame(Photoperiod= c(12),facets2= c("Photoperiod~(h)"),value = c(6))
data_hlineGS16 <- data.frame(Photoperiod= c(16),facets2= c("Photoperiod~(h)"),value = c(8))
```

```{r}
GScatalogPURPAR$facetsStrain = factor(GScatalogPURPAR$O2, labels = c("Strain"))

GScatalogPURPAR$facetsPhase = factor(GScatalogPURPAR$WL, labels = c("Phase~of~growth"))
```

Plot meanGS_h vs PAR and meanGS_h vs PURExp
```{r fig.height = 6, fig.width = 8, warning = FALSE}


# Plot<-GScatalogPURPAR %>%
#   filter(meanGS_h>=0) %>% 
#   #filter(PeakDay!= 4) %>% 
#   #filter(AchivePreStationary == "Yes") %>% 
#   #filter(GS_hRound!=13) %>% 
#   filter(Phase != "TP") %>% 
#   ggplot() +
#   geom_point(aes(x = Par_ue, y = meanGS_h, colour = as.factor(Strain)), size = 3.5, alpha = 0.8, show.legend = T) +
#   #geom_errorbar(aes(x = Par_ue, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h)) +
#   geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
#   geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotted") +
#   geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dotted") +
#   
#  #labs(y = "Growth symmetry (h)", x = "PAR ( µmol photons "~m^-2~""~s^-1~")") +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   #geom_hline(aes(yintercept = 50), linetype="dotted") +
#   ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facetsPhase, Phase), labeller = label_parsed) +
#   # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.085,0.92),
#         legend.key.height= unit(0.005, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=10))
# Plot
# 
# 
# Plot<-GScatalogPURPAR %>%
#   filter(meanGS_h>=0) %>% 
#   #filter(PeakDay!= 4) %>% 
#   #filter(AchivePreStationary == "Yes") %>% 
#   #filter(GS_hRound!=13) %>% 
#   filter(Phase != "TP") %>% 
#   ggplot() +
#   geom_point(aes(x = PURExp, y = meanGS_h, colour = as.factor(Strain)), size = 3.5, alpha = 0.8, show.legend = T) +
#   #geom_errorbar(aes(x = Par_ue, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h)) +
#   geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
#   geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotted") +
#   geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dotted") +
#  #labs(y = "Growth symmetry (h)", x = "PUR ( µmol photons "~m^-2~""~s^-1~")") +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   #geom_hline(aes(yintercept = 50), linetype="dotted") +
#   ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facetsPhase, Phase), labeller = label_parsed) +
#   #ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.085,0.92),
#         legend.key.height= unit(0.005, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=10))
# Plot

# 
# Plot<-GScatalogPURPAR %>%
#   filter(meanGS_h>=0) %>% 
#   #filter(PeakDay!= 4) %>% 
#   #filter(AchivePreStationary == "Yes") %>% 
#   #filter(GS_hRound!=13) %>% 
#   filter(Phase != "TP") %>% 
#   ggplot() +
#   geom_point(aes(x = Par_ue, y = meanGS_h, colour = as.factor(Strain)), size = 3.5, alpha = 0.8, show.legend = T) +
#     geom_errorbar(aes(x = Par_ue, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h)) +
#   
#   # geom_vline(data = data_vline9, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
#   # geom_vline(data = data_vline10, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
#   # geom_vline(data = data_vline11, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
#   # geom_vline(data = data_vline12, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
# 
#   geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
#   geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotted") +
#   geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dotted") +
#   
#  labs(y = "Growth symmetry (h)", x = "PAR ( µmol photons "~m^-2~""~s^-1~")") +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   #geom_hline(aes(yintercept = 50), linetype="dotted") +
#   ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facetsPhase, Phase), labeller = label_parsed) +
#   # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.085,0.92),
#         legend.key.height= unit(0.005, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=10))
# Plot

```


Nice plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}



scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)
# 
# WL.labs <- c("Phase")
# names(WL.labs) <- c("WW")

Plot<-GScatalogPURPAR %>%
  filter(meanAccLen>=0) %>% 
  filter(Phase != "TP") %>% 
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  geom_line(aes(x = PARPhotonDose, y = meanAccLen, colour = as.factor(Par_ue)), size = 1, alpha = 0.8, show.legend = F) +
  
  geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  
 #labs(y = "Growth symmetry (h)", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(0, 10, by = 2)) +
  coord_cartesian(ylim = c(0, 12)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot


Plot<-GScatalogPURPAR %>%
  filter(meanAccLen>=0) %>% 
  filter(Phase != "TP") %>% 
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  geom_line(aes(x = PURPhotonDoseExp, y = meanAccLen, colour = as.factor(Par_ue)), size = 1, alpha = 0.8, show.legend = F) +
  geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  
 #labs(y = "Growth symmetry (h)", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(0, 10, by = 2)) +
  coord_cartesian(ylim = c(0, 12)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot




  # labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  # scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +

```


Heatmap GS 
```{r fig.height = 4, fig.width = 8, warning = FALSE}
# HeatMapGS <- GScatalog %>%
#   mutate(Par_ue = as.character(Par_ue)) %>%
#   #mutate(PUR = as.character(PUR)) %>%
#   mutate(Photoperiod = as.character(Photoperiod)) %>% 
#   mutate(group = Strain) %>%
#   select(-c(Strain)) %>%
# 
#   mutate(roundmeanGS_h = round(meanGS_h, digits = 0)) %>% 
#   filter(meanGS_h>=0) %>% 
#   filter(Phase == "Exponential")

```


GS heatmap per PAR
```{r fig.height = 8, fig.width = 8, warning = FALSE}
# # library(gtable)
# # library(grid)
# # library(gridExtra)
# # library(egg)
# 
# cols <- setNames(c('seagreen4', 'palegreen3', 'brown1', 'brown4'), c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077"))
# 
# # group.labs <- c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077")
# # names(group.labs) <- c("BA127R", "BA48R", "BA56G", "BA77G")
# HeatMapGS$group <- factor(HeatMapGS$group, levels = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"))
# 
# test_split <- HeatMapGS %>%
#   mutate(color_high = cols[group]) %>%
#   group_split(group)
# 
# purrr::map(test_split, ~{
#   ggplot(.x, aes(Photoperiod, Par_ue)) +
#   geom_tile(aes(x = Photoperiod, y = Par_ue, fill = meanGS_h), color = "black", show.legend = F) +
#   geom_text(aes(x = Photoperiod, y = Par_ue, label = roundmeanGS_h), color = "black", size = 3) + 
#     
#   geom_curve(aes(x = 1, y = 4.1, xend = 2.2, yend = 3), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = -0.2, size = 0.7, colour = "gray20") +
#   geom_curve(aes(x = 1, y = 3.1, xend = 3.2, yend = 2), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = -0.2, size = 0.7, colour = "gray20") +
#   # geom_curve(aes(x = 3, y = 2.1, xend = 1.2, yend = 3), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
#   #   
#   # geom_curve(aes(x = 4, y = 2.1, xend = 3.2, yend = 4), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
#   # geom_curve(aes(x = 2, y = 3.1, xend = 1.2, yend = 4), arrow = arrow(length = unit(0.03, "npc"), ends = "both", type="closed"), curvature = 0.2, size = 0.7, colour = "gray20") +
#   xlim("8","12", "16") +
#   ylim("30","90", "180", "300", "900") +
#   scale_fill_gradient2(unique(.x$group), 
#                        low = "white",
#                        #mid = "gray",
#                        high = unique(.x$color_high), 
#                        #midpoint=0.1,
#                        #guide = "colourbar",
#                        aesthetics = "fill") +
#     labs(y = "PAR ( µmol photons  "~m^-2~""~s^-1~")", x = "Photoperiod (h)") +
#     ggh4x::facet_nested(cols = vars(group)) +
#     #ggh4x::facet_nested(cols = vars(group), labeller = labeller(group = group.labs)) 
#     #facet_grid(~group)
# 
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         #plot.background = element_rect(colour = "dodgerblue4", size = 3),
#         # legend.position = c(0.08,0.91),
#         # legend.key.height= unit(0.005, 'cm'),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         legend.text = element_blank())
# }) %>%
#   wrap_plots() +
#   plot_layout(guides = "collect", ncol = 2) 
#   

```

Half photoperiod
```{r fig.height = 8, fig.width = 8, warning = FALSE}



scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)
# 
# WL.labs <- c("Phase")
# names(WL.labs) <- c("WW")

Plot<-GScatalogPURPAR %>%
  filter(Phase != "TP") %>% 
  filter(meanGS<3) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanGS, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 1, linetype="dashed") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot



Plot<-GScatalogPURPAR %>%
  filter(Phase != "TP") %>% 
  filter(meanRatio<3) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 1, linetype="dashed") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot





Plot<-GScatalogPURPAR %>%
  filter(Phase != "TP") %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = halfmeanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 1, linetype="dashed") +
 #labs(y = "Diel growth symmetry", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  coord_cartesian(ylim = c(0, 2)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot






Plot<-GScatalogPURPAR %>%
  #mutate(HalfPhotoperiod = Photoperiod/2) %>% 
  filter(meanAccLen>=0) %>%
  filter(Phase != "TP") %>%
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = Photoperiod, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  #geom_hline(yintercept = 1, linetype="dashed") +
 #labs(y = "Diel growth symmetry (h)", x = "1/2 Photoperiod") +
  #scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  # scale_y_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(ylim = c(0, 10)) +
  # 
  # scale_x_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(xlim = c(0, 10)) +
  
  # geom_hline(yintercept = 0, linetype = "dashed") +
  # geom_vline(xintercept = 0, linetype = "dashed") +
  geom_abline(slope = 0.5, intercept = 0, linetype = "dashed") +
  #coord_fixed(ratio = 1, xlim = c (0, 16), ylim = c(0, 10) ) +
  
  
  
  #scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        panel.spacing.x = unit(1,"lines"),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot


```



```{r}
gs4_deauth()

ParSine<- read_sheet("https://docs.google.com/spreadsheets/d/1oZLemHtd6H3j2MgXbgNzqtZ2Gy3EKH6Vnn14PnEpPTw/edit#gid=0")

as.data.frame(ParSine)
ParSine <- ParSine

ParSine<-ParSine %>% 
  mutate(PAR_Sine = as.numeric(PAR_Sine)) %>%
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(RealTime = as.numeric(RealTime)) %>%
  mutate(Photoperiod_h_Sine = as.numeric(Photoperiod_h_Sine)) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

```


```{r}
GScatalogSine <- GScatalogPURPAR %>%
  left_join(., ParSine, by = c("Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue", "meanGS_hRound" = "Photoperiod_h_Sine"))

```


```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)
# 
# WL.labs <- c("Phase")
# names(WL.labs) <- c("WW")

Plot<-GScatalogSine %>%
  filter(meanGS_h>=0) %>% 
  filter(Phase != "TP") %>% 
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = RealTime, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 12, linetype="dashed") +
 #labs(y = "Diel growth symmetry (h)", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(4, 20, by = 4)) +
  coord_cartesian(ylim = c(4, 20)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot


Plot<-GScatalogSine %>%
  filter(meanGS_h>=0) %>% 
  filter(Phase != "TP") %>% 
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = RealTime, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 12, linetype="dashed") +
 #labs(y = "Diel growth symmetry (h)", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(4, 20, by = 4)) +
  coord_cartesian(ylim = c(4, 20)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot



Plot<-GScatalogSine %>%
  filter(meanGS_h>=0) %>% 
  filter(Phase != "TP") %>% 
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = PAR_Sine, y = RealTime, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 12, linetype="dashed") +
 #labs(y = "Diel growth symmetry (h)", x = "PAR ( µmol photons "~m^-2~""~s^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(4, 20, by = 4)) +
  coord_cartesian(ylim = c(4, 20)) +
  
  #scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot





# Plot<-GScatalogSine %>%
#   filter(meanGS_h>=0) %>% 
#   filter(Phase != "TP") %>% 
#   #filter(sdGS_h<"4") %>% 
#   ggplot() +
#   geom_point(aes(y = PAR_Sine, x = RealTime, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
#   # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
#   
#   # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
#   # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
#   # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
#   geom_vline(xintercept = 12, linetype="dashed") +
#  #labs(x = "Diel growth symmetry (h)", y = "PAR ( µmol photons "~m^-2~""~s^-1~")") +
#   scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
#   scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
#   
#   scale_x_continuous(breaks=seq(4, 20, by = 4)) +
#   coord_cartesian(xlim = c(4, 20)) +
#   
#   #scale_x_continuous(label=scientific_10) +
#   #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   #geom_hline(aes(yintercept = 50), linetype="dotted") +
#   ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
#   # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="white"),
#         legend.position = c(0.92,0.89),
#         legend.key.height= unit(0.005, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=10))
# Plot

```









Par Sine df - useless! Maybe to plot for M&M - photoperiod & light when sine
```{r}

# gs4_deauth()
# 
# ParSine<- read_sheet("https://docs.google.com/spreadsheets/d/1SU2PzqK_wIYNlJpYS6nTDFDfHWAGfI_n9-An98d3rDc/edit#gid=0")
# 
# as.data.frame(ParSine)
# ParSine <- ParSine 
# 
# ParSine<-ParSine %>% 
#   mutate(PAR_Sine = as.numeric(PAR_Sine)) %>% 
#   mutate(PUR_round_Ex = as.numeric(PUR_round_Ex)) %>% 
#   
#   mutate(PUR_Ex = as.numeric(PUR_Ex)) %>% 
#   mutate(PUR_Sine_Ex = as.numeric(PUR_Sine_Ex)) %>% 
#   mutate(PUR_St = as.numeric(PUR_St)) %>% 
#   mutate(PUR_round_St = as.numeric(PUR_round_St)) %>% 
#   mutate(PUR_Sine_St = as.numeric(PUR_Sine_St)) %>% 
#   
#   mutate(Par_ue = as.numeric(Par_ue)) %>% 
#   mutate(Photoperiod = as.numeric(Photoperiod)) %>% 
#   mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
#          Strain=="BA48R"~"PE-rich_048",
#         Strain=="BA56G"~"PC-rich_056",
#          Strain=="BA77G"~"PC-rich_077")) 

# GScatalogAll <- GScatalog %>%
#   left_join(., ParSine, by = c("Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue")) 
# 
# GScatalogAll <- GScatalogAll %>%
#   mutate(GS_h_round = GS_h) %>% 
#   mutate(PAR_Sine_round = PAR_Sine) %>% 
#   mutate(GS_h_round = round(GS_h_round, digits = 0)) %>% 
#   filter(GS_h_round == Photoperiod_h_Sine)

```


Padfield D, O'Sullivan H (2023). rTPC: Functions for Fitting Thermal Performance Curves. R package version 1.0.3, https://github.com/padpadpadpad/rTPC.

@Manual{,
  title = {rTPC: Functions for Fitting Thermal Performance Curves},
  author = {Daniel Padfield and Hannah O'Sullivan},
  year = {2023},
  note = {R package version 1.0.3},
  url = {https://github.com/padpadpadpad/rTPC},
}
https://github.com/padpadpadpad/rTPC
https://github.com/padpadpadpad/rTPC/blob/ee0a8b7f80319ff3f8c0b49aa12af9631c6e2c0b/R/lactin2_1995.R



Modified gaussian model for fitting thermal performance curves
https://padpadpadpad.github.io/rTPC/reference/modifiedgaussian_2006.html
modifiedgaussian_2006(temp, rmax, topt, a, b)
Angilletta Jr, M. J. (2006). Estimating and comparing thermal performance curves. Journal of Thermal Biology, 31(7), 541-545

rmax - maximum rate at optimum temperature
topt - optimum temperature
a - related to full curve width
b - allows for asymmetry in the curve fit


Lactin, D.J., Holliday, N.J., Johnson, D.L. & Craigen, R. Improved rate models of temperature-dependent development by arthropods. Environmental Entomology 24, 69-75 (1995)

temp - temperature in degrees centigrade
a - constant that determines the steepness of the rising portion of the curve
b constant that determines the height of the overall curve
tmax - the temperature at which the curve begins to decelerate beyond the optimum (ºC)
delta_t - thermal safety margin (ºC)


Flinn model for fitting thermal performance curves
#'
#' @param temp temperature in degrees centigrade
#' @param a parameter that controls the height of the curve
#' @param b parameter that controls the slope of the initial increase of the curve
#' @param c parameter that controls the position and steepness of the decline of the curve
#' @references Flinn PW Temperature-dependent functional response of the parasitoid Cephalonomia waterstoni (Gahan) (Hymenoptera, Bethylidae) attacking rusty grain beetle larvae (Coleoptera, Cucujidae). Environmental Entomology, 20, 872–876, (1991)

Boatman model for fitting thermal performance curves
#'
#' @param temp temperature in degrees centigrade
#' @param rmax the rate at optimum temperature
#' @param tmin low temperature (ºC) at which rates become negative
#' @param tmax high temperature (ºC) at which rates become negative
#' @param a shape parameter to adjust the skewness of the curve
#' @param b shape  parameter to adjust the kurtosis of the curve
#' @references Boatman, T. G., Lawson, T., & Geider, R. J. A key marine diazotroph in a changing ocean: The interacting effects of temperature, CO2 and light on the growth of Trichodesmium erythraeum IMS101. PLoS ONE, 12, e0168796 (2017)


Beta parameter
https://padpadpadpad.github.io/rTPC/articles/fit_many_models.html

citation:
Daniel Padfield, Hannah O’Sullivan, & Samraat Pawar (2021). rTPC and nls.multstart: A new pipeline to fit thermal performance curves in R. Methods in Ecology and Evolution. https://doi.org/10.1111/2041-210X.13585

```{r}
# 
# # install package from GitHub
# #remotes::install_github("padpadpadpad/rTPC")
# 
# # load packages
# library(rTPC)
# library(nls.multstart)
# library(broom)
# library(tidyverse)
# 
# # write function to label ggplot2 panels
# label_facets_num <- function(string){
#   len <- length(string)
#   string = paste('(', 1:len, ') ', string, sep = '')
#   return(string)
# }

```


all 25 fits
```{r}
# fit every model formulation in rTPC
# d_fits <- nest(d, data = c(temp, rate)) %>%
#   mutate(beta = map(data, ~nls_multstart(rate~beta_2012(temp = temp, a, b, c, d, e),
#                         data = .x,
#                         iter = c(6,6,6,6,6),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'beta_2012') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'beta_2012') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'beta_2012'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'beta_2012'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          boatman = map(data, ~nls_multstart(rate~boatman_2017(temp = temp, rmax, tmin, tmax, a,b),
#                         data = .x,
#                         iter = c(4,4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'boatman_2017') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'boatman_2017') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'boatman_2017'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'boatman_2017'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          briere2 = map(data, ~nls_multstart(rate~briere2_1999(temp = temp, tmin, tmax, a,b),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'briere2_1999') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'briere2_1999') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'briere2_1999'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'briere2_1999'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          delong = map(data, ~nls_multstart(rate~delong_2017(temp = temp, c, eb, ef, tm, ehc),
#                         data = .x,
#                         iter = c(4,4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'delong_2017') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'delong_2017') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'delong_2017'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'delong_2017'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          flinn = map(data, ~nls_multstart(rate~flinn_1991(temp = temp, a, b, c),
#                         data = .x,
#                         iter = c(5,5,5),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'flinn_1991') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'flinn_1991') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'flinn_1991'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'flinn_1991'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          gaussian = map(data, ~nls_multstart(rate~gaussian_1987(temp = temp, rmax, topt, a),
#                         data = .x,
#                         iter = c(4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          hinshelwood = map(data, ~nls_multstart(rate~hinshelwood_1947(temp = temp, a, e, b, eh),
#                         data = .x,
#                         iter = c(5,5,5,5),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'hinshelwood_1947') - 1,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'hinshelwood_1947') + 1,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'hinshelwood_1947'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'hinshelwood_1947'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          joehnk = map(data, ~nls_multstart(rate~joehnk_2008(temp = temp, rmax, topt, a, b, c),
#                         data = .x,
#                         iter = c(4,4,4,4, 4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'joehnk_2008') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'joehnk_2008') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'joehnk_2008'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'joehnk_2008'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          johnson_lewin = map(data, ~suppressWarnings(nls_multstart(rate~ johnsonlewin_1946(temp = temp, r0, e, eh, topt),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'johnsonlewin_1946') - 1,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'johnsonlewin_1946') + 1,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'johnsonlewin_1946'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'johnsonlewin_1946'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE))),
#          kamykowski = map(data, ~nls_multstart(rate~kamykowski_1985(temp = temp, tmin, tmax, a, b, c),
#                         data = .x,
#                         iter = c(4,4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'kamykowski_1985') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'kamykowski_1985') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'kamykowski_1985'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'kamykowski_1985'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          lactin2 = map(data, ~nls_multstart(rate~lactin2_1995(temp = temp, a, b, tmax, delta_t),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'lactin2_1995') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'lactin2_1995') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'lactin2_1995'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'lactin2_1995'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          lrf = map(data, ~nls_multstart(rate~lrf_1991(temp = temp, rmax, topt, tmin, tmax),
#                   data = d,
#                   iter = c(3,3,3,3),
#                   start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'lrf_1991') - 10,
#                   start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'lrf_1991') + 10,
#                   lower = get_lower_lims(.x$temp, .x$rate, model_name = 'lrf_1991'),
#                   upper = get_upper_lims(.x$temp, .x$rate, model_name = 'lrf_1991'),
#                   supp_errors = 'Y',
#                   convergence_count = FALSE)),
#          modifiedgaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          oneill = map(data, ~nls_multstart(rate~oneill_1972(temp = temp, rmax, ctmax, topt, q10),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'oneill_1972') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'oneill_1972') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'oneill_1972'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'oneill_1972'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          pawar = map(data, ~nls_multstart(rate~pawar_2018(temp = temp, r_tref, e, eh, topt, tref = 15),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'pawar_2018') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'pawar_2018') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'pawar_2018'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'pawar_2018'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          quadratic = map(data, ~nls_multstart(rate~quadratic_2008(temp = temp, a, b, c),
#                         data = .x,
#                         iter = c(4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'quadratic_2008') - 0.5,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'quadratic_2008') + 0.5,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'quadratic_2008'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'quadratic_2008'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          ratkowsky = map(data, ~nls_multstart(rate~ratkowsky_1983(temp = temp, tmin, tmax, a, b),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'ratkowsky_1983') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'ratkowsky_1983') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'ratkowsky_1983'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'ratkowsky_1983'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a,b,c),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          sharpeschoolfull = map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref,e,el,tl,eh,th, tref = 15),
#                         data = .x,
#                         iter = c(4,4,4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          sharpeschoolhigh = map(data, ~nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 15),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolhigh_1981'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          sharpeschoollow = map(data, ~nls_multstart(rate~sharpeschoollow_1981(temp = temp, r_tref,e,el,tl, tref = 15),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoollow_1981'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          spain = map(data, ~nls_multstart(rate~spain_1982(temp = temp, a,b,c,r0),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'spain_1982') - 1,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'spain_1982') + 1,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'spain_1982'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'spain_1982'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          thomas1 = map(data, ~nls_multstart(rate~thomas_2012(temp = temp, a,b,c,topt),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'thomas_2012') - 1,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'thomas_2012') + 2,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'thomas_2012'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'thomas_2012'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          thomas2 = map(data, ~nls_multstart(rate~thomas_2017(temp = temp, a,b,c,d,e),
#                         data = .x,
#                         iter = c(3,3,3,3,3),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'thomas_2017') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'thomas_2017') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'thomas_2017'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'thomas_2017'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)),
#          weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)))

```

dummy df
```{r}

# gs4_deauth()
# 
# dummy<- read_sheet("https://docs.google.com/spreadsheets/d/1Mf565NYw1fO0i1cYEQ1eDWNJULea4x8p4SE6F5_cl2Q/edit#gid=0")
# 
# as.data.frame(dummy)
# dummy <- dummy 
# 
# dummy<-dummy %>% 
#   mutate(curve_id = as.numeric(curve_id)) %>% 
#   mutate(temp = as.numeric(temp)) %>% 
#   mutate(rate = as.numeric(rate)) 

```


PAR
```{r}
# d2 <- MaxGrowthExpSt %>%
#   filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_056" | Strain == "PC-rich_077") %>% 
#   filter(Par_ue != 900) %>% 
#   select(c(Strain, PARPhotonDose, deltaOD_Lmu_corr)) %>% 
#   mutate(temp = PARPhotonDose) %>% 
#   mutate(rate = deltaOD_Lmu_corr) %>% 
#   mutate(curve_id = Strain) %>% 
#   select(-c(PARPhotonDose, deltaOD_Lmu_corr))  %>% 
#   mutate(curve_id=case_when(curve_id=="PE-rich_048"~1, curve_id=="PE-rich_127"~2, curve_id=="PC-rich_056"~3, curve_id=="PC-rich_077"~4)) %>%
#   select(c(curve_id, temp, rate)) 


```

```{r}

# d2 <- MaxGrowthExpSt %>%
#   filter(Strain == "PC-rich_077") %>% 
#   filter(Par_ue == 900) %>% 
#   select(c(Strain, PARPhotonDose, deltaOD_Lmu_corr)) %>% 
#   mutate(temp = PARPhotonDose) %>% 
#   mutate(rate = deltaOD_Lmu_corr) %>% 
#   mutate(curve_id = Strain) %>% 
#   select(-c(PARPhotonDose, deltaOD_Lmu_corr))  %>% 
#   mutate(curve_id=case_when(curve_id=="PE-rich_048"~1, curve_id=="PE-rich_127"~1, curve_id=="PC-rich_056"~1, curve_id=="PC-rich_077"~1)) %>%
#   select(c(curve_id, temp, rate)) 
# 
# d3<-rbind(d2, dummy)
# 
# d2<-d3

```


PUR
```{r}
# d2 <- MaxGrowthExpSt %>%
#   filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_056" | Strain == "PC-rich_077") %>% 
#   filter(Par_ue != 900) %>% 
#   select(c(Strain, PURPhotonDoseExp, deltaOD_Lmu_corr)) %>% 
#   mutate(temp = PURPhotonDoseExp) %>% 
#   mutate(rate = deltaOD_Lmu_corr) %>% 
#   mutate(curve_id = Strain) %>% 
#   select(-c(PURPhotonDoseExp, deltaOD_Lmu_corr))  %>% 
#   mutate(curve_id=case_when(curve_id=="PE-rich_048"~1, curve_id=="PE-rich_127"~2, curve_id=="PC-rich_056"~3, curve_id=="PC-rich_077"~4)) %>%
#   select(c(curve_id, temp, rate)) 


```

```{r}

# d2 <- MaxGrowthExpSt %>%
#   filter(Strain == "PC-rich_077") %>% 
#   filter(Par_ue == 900) %>% 
#   select(c(Strain, PURPhotonDoseExp, deltaOD_Lmu_corr)) %>% 
#   mutate(temp = PURPhotonDoseExp) %>% 
#   mutate(rate = deltaOD_Lmu_corr) %>% 
#   mutate(curve_id = Strain) %>% 
#   select(-c(PURPhotonDoseExp, deltaOD_Lmu_corr))  %>% 
#   mutate(curve_id=case_when(curve_id=="PE-rich_048"~1, curve_id=="PE-rich_127"~1, curve_id=="PC-rich_056"~1, curve_id=="PC-rich_077"~1)) %>%
#   select(c(curve_id, temp, rate)) 
# 
# d3<-rbind(d2, dummy)
# 
# d2<-d3

```






```{r}


# #najlepszy
# d_fits2 <- nest(d2, data = c(temp, rate)) %>%
#          mutate(thomas1 = map(data, ~nls_multstart(rate~thomas_2012(temp = temp, a,b,c,topt),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'thomas_2012') - 1,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'thomas_2012') + 2,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'thomas_2012'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'thomas_2012'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)))
# 
# #tez bardzo dobry!
# d_fits2 <- nest(d2, data = c(temp, rate)) %>%
#         mutate(quadratic = map(data, ~nls_multstart(rate~quadratic_2008(temp = temp, a, b, c),
#                         data = .x,
#                         iter = c(4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'quadratic_2008') - 0.5,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'quadratic_2008') + 0.5,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'quadratic_2008'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'quadratic_2008'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)))
# 
# #super - gdy nie ma ostrego spadku
# d_fits2 <- nest(d2, data = c(temp, rate)) %>%
#         mutate(modifiedgaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)))
# 
# 
# d_fits2 <- nest(d2, data = c(temp, rate)) %>%
#         mutate(lactin2 = map(data, ~nls_multstart(rate~lactin2_1995(temp = temp, a, b, tmax, delta_t),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'lactin2_1995') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'lactin2_1995') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'lactin2_1995'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'lactin2_1995'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)))
# 
# 
# d_fits2 <- nest(d2, data = c(temp, rate)) %>%
#         mutate(briere2 = map(data, ~nls_multstart(rate~briere2_1999(temp = temp, tmin, tmax, a,b),
#                         data = .x,
#                         iter = c(4,4,4,4),
#                         start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'briere2_1999') - 10,
#                         start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'briere2_1999') + 10,
#                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'briere2_1999'),
#                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'briere2_1999'),
#                         supp_errors = 'Y',
#                         convergence_count = FALSE)))
# 

```

```{r}

# # stack models
# d_stack <- select(d_fits2, -data) %>%
#   pivot_longer(., names_to = 'model_name', values_to = 'fit', modifiedgaussian)
# 
# # get parameters using tidy
# params <- d_stack %>%
#   mutate(., est = map(fit, tidy)) %>%
#   select(-fit) %>%
#   unnest(est)
# 
# # get predictions using augment
# newdata <- tibble(temp = seq(min(d2$temp), max(d2$temp), length.out = 100))
# d_preds <- d_stack %>%
#   mutate(., preds = map(fit, augment, newdata = newdata)) %>%
#   select(-fit) %>%
#   unnest(preds)
# 
# # plot
# ggplot(d_preds, aes(temp, rate)) +
#   geom_point(aes(temp, rate), d2) +
#   geom_line(aes(temp, .fitted, colour=as.factor(curve_id))) +
#   facet_wrap(~model_name, labeller = labeller(model_name = label_facets_num), scales = 'free', ncol = 5) +
#   theme_bw(base_size = 12) +
#   theme(legend.position = 'none',
#         strip.text = element_text(hjust = 0),
#         strip.background = element_blank()) +
#   labs(x = 'Temperature (ºC)',
#        y = 'Metabolic rate',
#        title = 'Fits of every model available in rTPC') +
#   geom_hline(aes(yintercept = 0), linetype = 2)
# 
# 
# # modifiedgaussian_077_900_PAR_Fit<-d_preds
# # modifiedgaussian_077_900_PAR_Params<-params
# # modifiedgaussian_077_900_PAR_d2<-d2
# 
# # modifiedgaussian_PAR_Fit<-d_preds
# # modifiedgaussian_PAR_Params<-params
# # modifiedgaussian_PAR_d2<-d2
# 
# 
# # 
# modifiedgaussian_077_900_PUR_Fit<-d_preds
# modifiedgaussian_077_900_PUR_Params<-params
# modifiedgaussian_077_900_PUR_d2<-d2
# # 
# # modifiedgaussian_PUR_Fit<-d_preds
# # modifiedgaussian_PUR_Params<-params
# # modifiedgaussian_PUR_d2<-d2

```



```{r}
# CleanGrowthPAR <- MaxGrowthExpSt %>%
#   select(c(Strain, Par_ue, Photoperiod, O2, WL, PARPhotonDose, deltaOD_Lmu_corr, deltaOD_Lmu_se)) %>% 
#   mutate(PhotonDose = WL) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="WW" ~"PAR")) %>% 
#   mutate(PhotonDose_value = PARPhotonDose) %>% 
#   select(-c(PARPhotonDose))
#   
# CleanGrowthPUR <- MaxGrowthExpSt %>%
#   select(c(Strain, Par_ue, Photoperiod, O2, WL, PURPhotonDoseExp, deltaOD_Lmu_corr, deltaOD_Lmu_se)) %>% 
#   mutate(PhotonDose = WL) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="WW" ~"PUR")) %>% 
#   mutate(PhotonDose_value = PURPhotonDoseExp) %>% 
#   select(-c(PURPhotonDoseExp))
# #colnames(MultiCultiDataCleanGrowth4)
# 
# CleanGrowthPARPUR <-rbind(CleanGrowthPAR, CleanGrowthPUR)

```


params all PAR
```{r}

# modifiedgaussian_PAR_Params2 <-modifiedgaussian_PAR_Params %>%
#   mutate(Condition = model_name) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127", 
#                           Strain==2~"PE-rich_048", 
#                           Strain==3~"PC-rich_056", 
#                           Strain==4~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition=="modifiedgaussian"~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_127_900_PAR_Params2 <-modifiedgaussian_127_900_PAR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_127")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_048_900_PAR_Params2 <-modifiedgaussian_048_900_PAR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_048")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_056_900_PAR_Params2 <-modifiedgaussian_056_900_PAR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_056")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_077_900_PAR_Params2 <-modifiedgaussian_077_900_PAR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# 
# modifiedgaussian_PAR_Params2ok <- rbind(modifiedgaussian_PAR_Params2,
#                            modifiedgaussian_127_900_PAR_Params2,
#                            modifiedgaussian_048_900_PAR_Params2,
#                            modifiedgaussian_056_900_PAR_Params2,
#                            modifiedgaussian_077_900_PAR_Params2)
#                            
# 
# # rm(modifiedgaussian_PAR_Params2,
# #                            modifiedgaussian_127_900_PAR_Params2,
# #                            modifiedgaussian_048_900_PAR_Params2,
# #                            modifiedgaussian_056_900_PAR_Params2,
# #                            modifiedgaussian_077_900_PAR_Params2,
# #                           modifiedgaussian_127_900_PAR_Params,
# #                            modifiedgaussian_048_900_PAR_Params,
# #                            modifiedgaussian_056_900_PAR_Params,
# #                            modifiedgaussian_077_900_PAR_Params)
```

d_preds all PAR
```{r}


# modifiedgaussian_PAR_Fit2 <-modifiedgaussian_PAR_Fit %>%
#   mutate(Condition = model_name) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127", 
#                           Strain==2~"PE-rich_048", 
#                           Strain==3~"PC-rich_056", 
#                           Strain==4~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition=="modifiedgaussian"~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_127_900_PAR_Fit2 <-modifiedgaussian_127_900_PAR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_127")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_048_900_PAR_Fit2 <-modifiedgaussian_048_900_PAR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_048")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_056_900_PAR_Fit2 <-modifiedgaussian_056_900_PAR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_056")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_077_900_PAR_Fit2 <-modifiedgaussian_077_900_PAR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# 
# 
# 
# modifiedgaussian_PAR_Fit2ok <- rbind(modifiedgaussian_PAR_Fit2,
#                            modifiedgaussian_127_900_PAR_Fit2,
#                            modifiedgaussian_048_900_PAR_Fit2,
#                            modifiedgaussian_056_900_PAR_Fit2,
#                            modifiedgaussian_077_900_PAR_Fit2)
#                            
# # 
# # rm(modifiedgaussian_PAR_Fit2,
# #                            modifiedgaussian_127_900_PAR_Fit2,
# #                            modifiedgaussian_048_900_PAR_Fit2,
# #                            modifiedgaussian_056_900_PAR_Fit2,
# #                            modifiedgaussian_077_900_PAR_Fit2,
# #                           modifiedgaussian_127_900_PAR_Fit,
# #                            modifiedgaussian_048_900_PAR_Fit,
# #                            modifiedgaussian_056_900_PAR_Fit,
# #                            modifiedgaussian_077_900_PAR_Fit)
# 
# 

```


d2 all PAR
```{r}
#
#modifiedgaussian_077_900_PAR_d2<-d2


# modifiedgaussian_PAR_d22 <-modifiedgaussian_PAR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127", 
#                           Strain==2~"PE-rich_048", 
#                           Strain==3~"PC-rich_056", 
#                           Strain==4~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"less900", Condition==2~"less900", Condition==3~"less900", Condition==4~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_127_900_PAR_d22 <-modifiedgaussian_127_900_PAR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_048_900_PAR_d22 <-modifiedgaussian_048_900_PAR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_048")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_056_900_PAR_d22 <-modifiedgaussian_056_900_PAR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PC-rich_056")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# modifiedgaussian_077_900_PAR_d22 <-modifiedgaussian_077_900_PAR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PAR", PhotonDose=="less900"~"PAR"))
# 
# 
# 
# 
# modifiedgaussian_PAR_d22ok <- rbind(modifiedgaussian_PAR_d22,
#                            modifiedgaussian_127_900_PAR_d22,
#                            modifiedgaussian_048_900_PAR_d22,
#                            modifiedgaussian_056_900_PAR_d22,
#                            modifiedgaussian_077_900_PAR_d22)
# #                            
# # 
# # rm(modifiedgaussian_PAR_d22,
# #                            modifiedgaussian_127_900_PAR_d22,
# #                            modifiedgaussian_048_900_PAR_d22,
# #                            modifiedgaussian_056_900_PAR_d22,
# #                            modifiedgaussian_077_900_PAR_d22,
# #                           modifiedgaussian_127_900_PAR_d2,
# #                            modifiedgaussian_048_900_PAR_d2,
# #                            modifiedgaussian_056_900_PAR_d2,
# #                            modifiedgaussian_077_900_PAR_d2)

```



params all PUR
```{r}

# modifiedgaussian_PUR_Params2 <-modifiedgaussian_PUR_Params %>%
#   mutate(Condition = model_name) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127", 
#                           Strain==2~"PE-rich_048", 
#                           Strain==3~"PC-rich_056", 
#                           Strain==4~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition=="modifiedgaussian"~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_127_900_PUR_Params2 <-modifiedgaussian_127_900_PUR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_127")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_048_900_PUR_Params2 <-modifiedgaussian_048_900_PUR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_048")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_056_900_PUR_Params2 <-modifiedgaussian_056_900_PUR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_056")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_077_900_PUR_Params2 <-modifiedgaussian_077_900_PUR_Params %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# 
# modifiedgaussian_PUR_Params2ok <- rbind(modifiedgaussian_PUR_Params2,
#                            modifiedgaussian_127_900_PUR_Params2,
#                            modifiedgaussian_048_900_PUR_Params2,
#                            modifiedgaussian_056_900_PUR_Params2,
#                            modifiedgaussian_077_900_PUR_Params2)
#                            
# 
# # rm(modifiedgaussian_PUR_Params2,
# #                            modifiedgaussian_127_900_PUR_Params2,
# #                            modifiedgaussian_048_900_PUR_Params2,
# #                            modifiedgaussian_056_900_PUR_Params2,
# #                            modifiedgaussian_077_900_PUR_Params2,
# #                           modifiedgaussian_127_900_PUR_Params,
# #                            modifiedgaussian_048_900_PUR_Params,
# #                            modifiedgaussian_056_900_PUR_Params,
# #                            modifiedgaussian_077_900_PUR_Params)
```

d_preds all PUR
```{r}


# modifiedgaussian_PUR_Fit2 <-modifiedgaussian_PUR_Fit %>%
#   mutate(Condition = model_name) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127", 
#                           Strain==2~"PE-rich_048", 
#                           Strain==3~"PC-rich_056", 
#                           Strain==4~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition=="modifiedgaussian"~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_127_900_PUR_Fit2 <-modifiedgaussian_127_900_PUR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_127")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_048_900_PUR_Fit2 <-modifiedgaussian_048_900_PUR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PE-rich_048")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_056_900_PUR_Fit2 <-modifiedgaussian_056_900_PUR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_056")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_077_900_PUR_Fit2 <-modifiedgaussian_077_900_PUR_Fit %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = model_name) %>% 
#   mutate(Strain=case_when(Strain=="modifiedgaussian"~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# 
# 
# 
# modifiedgaussian_PUR_Fit2ok <- rbind(modifiedgaussian_PUR_Fit2,
#                            modifiedgaussian_127_900_PUR_Fit2,
#                            modifiedgaussian_048_900_PUR_Fit2,
#                            modifiedgaussian_056_900_PUR_Fit2,
#                            modifiedgaussian_077_900_PUR_Fit2)
#                            
# 
# # rm(modifiedgaussian_PUR_Fit2,
# #                            modifiedgaussian_127_900_PUR_Fit2,
# #                            modifiedgaussian_048_900_PUR_Fit2,
# #                            modifiedgaussian_056_900_PUR_Fit2,
# #                            modifiedgaussian_077_900_PUR_Fit2,
# #                           modifiedgaussian_127_900_PUR_Fit,
# #                            modifiedgaussian_048_900_PUR_Fit,
# #                            modifiedgaussian_056_900_PUR_Fit,
# #                            modifiedgaussian_077_900_PUR_Fit)
# 
# 

```


d2 all PUR
```{r}
#
#modifiedgaussian_077_900_PAR_d2<-d2


# modifiedgaussian_PUR_d22 <-modifiedgaussian_PUR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127", 
#                           Strain==2~"PE-rich_048", 
#                           Strain==3~"PC-rich_056", 
#                           Strain==4~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"less900", Condition==2~"less900", Condition==3~"less900", Condition==4~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_127_900_PUR_d22 <-modifiedgaussian_127_900_PUR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_127")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_048_900_PUR_d22 <-modifiedgaussian_048_900_PUR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PE-rich_048")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_056_900_PUR_d22 <-modifiedgaussian_056_900_PUR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PC-rich_056")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# modifiedgaussian_077_900_PUR_d22 <-modifiedgaussian_077_900_PUR_d2 %>%
#   mutate(Condition = curve_id) %>% 
#   mutate(Strain = curve_id) %>% 
#   mutate(Strain=case_when(Strain==1~"PC-rich_077")) %>%
#   mutate(Condition=case_when(Condition==1~"equal900", Condition==2~"less900")) %>% 
#   mutate(PhotonDose = Condition) %>% 
#   mutate(PhotonDose=case_when(PhotonDose=="equal900"~"PUR", PhotonDose=="less900"~"PUR"))
# 
# 
# 
# 
# modifiedgaussian_PUR_d22ok <- rbind(modifiedgaussian_PUR_d22,
#                            modifiedgaussian_127_900_PUR_d22,
#                            modifiedgaussian_048_900_PUR_d22,
#                            modifiedgaussian_056_900_PUR_d22,
#                            modifiedgaussian_077_900_PUR_d22)
#                            
# 
# # rm(modifiedgaussian_PUR_d22,
# #                            modifiedgaussian_127_900_PUR_d22,
# #                            modifiedgaussian_048_900_PUR_d22,
# #                            modifiedgaussian_056_900_PUR_d22,
# #                            modifiedgaussian_077_900_PUR_d22,
# #                           modifiedgaussian_127_900_PUR_d2,
# #                            modifiedgaussian_048_900_PUR_d2,
# #                            modifiedgaussian_056_900_PUR_d2,
# #                            modifiedgaussian_077_900_PUR_d2)

```


```{r}


# modifiedgaussian_Params2ok <-rbind(modifiedgaussian_PAR_Params2ok, modifiedgaussian_PUR_Params2ok)
# modifiedgaussian_Fit2ok <-rbind(modifiedgaussian_PAR_Fit2ok, modifiedgaussian_PUR_Fit2ok)
# modifiedgaussian_d22ok <-rbind(modifiedgaussian_PAR_d22ok, modifiedgaussian_PUR_d22ok)
# 


```





# Save assembled spectra data set
```{r save fit params}

# saveRDS(modifiedgaussian_Params2ok, file.path(DataOut, paste(Project, "modifiedgaussian_Params2ok.Rds", sep = "_"), fsep = .Platform$file.sep))
# 
# saveRDS(modifiedgaussian_Fit2ok, file.path(DataOut, paste(Project, "modifiedgaussian_Fit2ok.Rds", sep = "_"), fsep = .Platform$file.sep))
# 
# saveRDS(modifiedgaussian_d22ok, file.path(DataOut, paste(Project, "modifiedgaussian_d22ok.Rds", sep = "_"), fsep = .Platform$file.sep))
# 
# saveRDS(CleanGrowthPARPUR, file.path(DataOut, paste(Project, "CleanGrowthPARPUR.Rds", sep = "_"), fsep = .Platform$file.sep))

```


Fit file
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "SySlmanuscriptWWPhotoperiod", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```

Fit file
Exported Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

 

Fit file
```{r read ProcessFile}
CleanGrowthPARPURFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_CleanGrowthPARPUR.Rds"
CleanGrowthPARPURFileName <- str_split(string = CleanGrowthPARPURFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
CleanGrowthPARPUR <- readRDS(CleanGrowthPARPURFile)  %>%
  ungroup()


quadratic_d2File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_modifiedgaussian_d22ok.Rds"
quadratic_d2FileName <- str_split(string = quadratic_d2File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
quadratic_d2 <- readRDS(quadratic_d2File)  %>%
  ungroup()

quadratic_FitFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_modifiedgaussian_Fit2ok.Rds" 
quadratic_FitFileName <- str_split(string = quadratic_FitFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
quadratic_Fit <- readRDS(quadratic_FitFile)  %>%
  ungroup()

quadratic_ParamsFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_modifiedgaussian_Params2ok.Rds"
quadratic_ParamsFileName <- str_split(string = quadratic_ParamsFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
quadratic_Params <- readRDS(quadratic_ParamsFile)  %>%
  ungroup()

```


```{r}

# quadratic_d2<-quadratic_d2 %>% 
#   filter(curve_id == 1)
# 
# quadratic_Fit<-quadratic_Fit %>% 
#   filter(curve_id == 1)
# 
# quadratic_Params<-quadratic_Params %>% 
#   filter(curve_id == 1)
# 
# 
# quadratic_d2ok<-rbind(quadratic_d2,quadratic_d22)
# quadratic_Fitok<-rbind(quadratic_Fit,quadratic_Fit2)
# quadratic_Paramsok<-rbind(quadratic_Params,quadratic_Params2)
# 
# quadratic_Fitok<-quadratic_Fitok %>% 
#   mutate(O2 = PhotonDose) %>% 
#   mutate(O2=case_when(O2=="PAR"~21, PhotonDose=="PUR"~21))

```

```{r}
quadratic_Fit<-quadratic_Fit %>%
  # mutate(Strain=case_when(Strain=="PE-rich_0048"~"PE-rich_048",
  #                         Strain=="PE-rich_127"~"PE-rich_127",
  #                         Strain=="PC-rich_056"~"PC-rich_056",
  #                         Strain=="PC-rich_077"~"PC-rich_077",
  #                         Strain=="PE-rich_048"~"PE-rich_048")) %>% 
  mutate(O2 = model_name) %>%
  mutate(O2=case_when(O2=="modifiedgaussian"~21))
```


```{r fig.height = 8, fig.width = 8, warning = FALSE}

#str(CleanGrowthPARPUR)
# CleanGrowthPARPUR2<-CleanGrowthPARPUR %>% 
# filter(deltaOD_Lmu_se<1.146435e-03)


O2.labs <- c("Strain")
names(O2.labs) <- c(21)

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(CleanGrowthPARPUR, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T, CleanGrowthPARPUR) +
  
  # geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  
  geom_line(aes(temp, .fitted, linetype=as.factor(Condition)), show.legend = F, quadratic_Fit) +
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  # scale_colour_manual(values = c("black", "pink4", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  geom_hline(aes(yintercept = 0), linetype = 2) +

  #ggh4x::facet_nested(cols = vars(Strain), rows = vars(PhotonDose)) +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        #legend.position = c(0.06,0.85),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.15, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))


```

```{r test inhibition plot}

# TestI = c(0:28)
# 
#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}
# 
# plot(x = TestI, y = grcplatt(I = TestI, a = 0.1, b = 0.01, Pmax = 1))
# 
# #plot(x = TestI, y = grcplatt(I = TestI, a = 0.1, b = 0.1, Pmax = 1))

# grcplattlag <- function(I, lag, a, b, Pmax){Pmax * (1-exp(-a*(I-lag)/Pmax)) * exp(-b*(I-lag)/Pmax)}
# 
# 
# 
# grcplattlag2 <- function(I, lag, a, b, Pmax){Pmax * (1-exp(-a*(I-lag)/Pmax)) * exp(-b*(I-lag)/Pmax)}
# 
# logistic_eqn <- function(I, Pmax, mu, intercept){(Pmax*intercept*exp(mu*I))/(Pmax + (intercept*(exp(mu*I)-1)))}

```


dummy df
```{r}

gs4_deauth()

dummy<- read_sheet("https://docs.google.com/spreadsheets/d/11OcbG_HGQyYySYfpDpEGfEdOsIkJO6-k3RN-VXcWFAA/edit#gid=0")

as.data.frame(dummy)
dummy <- dummy

dummy<-dummy %>%
  mutate(PhotonDose_value = as.numeric(PhotonDose_value)) %>%
  mutate(deltaOD_Lmu_corr = as.numeric(deltaOD_Lmu_corr))

```



```{r}


CleanGrowthPARPURfit900 <- CleanGrowthPARPUR %>%   
  filter(Par_ue ==900) 
  #select(-c(facetsStrain))

#CleanGrowthPARPURfit900$facetsStrain = factor(CleanGrowthPARPURfit900$O2, labels = c("Strain"))


CleanGrowthPARPURfit900dummy<-rbind(CleanGrowthPARPURfit900, dummy)


```





Harrison & Platt, 1986 
```{r platt fit}

# PURPARStrainO2NestDummy <- PURPARFits_dummy |>   
#   nest(data = -c("Strain","O2_uM")) |> 
#   mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PUR_day, a, b, Pmax),
#                                                     data = .x, start = list(a = 1e-7, b = 1e-8, Pmax = 1),  
#                                                     lower = c(0, 0, 0),    
#                                                     upper = c(1,1,100)),
#                                                     0))) |>   
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))




CleanGrowthPARPURfit <- CleanGrowthPARPUR |>   
  filter(Par_ue !=900) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth <- CleanGrowthPARPURfit |>
  unnest(GRCplatt_Predict)


# CleanGrowthPARPURfit |>   
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>   
#   unnest(GRCplatt_Predict, data) |>   
#   ggplot() +   
#   geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr)) +   
#   geom_line(aes(x = PhotonDose_value, y = `.fitted`)) +   
#   facet_grid(rows = vars(Strain), cols = vars(PhotonDose)) +   
#   #labs(title = "PURPARStrainO2NestDummy Platt") +   
#   theme_bw()



# logistic_eqn <- function(I, Pmax, mu, intercept){(Pmax*intercept*exp(mu*I))/(Pmax + (intercept*(exp(mu*I)-1)))}
# 
# CleanGrowthPARPURfitlog <- CleanGrowthPARPURfit900dummy2 |>   
#   #filter(Par_ue !=900) |> 
#   #filter(PhotonDose == "PAR") |>
#   nest(data = -c("Strain", "PhotonDose")) |> 
#   mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ logistic_eqn(I = PhotonDose_value, Pmax, mu, intercept),
#                                                     data = .x,
#                                                     start = list(mu = 0.1/2e7, intercept = 0, Pmax = 0.2),
#                                                     lower = c(0, 0, 0)))
#                                                     #upper = c(1,1,100)), 
#                                                     #0))
#          ) |>   
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )
# 
# CleanGrowthPARPURfitlog |>
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>
#   unnest(GRCplatt_Predict, data) |>
#   ggplot() +
#   geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr)) +
#   geom_line(aes(x = PhotonDose_value, y = `.fitted`)) +
#   facet_grid(rows = vars(Strain), cols = vars(PhotonDose)) +
#   #labs(title = "PURPARStrainO2NestDummy Platt") +
#   theme_bw()
```


Harrison & Platt, 1986 
```{r platt fit}


CleanGrowthPARPURfit900 <- CleanGrowthPARPURfit900dummy |>   
  #filter(Par_ue ==900) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth900 <- CleanGrowthPARPURfit900 |>
  unnest(GRCplatt_Predict)


# CleanGrowthPARPURfit |>   
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>   
#   unnest(GRCplatt_Predict, data) |>   
#   ggplot() +   
#   geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr)) +   
#   geom_line(aes(x = PhotonDose_value, y = `.fitted`)) +   
#   facet_grid(rows = vars(Strain), cols = vars(PhotonDose)) +   
#   #labs(title = "PURPARStrainO2NestDummy Platt") +   
#   theme_bw()

```




to get nice facet
```{r}

CleanGrowthPARPUR$facetsStrain = factor(CleanGrowthPARPUR$WL, labels = c("Strain"))

GRCplatt_PredictGrowth$facetsStrain = factor(GRCplatt_PredictGrowth$PhotonDose, labels = c("Strain", "Strain"))

GRCplatt_PredictGrowth900$facetsStrain = factor(GRCplatt_PredictGrowth900$PhotonDose, labels = c("Strain", "Strain"))

```

Only for nice geom_ribbon
```{r}

# CleanGrowthPARPURfitbez900 <- CleanGrowthPARPUR %>%
#   filter(Par_ue !=900)
# 
# GRCplatt_PredictGrowthPlot<-GRCplatt_PredictGrowth %>%
# select(-c(data, GRCplatt_Glance, GRCplatt_Param))
# 
# GRCplatt_PredictGrowthPlot2<-GRCplatt_PredictGrowthPlot %>%
#   left_join(., CleanGrowthPARPURfitbez900, by = c("Strain"="Strain", "PhotonDose"="PhotonDose", "deltaOD_Lmu_corr"="deltaOD_Lmu_corr", "PhotonDose_value"="PhotonDose_value", "facetsStrain"="facetsStrain"))
# 
# GRCplatt_PredictGrowthPlot2<-GRCplatt_PredictGrowthPlot2 %>%
# filter(deltaOD_Lmu_se<8.057558e-03)
# 
# 
# 
# 
# GRCplatt_PredictGrowth900Plot<-GRCplatt_PredictGrowth900 %>%
# select(-c(data, GRCplatt_Glance, GRCplatt_Param))
# 
# GRCplatt_PredictGrowth900Plot2<-GRCplatt_PredictGrowth900Plot %>%
#   left_join(., CleanGrowthPARPURfit900, by = c("Strain"="Strain", "PhotonDose"="PhotonDose", "deltaOD_Lmu_corr"="deltaOD_Lmu_corr", "PhotonDose_value"="PhotonDose_value"))
# 
# GRCplatt_PredictGrowth900Plot2<-GRCplatt_PredictGrowth900Plot2 %>%
# filter(deltaOD_Lmu_se<8.057558e-03)
        
  #colnames(GRCplatt_PredictGrowth900)
```
```{r}
CleanGrowthPARPURfitbez900 <- CleanGrowthPARPUR %>%    
  filter(Par_ue !=900) 

CleanGrowthPARPURfittylko900 <- CleanGrowthPARPUR %>%    
  filter(Par_ue ==900) %>% 
  filter(deltaOD_Lmu_se<8.057558e-03)
```



```{r fig.height = 8, fig.width = 8, warning = FALSE}

# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(CleanGrowthPARPUR, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, alpha = Par_ue, shape = as.factor(Photoperiod)), size = 3.5, show.legend = T, CleanGrowthPARPUR) +

  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +

  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth900) +
  
  # geom_ribbon(aes(x = PhotonDose_value, ymin=.fitted-.resid, ymax=.fitted+.resid), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowth) +
  # geom_ribbon(aes(x = PhotonDose_value, ymin=.fitted-.resid, ymax=.fitted+.resid), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowth900) +
  # geom_ribbon(aes(x = PhotonDose_value, ymin=deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax=deltaOD_Lmu_corr + deltaOD_Lmu_se), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowth900) +
  
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  # scale_colour_manual(values = c("black", "pink4", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  #geom_hline(aes(yintercept = 0), linetype = 2) +

    ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        #legend.position = c(0.06,0.85),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.15, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))



ggplot(CleanGrowthPARPUR, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Strain), size = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, show.legend = T, CleanGrowthPARPUR) +
# 
#   geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +

  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth900) +
  
  geom_ribbon(aes(x = PhotonDose_value, ymin=.fitted-.resid, ymax=.fitted+.resid), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowth) +
  geom_ribbon(aes(x = PhotonDose_value, ymin=.fitted-.resid, ymax=.fitted+.resid), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowth900) +
  # geom_ribbon(aes(x = PhotonDose_value, ymin=deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax=deltaOD_Lmu_corr + deltaOD_Lmu_se), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowth900) +
  
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  
  # scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  
  # scale_size_manual(values = c("", "", 0.5, 1, 1.5, 2, 2.5), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  # scale_colour_manual(values = c("black", "pink4", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  #geom_hline(aes(yintercept = 0), linetype = 2) +

    ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        #legend.position = c(0.06,0.85),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.15, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))










ggplot(CleanGrowthPARPUR, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T, CleanGrowthPARPUR) +

  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +

  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth900) +
  
  # geom_ribbon(aes(x = PhotonDose_value, ymin=deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax=deltaOD_Lmu_corr + deltaOD_Lmu_se), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowth900Plot2) +
  # geom_ribbon(aes(x = PhotonDose_value, ymin=deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax=deltaOD_Lmu_corr + deltaOD_Lmu_se), fill = "gray", alpha = 0.5, GRCplatt_PredictGrowthPlot2) +
  
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  # scale_colour_manual(values = c("black", "pink4", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  #geom_hline(aes(yintercept = 0), linetype = 2) +

    ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        #legend.position = c(0.06,0.85),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.15, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))





ggplot(CleanGrowthPARPUR, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T, CleanGrowthPARPUR) +

  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth900) +
  
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  # scale_colour_manual(values = c("black", "pink4", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  #geom_hline(aes(yintercept = 0), linetype = 2) +

    ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        #legend.position = c(0.06,0.85),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.15, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))

```




Solisense file
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "SolisenseDoubletap", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```

Solisense file
Exported only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Solisense file
```{r read ProcessFile}
# SolisenseFile <- "../ImportedData/SolisenseDoubletap/PICO_WWphotoperidRefit.Rds"
# 
# SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# 
# SolFitsRefit <- readRDS(SolisenseFile)  %>%
#   ungroup()



SolisenseFile <- "../ImportedData/SolisenseDoubletap/PICO_SySlWWPhotoperiodAll.Rds"

SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits <- readRDS(SolisenseFile)  %>%
  ungroup()




```

```{r}
SolFitsAll <-SolFits %>% 
  filter(Strain=="BA127R"| Strain=="BA48R"| Strain=="BA56G"| Strain=="BA77G") %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

SolFitsAll$facets = factor(SolFitsAll$O2, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

SolFitsAll$facets2 = factor(SolFitsAll$WL, labels = c("Excitation~(nm)"))

SolFitsAll$facetsStrain = factor(SolFitsAll$WL, labels = c("Strain"))
```


```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

# SolFitsAll %>% 
#   filter(PARPhotonDose == 432000 | PARPhotonDose == 864000 | PARPhotonDose == 1944000 | PARPhotonDose == 3888000 | PARPhotonDose == 6480000 | PARPhotonDose == 8640000) %>%
#   # filter(ExpDay != 1 &  ExpDay != 2 & ExpDay != 3 & ExpDay != 4 & ExpDay != 5) %>%
#   # filter(ExpDay != 14) %>% 
#   ggplot() +
#   geom_point(aes(x = Time_h, y = meanSig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
#   geom_errorbar(aes(x = Time_h, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
#   #geom_point(aes(x = ActPAR, y = Sig, colour = as.factor(Strain)), show.legend = F) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   labs(y = "Sigma", x = "Elapsed time (h)") +
#   scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
#   coord_cartesian(ylim = c(0, 1000)) +
#   # scale_x_continuous(breaks=seq(50, 200, by = 50)) +
#   # coord_cartesian(xlim = c(50, 200)) +
#   #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
#   ggh4x::facet_nested(cols = vars(facets, PARPhotonDose), rows = vars(facets2, Ex_WL), labeller = label_parsed) +
#   #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
#   
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=11),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.075,0.94),
#         legend.key.height= unit(0.003, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         legend.spacing.x = unit(-0.1, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=9))

SolFitsAll %>% 
  #filter(E_days< 13) %>% 
  ggplot() +
  geom_point(aes(x = Time_h, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  #geom_errorbar(aes(x = Time_h, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "Elapsed time (h)") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  #scale_x_continuous(label=scientific_10) +
  # scale_x_continuous(breaks=seq(50, 200, by = 50)) +
  # coord_cartesian(xlim = c(50, 200)) +
  #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
  ggh4x::facet_nested(cols = vars(facets2,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))


SolFitsAll %>% 
  #filter(E_days< 13) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  #geom_point(aes(x = ActPAR, y = Sig, colour = as.factor(Strain)), show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  scale_x_continuous(label=scientific_10) +
  # scale_x_continuous(breaks=seq(50, 200, by = 50)) +
  # coord_cartesian(xlim = c(50, 200)) +
  #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
  ggh4x::facet_nested(cols = vars(facets2,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))


SolFitsAll %>% 
  filter(E_days<10) %>% 
  filter(E_days !=2) %>% 
  filter(E_days !=3) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  #geom_point(aes(x = ActPAR, y = Sig, colour = as.factor(Strain)), show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  scale_x_continuous(label=scientific_10) +
  # scale_x_continuous(breaks=seq(50, 200, by = 50)) +
  # coord_cartesian(xlim = c(50, 200)) +
  #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
  ggh4x::facet_nested(cols = vars(facets2,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))

```

We recalculated all the half-life values (T 1/2 ) by using the following equation for one phase decay: Y = (Y0 -Plateau)*exp(-K*X) + Plateau, where X = Time, Y = RNA levels, starting at Y0 and decaying (with one phase) down to plateau; Y0 and plateau have same units as Y; K = Rate constant equal to the recip-
rocal of the X-axis units 

k= the rate constant for Sigma decay (i.e., percent change over time), 

https://www.researchgate.net/figure/The-one-phase-decay-curve-A-and-the-mRNA-quantification-curve-B-from-the-pulse-chase_fig1_235381210

Y = (Y0 -Plateau)*exp(-K*X) + Plateau,

Y - Sigma levels
Y0 - max Sigma
Plateau - min Sigma
X - photon dose


exp_eqn <- function(x, Emu, Eintercept){(Eintercept*exp(x*Emu))}
 
mutate(OD720trunc_exp = map(tubedata, possibly(~nlsLM(OD720 ~ exp_eqn(x = time, Emu, Eintercept),
                            data = .x %>%
                            filter(OD720 <= (max(OD720) * TruncFactor)),
                            start = list(Emu = (log(max(.$rollmeanOD720, na.rm = TRUE)) - log(min(.$rollmeanOD720, na.rm = TRUE)))/max(.$time), Eintercept = min(.$rollmeanOD720, na.rm = TRUE)),
                            control = list(maxiter = 500)), otherwise = NULL)),



https://stackoverflow.com/questions/50510797/exponential-decay-fit-in-r

https://douglas-watson.github.io/post/2018-09_exponential_curve_fitting/


one phase decay

one curve
```{r}

# SolFitsAllfit <-SolFitsAll %>% 
#   filter(Strain == "PC-rich_077") %>% 
#   filter(Ex_WL == 590) %>% 
#   select(c(meanSig, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
#   mutate(y=meanSig) %>% 
#   mutate(t=PARPhotonDose) 
  
```

one curve
```{r}
# fit <- nls(y ~ SSasymp(t, yf, y0, log_alpha), data = SolFitsAllfit)
# fit
# 
# qplot(t, y, data = augment(fit)) + geom_line(aes(y = .fitted))
```

multiple curves
```{r}

# SolFitsAllfit2 <-SolFitsAll %>% 
#   #filter(Strain == "PC-rich_077") %>% 
#   filter(Ex_WL == 590) %>% 
#   select(c(meanSig, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
#   mutate(y=meanSig) %>% 
#   mutate(t=PARPhotonDose) 
  
```

multiple curves
```{r}
# # Fit the data
# fitted <- SolFitsAllfit2 %>% 
#   nest(-Strain) %>%
#   mutate(
#     fit = map(data, ~nls(y ~ SSasymp(t, yf, y0, log_alpha), data = .)),
#     tidied = map(fit, tidy),
#     augmented = map(fit, augment),
#   )  
# 
# # Produce a table of fit parameters: y0, yf, alpha - doesnt work for now - fix this later!
# # fitted %>% 
# #   unnest(tidied) %>% 
# #   select(term, estimate) %>% 
# #   spread(term, estimate) %>% 
# #   mutate(alpha = exp(log_alpha))
# 
# #Plotting with gglot2
# augmented <- fitted %>% 
#   unnest(augmented)
# qplot(t, y, data = augmented, geom = 'point', colour = Strain) +
#   geom_line(aes(y=.fitted))

```


multiple curves PAR photon Dose 590
```{r}

SolFitsAllfit590 <-SolFitsAll %>% 
  filter(E_days<10) %>% 
  filter(E_days !=2) %>% 
  filter(E_days !=3) %>% 
  #filter(Strain == "PC-rich_077") %>% 
  filter(Ex_WL == 590) %>% 
  select(c(meanSig, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
  mutate(y=meanSig) %>% 
  mutate(t=PARPhotonDose) 
  
```

multiple curves PAR photon Dose 590
```{r}
# Fit the data
fitted <- SolFitsAllfit590 %>% 
  nest(-Strain) %>%
  mutate(
    fit = map(data, ~nls(y ~ SSasymp(t, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented590 = map(fit, augment),
  )  

# Produce a table of fit parameters: y0, yf, alpha - doesnt work for now - fix this later!
# fitted %>% 
#   unnest(tidied) %>% 
#   select(term, estimate) %>% 
#   spread(term, estimate) %>% 
#   mutate(alpha = exp(log_alpha))

#Plotting with gglot2
augmented590 <- fitted %>% 
  unnest(augmented590)
# qplot(t, y, data = augmented590, geom = 'point', colour = Strain) +
#   geom_line(aes(y=.fitted))

```


multiple curves PAR photon Dose 445
```{r}

SolFitsAllfit445 <-SolFitsAll %>% 
  filter(E_days<10) %>% 
  filter(E_days !=2) %>% 
  filter(E_days !=3) %>% 
  #filter(Strain == "PC-rich_077") %>% 
  filter(Ex_WL == 445) %>% 
  select(c(meanSig, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
  mutate(y=meanSig) %>% 
  mutate(t=PARPhotonDose) 
  
```

multiple curves PAR photon Dose 445
```{r}
# Fit the data
fitted <- SolFitsAllfit445 %>% 
  nest(-Strain) %>%
  mutate(
    fit = map(data, ~nls(y ~ SSasymp(t, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented445 = map(fit, augment),
  )  

#Plotting with gglot2
augmented445 <- fitted %>% 
  unnest(augmented445)
# qplot(t, y, data = augmented445, geom = 'point', colour = Strain) +
#   geom_line(aes(y=.fitted))

```


mutate for nice plot PAR photon Dose 590
```{r}
augmented590 <- augmented590 %>% 
  mutate(Ex_WL=Strain) %>% 
      mutate(Ex_WL=case_when(Ex_WL=="PE-rich_127"~590,
         Ex_WL=="PE-rich_048"~590,
        Ex_WL=="PC-rich_056"~590,
         Ex_WL=="PC-rich_077"~590)) %>% 
  mutate(Ex_WL = as.factor(Ex_WL)) %>% 
  
  mutate(O2=Ex_WL) %>% 
  mutate(O2=case_when(O2==590~21)) %>% 
  
  mutate(WL=Ex_WL) %>% 
  mutate(WL=case_when(WL==590~"WW")) 

#str(SolFitsAll)
```

mutate for nice plot PAR photon Dose 445
```{r}
augmented445 <- augmented445 %>% 
  mutate(Ex_WL=Strain) %>% 
      mutate(Ex_WL=case_when(Ex_WL=="PE-rich_127"~445,
         Ex_WL=="PE-rich_048"~445,
        Ex_WL=="PC-rich_056"~445,
         Ex_WL=="PC-rich_077"~445)) %>% 
  mutate(Ex_WL = as.factor(Ex_WL)) %>% 
  
  mutate(O2=Ex_WL) %>% 
  mutate(O2=case_when(O2==445~21)) %>% 
  
  mutate(WL=Ex_WL) %>% 
  mutate(WL=case_when(WL==445~"WW")) 

#str(SolFitsAll)
```


```{r}
SolFitsAllFilter <-SolFitsAll %>% 
  filter(E_days<10) %>% 
  filter(E_days !=2) %>% 
  filter(E_days !=3) 
```



```{r fig.height = 8, fig.width = 8, warning = FALSE}


WL.labs <- c("Excitation (nm)")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


  ggplot(SolFitsAllFilter, aes(x = PARPhotonDose, y = meanSig)) +
  geom_point(aes(x = PARPhotonDose, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  #geom_errorbar(aes(x = PARPhotonDose, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  
  geom_line(aes(t, .fitted), show.legend = F, augmented590) +
  geom_line(aes(t, .fitted), show.legend = F, augmented445) +
  #geom_point(aes(x = ActPAR, y = Sig, colour = as.factor(Strain)), show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  scale_x_continuous(label=scientific_10) +

  #ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  ggh4x::facet_nested(rows = vars(O2,Strain), cols = vars(WL,Ex_WL), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))

```


https://www.r-bloggers.com/2020/02/a-collection-of-self-starters-for-nonlinear-regression-in-r/



```{r}
#colnames(MaxGrowthExpSt)

SolFitsAll2 <-SolFitsAll %>%
select(-c(facets,facets2)) 
  

SolFitsAllPigment <- SolFitsAll2 %>%
  left_join(., MultiCultiPigmentMaxAll, by = c("Run"="Run","CultureID"="ID","Strain"="Strain","InnocDate"="InnocDate","ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","PARPhotonDose"="PARPhotonDose", "E_days"="E_days", "Time_h"="Time_h")) 
#"ObsDate"="OlisDate"

```


```{r}
SolFitsAllPigment$facetsPhotonDose = factor(SolFitsAllPigment$O2, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

SolFitsAllPigment$facetsExcitation = factor(SolFitsAllPigment$WL, labels = c("Excitation~(nm)"))

SolFitsAllPigment$facetsStrain = factor(SolFitsAllPigment$WL, labels = c("Strain"))

```



```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


SolFitsAllPigment %>% 
  #filter(E_days<10) %>% 
  ggplot() +
  geom_point(aes(x = Phycopgcell, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = Phycopgcell, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  #geom_point(aes(x = ActPAR, y = Sig, colour = as.factor(Strain)), show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "Total phycobilin content ( pg "~cell^-1~")") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  #scale_x_continuous(label=scientific_10) +
  # scale_x_continuous(breaks=seq(50, 200, by = 50)) +
  # coord_cartesian(xlim = c(50, 200)) +
  #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))


SolFitsAllPigment %>% 
  #filter(E_days< 13) %>% 
  ggplot() +
  geom_point(aes(x = Chlapgcell, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = Chlapgcell, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  #geom_point(aes(x = ActPAR, y = Sig, colour = as.factor(Strain)), show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  #scale_x_continuous(label=scientific_10) +
  # scale_x_continuous(breaks=seq(50, 200, by = 50)) +
  # coord_cartesian(xlim = c(50, 200)) +
  #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))



```

Soisense fit
```{r test inhibition plot}

#Harrison & Platt, 1986 
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)} 

```


```{r platt fit}
SolFitsAllPigmentfit <- SolFitsAllPigment |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig, Phycopgcell, Chlapgcell, O2, WL)) |> 
  #filter(Ex_WL !=445) |> 
  #filter(Strain!="PE-rich_048") |> 
  nest(data = -c("Strain", "Ex_WL")) |>  
  mutate(GRCplatt_Model = map(data, ~nlsLM(meanSig ~ grcplatt(I = Phycopgcell, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 500/40, b = 50/40, Pmax = 800),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_Predict <- SolFitsAllPigmentfit |>
  unnest(GRCplatt_Predict)



# SolFitsAllPigmentfit |>    
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>    
#   unnest(GRCplatt_Predict) |> 
#   ggplot() +   
#   geom_point(aes(x = Phycopgcell, y = meanSig)) +   
#   geom_line(aes(x = Phycopgcell, y = `.fitted`)) +   
#   facet_grid(rows = vars(Strain), cols = vars(Ex_WL)) +   
#   #labs(title = "PURPARStrainO2NestDummy Platt") +   
#   theme_bw()

```


```{r platt fit}
SolFitsAllPigmentfitChla <- SolFitsAllPigment |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig, Phycopgcell, Chlapgcell, O2, WL)) |> 
  #filter(Ex_WL !=445) |> 
  #filter(Strain!="PE-rich_048") |> 
  nest(data = -c("Strain", "Ex_WL")) |>  
  mutate(GRCplatt_Model = map(data, ~nlsLM(meanSig ~ grcplatt(I = Chlapgcell, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 100/12, b = 10/12, Pmax = 200),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictChla <- SolFitsAllPigmentfitChla |>
  unnest(GRCplatt_Predict)

# SolFitsAllPigmentfitChla |>
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>
#   unnest(GRCplatt_Predict) |>
#   ggplot() +
#   geom_point(aes(x = Chlapgcell, y = meanSig)) +
#   geom_line(aes(x = Chlapgcell, y = `.fitted`)) +
#   facet_grid(rows = vars(Strain), cols = vars(Ex_WL)) +
#   #labs(title = "PURPARStrainO2NestDummy Platt") +
#   theme_bw()
```

Add extra facets to create a nice plot
```{r}
GRCplatt_Predict$facetsPhotonDose = factor(GRCplatt_Predict$Ex_WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})", "PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

GRCplatt_Predict$facetsExcitation = factor(GRCplatt_Predict$Ex_WL, labels = c("Excitation~(nm)", "Excitation~(nm)"))

GRCplatt_Predict$facetsStrain = factor(GRCplatt_Predict$Ex_WL, labels = c("Strain","Strain"))


GRCplatt_PredictChla$facetsPhotonDose = factor(GRCplatt_PredictChla$Ex_WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})", "PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

GRCplatt_PredictChla$facetsExcitation = factor(GRCplatt_PredictChla$Ex_WL, labels = c("Excitation~(nm)", "Excitation~(nm)"))

GRCplatt_PredictChla$facetsStrain = factor(GRCplatt_PredictChla$Ex_WL, labels = c("Strain", "Strain"))

```


```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


SolFitsAllPigmentfit  %>%     
  filter(!map_lgl(GRCplatt_Model, is.null))  %>%     
  unnest(GRCplatt_Predict)   
  
  ggplot(SolFitsAllPigment, aes(x = Phycopgcell, y = meanSig)) +
  geom_point(aes(x = Phycopgcell, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +   
  geom_line(aes(x = Phycopgcell, y = `.fitted`), show.legend = F, GRCplatt_Predict) +   

  #geom_errorbar(aes(x = Phycopgcell, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "Total phycobilin content ( pg "~cell^-1~")") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  #scale_x_continuous(label=scientific_10) +
  # scale_x_continuous(breaks=seq(50, 200, by = 50)) +
  # coord_cartesian(xlim = c(50, 200)) +
  #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))

  
  
SolFitsAllPigmentfitChla  %>%     
  filter(!map_lgl(GRCplatt_Model, is.null))  %>%     
  unnest(GRCplatt_Predict)   
  
  ggplot(SolFitsAllPigment, aes(x = Chlapgcell, y = meanSig)) +
  geom_point(aes(x = Chlapgcell, y = meanSig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +   
  geom_line(aes(x = Chlapgcell, y = `.fitted`), show.legend = F, GRCplatt_PredictChla) +   

  #geom_errorbar(aes(x = Phycopgcell, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  # scale_x_continuous(label=scientific_10) +
  # scale_x_continuous(breaks=seq(0, 12, by = 3)) +
  # coord_cartesian(xlim = c(0, 13)) +
  #facet_grid(cols = vars(PARPhotonDose), rows = vars(Ex_WL), scale="free_y") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))

  
```

Solisense file test refit and raw

```{r read ProcessFile}
# SolisenseFile <- "../ImportedData/SolisenseDoubletap/PICO_ColorRefit.Rds"
# 
# SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# 
# SolFitsRefit <- readRDS(SolisenseFile)  %>%
#   ungroup()
# 
# 
# 
# SolisenseFile <- "../ImportedData/SolisenseDoubletap/PICO_SySlColourLightAll.Rds" 
# 
# SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# 
# SolFits <- readRDS(SolisenseFile)  %>%
#   ungroup()
# 
# 
# SolisenseFile <- "../ImportedData/SolisenseDoubletap/PICO_StPhaseRefit.Rds"
# 
# SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# 
# SolFitsStPhaseRefit <- readRDS(SolisenseFile)  %>%
#   ungroup()
# 
# 
# 
# SolisenseFile <- "../ImportedData/SolisenseDoubletap/PICO_SySlStatPhase.Rds"
# 
# SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# 
# SolFitsStPhase <- readRDS(SolisenseFile)  %>%
#   ungroup()

```

test plot to compare refit and raw data from Solisense
```{r fig.height = 6, fig.width = 8, warning = FALSE}



# SolFitsRefit %>% 
#   filter(Ex_WL == 590 | Ex_WL == 445) %>% 
#   filter(Strain == "BA77G") %>% 
#   ggplot() +
#   geom_point(aes(x = E_days, y = Sig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
#   #geom_errorbar(aes(x = E_days, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   # scale_y_continuous(breaks=seq(0, 200, by = 50)) +
#   # coord_cartesian(ylim = c(0, 200)) +
#   ggh4x::facet_nested(rows = vars(Ex_WL,Par_ue), cols = vars(Photoperiod, O2)) +
#   #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
#   
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=11),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.24,0.95),
#         legend.key.height= unit(0.003, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=9))
# 
# 
# SolFits %>% 
#   filter(Ex_WL == 590 | Ex_WL == 445) %>% 
#   filter(Strain == "BA77G") %>% 
#   ggplot() +
#   geom_point(aes(x = E_days, y = Sig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
#   #geom_errorbar(aes(x = E_days, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   # scale_y_continuous(breaks=seq(0, 200, by = 50)) +
#   # coord_cartesian(ylim = c(0, 200)) +
#   #facet_grid(rows = vars(Strain)) +
#   ggh4x::facet_nested(rows = vars(Ex_WL,Par_ue), cols = vars(Photoperiod, O2)) +
#     # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=11),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.24,0.95),
#         legend.key.height= unit(0.003, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=9))
# 
# 
# SolFitsStPhaseRefit %>% 
#   # filter(Ex_WL == 590 | Ex_WL == 445) %>% 
#   # filter(Strain == "BA77G") %>% 
#   ggplot() +
#   geom_point(aes(x = E_days, y = Sig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
#   #geom_errorbar(aes(x = E_days, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   # scale_y_continuous(breaks=seq(0, 200, by = 50)) +
#   # coord_cartesian(ylim = c(0, 200)) +
#   ggh4x::facet_nested(rows = vars(Ex_WL,Par_ue), cols = vars(Photoperiod, O2)) +
#   #ggh4x::facet_nested(rows = vars(Strain, Ex_WL), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
#   
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=11),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.24,0.95),
#         legend.key.height= unit(0.003, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=9))
# 
# 
# SolFitsStPhase %>% 
#   # filter(Ex_WL == 590 | Ex_WL == 445) %>% 
#   # filter(Strain == "BA77G") %>% 
#   ggplot() +
#   geom_point(aes(x = E_days, y = Sig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
#   #geom_errorbar(aes(x = E_days, ymin = meanSig - sdSig, ymax = meanSig + sdSig)) +
#   scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   # scale_y_continuous(breaks=seq(0, 200, by = 50)) +
#   # coord_cartesian(ylim = c(0, 200)) +
#   #facet_grid(rows = vars(Strain)) +
#   ggh4x::facet_nested(rows = vars(Ex_WL,Par_ue), cols = vars(Photoperiod, O2)) +
#     # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=11),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.24,0.95),
#         legend.key.height= unit(0.003, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         # legend.spacing.x = unit(0.01, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=9))

```


